<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Makarska Dining v2.3.0</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="css/main.css" />
</head>
<body>

    <!-- ==================== LOGIN SCREEN ==================== -->
    <div id="loginScreen" class="auth-screen login-screen">
        <!-- Makarska Beach Banner -->
        <div class="login-banner">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 400" preserveAspectRatio="xMidYMid slice">
                <defs>
                    <linearGradient id="cartoonSky2" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#87CEEB"/>
                        <stop offset="60%" style="stop-color:#B8E8F0"/>
                        <stop offset="100%" style="stop-color:#F0F8E0"/>
                    </linearGradient>
                    <linearGradient id="cartoonSea2" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#40C4AA"/>
                        <stop offset="100%" style="stop-color:#20A088"/>
                    </linearGradient>
                </defs>
                <rect x="0" y="0" width="1200" height="400" fill="url(#cartoonSky2)"/>
                <circle cx="1050" cy="80" r="80" fill="#FFF8E0" opacity="0.5"/>
                <circle cx="1050" cy="80" r="50" fill="#FFFDE8" opacity="0.7"/>
                <g fill="#FFFFFF">
                    <ellipse cx="180" cy="55" rx="60" ry="30"/>
                    <ellipse cx="230" cy="50" rx="45" ry="25"/>
                    <ellipse cx="135" cy="52" rx="38" ry="22"/>
                    <ellipse cx="200" cy="68" rx="32" ry="18"/>
                    <ellipse cx="600" cy="40" rx="70" ry="35"/>
                    <ellipse cx="660" cy="35" rx="50" ry="28"/>
                    <ellipse cx="545" cy="42" rx="42" ry="24"/>
                    <ellipse cx="850" cy="65" rx="55" ry="28"/>
                    <ellipse cx="900" cy="60" rx="40" ry="22"/>
                </g>
                <path d="M0 400 L70 230 C130 200 180 230 250 190 C340 140 400 170 480 130 C580 80 650 110 740 80 C840 50 920 90 1000 100 C1100 110 1150 150 1200 170 L1200 400 Z" fill="#B8A8C8"/>
                <path d="M40 400 L140 270 C210 240 270 270 350 230 C450 180 520 210 620 180 C720 145 790 175 890 160 C990 145 1060 185 1150 205 L1200 230 L1200 400 Z" fill="#8BAA90"/>
                <path d="M180 400 L300 315 C390 290 470 305 560 285 C670 260 750 280 860 275 C970 270 1050 300 1150 325 L1200 345 L1200 400 Z" fill="#5CAD5C"/>
                <g fill="#4A9648">
                    <ellipse cx="380" cy="305" rx="55" ry="28"/>
                    <ellipse cx="540" cy="290" rx="60" ry="30"/>
                    <ellipse cx="720" cy="282" rx="58" ry="28"/>
                    <ellipse cx="920" cy="295" rx="65" ry="32"/>
                    <ellipse cx="1100" cy="320" rx="55" ry="28"/>
                </g>
                <g>
                    <ellipse cx="320" cy="290" rx="24" ry="32" fill="#3D8E3D"/>
                    <rect x="316" y="315" width="8" height="18" fill="#9B7B5A"/>
                    <ellipse cx="460" cy="278" rx="28" ry="35" fill="#4CA84C"/>
                    <rect x="456" y="306" width="8" height="18" fill="#9B7B5A"/>
                    <ellipse cx="640" cy="272" rx="22" ry="30" fill="#3D8E3D"/>
                    <rect x="636" y="295" width="8" height="16" fill="#9B7B5A"/>
                    <ellipse cx="820" cy="278" rx="26" ry="33" fill="#4CA84C"/>
                    <rect x="816" y="304" width="8" height="16" fill="#9B7B5A"/>
                </g>
                <g>
                    <rect x="560" y="268" width="38" height="87" rx="3" fill="#F5E0C8"/>
                    <rect x="608" y="258" width="42" height="97" rx="3" fill="#FFF0D8"/>
                    <rect x="660" y="235" width="50" height="120" rx="4" fill="#FFE878"/>
                    <rect x="666" y="245" width="11" height="14" rx="2" fill="#90D8F0"/>
                    <rect x="682" y="245" width="11" height="14" rx="2" fill="#90D8F0"/>
                    <rect x="698" y="245" width="11" height="14" rx="2" fill="#90D8F0"/>
                    <rect x="666" y="267" width="11" height="14" rx="2" fill="#90D8F0"/>
                    <rect x="682" y="267" width="11" height="14" rx="2" fill="#90D8F0"/>
                    <rect x="698" y="267" width="11" height="14" rx="2" fill="#90D8F0"/>
                    <rect x="666" y="289" width="11" height="14" rx="2" fill="#90D8F0"/>
                    <rect x="682" y="289" width="11" height="14" rx="2" fill="#90D8F0"/>
                    <rect x="698" y="289" width="11" height="14" rx="2" fill="#90D8F0"/>
                    <rect x="666" y="311" width="11" height="14" rx="2" fill="#90D8F0"/>
                    <rect x="682" y="311" width="11" height="14" rx="2" fill="#90D8F0"/>
                    <rect x="698" y="311" width="11" height="14" rx="2" fill="#90D8F0"/>
                    <rect x="720" y="285" width="40" height="70" rx="3" fill="#FFB088"/>
                    <path d="M717 285 L740 250 L763 285 Z" fill="#E86850"/>
                    <rect x="728" y="302" width="12" height="16" rx="2" fill="#90D8F0"/>
                    <rect x="746" y="302" width="12" height="16" rx="2" fill="#90D8F0"/>
                    <rect x="728" y="325" width="24" height="28" rx="2" fill="#7B5B4A"/>
                    <rect x="770" y="292" width="45" height="63" rx="3" fill="#C8E8A8"/>
                    <path d="M767 292 L792 255 L817 292 Z" fill="#88C878"/>
                    <rect x="780" y="308" width="14" height="18" rx="2" fill="#90D8F0"/>
                    <rect x="800" y="308" width="14" height="18" rx="2" fill="#90D8F0"/>
                    <rect x="825" y="285" width="38" height="70" rx="3" fill="#FFE0A0"/>
                    <path d="M822 285 L844 252 L866 285 Z" fill="#FFAA50"/>
                    <rect x="833" y="300" width="12" height="15" rx="2" fill="#90D8F0"/>
                    <rect x="850" y="300" width="12" height="15" rx="2" fill="#90D8F0"/>
                    <rect x="873" y="298" width="42" height="57" rx="3" fill="#A8D8E8"/>
                    <path d="M870 298 L894 265 L918 298 Z" fill="#78B8D0"/>
                    <rect x="883" y="312" width="13" height="16" rx="2" fill="#F0F8FF"/>
                    <rect x="902" y="312" width="13" height="16" rx="2" fill="#F0F8FF"/>
                    <rect x="925" y="292" width="38" height="63" rx="3" fill="#FFD0D8"/>
                    <path d="M922 292 L944 260 L966 292 Z" fill="#F0909A"/>
                    <rect x="973" y="300" width="40" height="55" rx="3" fill="#F5E0C8"/>
                    <rect x="1023" y="295" width="38" height="60" rx="3" fill="#FFF0D8"/>
                    <rect x="1071" y="302" width="42" height="53" rx="3" fill="#D8F0D0"/>
                    <rect x="1123" y="308" width="38" height="47" rx="3" fill="#FFE0A0"/>
                </g>
                <g>
                    <rect x="825" y="335" width="40" height="18" fill="#FFF0D8"/>
                    <path d="M820 335 Q830 342 840 335 Q850 342 860 335 Q870 342 870 335 L870 328 L820 328 Z" fill="#E74C3C"/>
                    <path d="M830 335 Q840 342 850 335" fill="none" stroke="#FFFFFF" stroke-width="3"/>
                </g>
                <path d="M0 355 Q300 345 600 355 Q900 365 1200 355 L1200 400 L0 400 Z" fill="url(#cartoonSea2)"/>
                <g fill="#FFFFFF" opacity="0.5">
                    <ellipse cx="350" cy="362" rx="18" ry="5"/>
                    <ellipse cx="520" cy="370" rx="14" ry="4"/>
                    <ellipse cx="680" cy="365" rx="20" ry="5"/>
                    <ellipse cx="850" cy="372" rx="16" ry="4"/>
                    <ellipse cx="1020" cy="362" rx="18" ry="5"/>
                </g>
                <path d="M0 360 Q200 352 380 365 Q500 378 600 400 L0 400 Z" fill="#F8DDA8"/>
                <path d="M0 375 Q170 368 330 380 Q450 395 530 400 L0 400 Z" fill="#ECCB90"/>
                <g>
                    <rect x="138" y="352" width="5" height="30" fill="#9B7B5A" rx="2"/>
                    <ellipse cx="140" cy="348" rx="30" ry="13" fill="#E74C3C"/>
                    <path d="M110 348 Q125 340 140 348 Q155 340 170 348" fill="#FFFFFF" opacity="0.7"/>
                    <rect x="258" y="360" width="5" height="27" fill="#9B7B5A" rx="2"/>
                    <ellipse cx="260" cy="356" rx="28" ry="12" fill="#20A088"/>
                    <ellipse cx="260" cy="354" rx="18" ry="7" fill="#40C4AA" opacity="0.5"/>
                    <rect x="378" y="372" width="5" height="22" fill="#9B7B5A" rx="2"/>
                    <ellipse cx="380" cy="368" rx="26" ry="11" fill="#FF9040"/>
                    <ellipse cx="380" cy="366" rx="16" ry="6" fill="#FFB070" opacity="0.5"/>
                    <rect x="488" y="382" width="5" height="18" fill="#9B7B5A" rx="2"/>
                    <ellipse cx="490" cy="378" rx="24" ry="10" fill="#F8D850"/>
                </g>
                <rect x="175" y="368" width="28" height="14" rx="3" fill="#9B59B6"/>
                <rect x="295" y="375" width="25" height="12" rx="3" fill="#E74C3C"/>
                <rect x="415" y="385" width="26" height="10" rx="3" fill="#3498DB"/>
                <g>
                    <path d="M60 400 Q68 355 78 310 Q84 280 76 252 L70 248 Q84 242 100 248 L94 252 Q86 280 92 310 Q102 355 110 400 Z" fill="#9B7B5A"/>
                    <path d="M84 268 Q160 210 300 185 Q345 178 375 192 Q330 188 275 202 Q175 230 90 280 Z" fill="#9B7B5A"/>
                    <ellipse cx="320" cy="135" rx="70" ry="55" fill="#3D8E3D"/>
                    <ellipse cx="255" cy="168" rx="58" ry="45" fill="#4CA84C"/>
                    <ellipse cx="385" cy="158" rx="52" ry="42" fill="#3D8E3D"/>
                    <ellipse cx="190" cy="195" rx="50" ry="40" fill="#4CA84C"/>
                    <ellipse cx="125" cy="222" rx="55" ry="44" fill="#3D8E3D"/>
                    <ellipse cx="68" cy="252" rx="48" ry="38" fill="#4CA84C"/>
                    <ellipse cx="435" cy="185" rx="42" ry="35" fill="#3D8E3D"/>
                    <ellipse cx="300" cy="125" rx="22" ry="16" fill="#6BC86B" opacity="0.6"/>
                    <ellipse cx="240" cy="160" rx="18" ry="14" fill="#6BC86B" opacity="0.6"/>
                    <ellipse cx="115" cy="212" rx="20" ry="15" fill="#6BC86B" opacity="0.6"/>
                    <ellipse cx="370" cy="148" rx="16" ry="12" fill="#6BC86B" opacity="0.6"/>
                </g>
                <g>
                    <ellipse cx="620" cy="360" rx="24" ry="7" fill="#FFFFFF"/>
                    <polygon points="620,358 620,318 642,350" fill="#FFFFFF"/>
                    <polygon points="618,358 618,330 602,352" fill="#F8F8F8"/>
                    <line x1="620" y1="358" x2="620" y2="315" stroke="#9B7B5A" stroke-width="2"/>
                    <ellipse cx="780" cy="368" rx="22" ry="6" fill="#FFFFFF"/>
                    <polygon points="780,366 780,330 800,358" fill="#FFE0A0"/>
                    <line x1="780" y1="366" x2="780" y2="328" stroke="#9B7B5A" stroke-width="2"/>
                    <ellipse cx="950" cy="360" rx="20" ry="6" fill="#FFFFFF"/>
                    <polygon points="950,358 950,325 968,352" fill="#A8D8E8"/>
                    <line x1="950" y1="358" x2="950" y2="322" stroke="#9B7B5A" stroke-width="2"/>
                </g>
                <ellipse cx="500" cy="362" rx="14" ry="5" fill="#E74C3C" opacity="0.8"/>
                <ellipse cx="700" cy="370" rx="12" ry="4" fill="#F8D850" opacity="0.8"/>
            </svg>
        </div>
        <div class="login-header">
            <div class="login-title">Makarska Dining</div>
            <div class="login-subtitle">Rate restaurants with friends</div>
        </div>
        <div class="login-buttons">
            <div id="loginFormContainer">
                <div class="login-form-group">
                    <input type="text" id="loginUsername" class="login-input" placeholder="Username" autocomplete="username">
                </div>
                <div class="login-form-group">
                    <input type="password" id="loginPassword" class="login-input" placeholder="Password" autocomplete="current-password">
                </div>
                <div id="loginError" class="login-error"></div>
                <button class="login-btn login-btn-primary" onclick="handleEmailLogin()">
                    Sign In
                </button>
                <div class="login-divider">or</div>
                <button class="login-btn login-btn-secondary" onclick="showRegisterForm()">
                    Create Account
                </button>
            </div>
            <div id="registerFormContainer" style="display: none;">
                <div class="login-form-group">
                    <input type="text" id="registerUsername" class="login-input" placeholder="Username" autocomplete="username">
                </div>
                <div class="login-form-group">
                    <input type="password" id="registerPassword" class="login-input" placeholder="Password" autocomplete="new-password">
                </div>
                <div class="login-form-group">
                    <input type="password" id="registerPasswordConfirm" class="login-input" placeholder="Confirm Password" autocomplete="new-password">
                </div>
                <div id="registerError" class="login-error"></div>
                <button class="login-btn login-btn-primary" onclick="handleRegister()">
                    Create Account
                </button>
                <div class="login-divider">or</div>
                <button class="login-btn login-btn-secondary" onclick="showLoginForm()">
                    Back to Sign In
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== EMPTY STATE SCREEN ==================== -->
    <div id="emptyStateScreen" class="auth-screen empty-state-screen hidden">
        <div class="empty-header">
            <div class="empty-header-top">
                <div class="empty-title">My Groups</div>
                <button class="logout-btn" onclick="handleLogout()" title="Sign Out">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                </button>
            </div>
            <div class="empty-subtitle">No groups yet</div>
        </div>
        <div class="empty-content">
            <div class="empty-icon">üë•</div>
            <div class="empty-content-title">No Groups Yet</div>
            <div class="empty-content-text">Create a group to start rating<br>restaurants with friends</div>
            <button class="empty-btn-primary" onclick="showCreateGroup()">+ Create Group</button>
            <button class="empty-btn-secondary" onclick="showJoinGroup()">Join with Code</button>
        </div>
        <div class="empty-bottom-nav">
            <button class="empty-nav-item active">
                <div class="empty-nav-icon">üë•</div>
                <div class="empty-nav-label">Groups</div>
            </button>
            <button class="empty-nav-item">
                <div class="empty-nav-icon">üó∫Ô∏è</div>
                <div class="empty-nav-label">Explore</div>
            </button>
            <button class="empty-nav-item">
                <div class="empty-nav-icon">üë§</div>
                <div class="empty-nav-label">Profile</div>
            </button>
        </div>
    </div>

    <!-- ==================== CREATE GROUP SCREEN ==================== -->
    <div id="createGroupScreen" class="form-screen">
        <div class="form-header">
            <button class="form-back-btn" onclick="goBackFromCreate()">‚Üê</button>
            <div class="form-title">Create Group</div>
        </div>
        <div class="form-content">
            <div class="form-group">
                <label class="form-label">Group Name</label>
                <input type="text" class="form-input" id="groupNameInput" placeholder="e.g. Summer Trip 2025">
            </div>
            <div class="form-group">
                <label class="form-label">Group Photo</label>
                <div id="photoPreviewContainer" style="display: none; margin-bottom: 12px;">
                    <div style="position: relative; display: inline-block;">
                        <img id="photoPreview" style="width: 100px; height: 100px; border-radius: 16px; object-fit: cover; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        <button onclick="removePhoto()" style="position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; border-radius: 50%; background: #ff6b6b; color: white; border: none; font-size: 14px; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.2);">√ó</button>
                    </div>
                </div>
                <div class="photo-picker" id="photoPicker">
                    <div class="photo-option" onclick="pickPhoto()">
                        <div class="photo-option-icon">üñºÔ∏è</div>
                        <div class="photo-option-text">Choose Photo</div>
                    </div>
                    <div class="photo-option" onclick="takePhoto()">
                        <div class="photo-option-icon">üì∑</div>
                        <div class="photo-option-text">Take Picture</div>
                    </div>
                </div>
                <input type="file" id="photoInput" accept="image/*" style="display: none;" onchange="handlePhotoSelect(event)">
                <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;" onchange="handlePhotoSelect(event)">
            </div>
            <div class="form-group">
                <label class="form-label">Description (optional)</label>
                <input type="text" class="form-input" id="groupDescInput" placeholder="What's this group for?">
            </div>
            <button class="form-submit-btn" onclick="createGroup()">Create Group</button>
        </div>
    </div>

    <!-- ==================== JOIN GROUP SCREEN ==================== -->
    <div id="joinGroupScreen" class="form-screen">
        <div class="form-header">
            <button class="form-back-btn" onclick="goBackFromJoin()">‚Üê</button>
            <div class="form-title">Join Group</div>
        </div>
        <div class="form-content">
            <div class="form-group">
                <label class="form-label">Enter Invite Code</label>
                <input type="text" class="form-input form-input-code" id="inviteCodeInput" placeholder="ABC123" maxlength="6" oninput="this.value = this.value.toUpperCase()">
            </div>
            <div class="form-hint">
                Ask your friend for the 6-digit<br>group invite code
            </div>
            <button class="form-submit-btn" onclick="joinGroup()">Join Group</button>
        </div>
    </div>

    <!-- ==================== GROUPS LIST SCREEN ==================== -->
    <div id="groupsListScreen" class="groups-list-screen">
        <div class="groups-header">
            <div class="groups-header-top">
                <div class="groups-title">My Groups</div>
                <button class="logout-btn" onclick="handleLogout()" title="Sign Out">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                </button>
            </div>
            <div class="groups-subtitle" id="groupsSubtitle">All your groups</div>
        </div>
        <div class="groups-list-content" id="groupsListContent">
            <!-- Groups will be rendered dynamically -->
        </div>
        <div class="bottom-nav">
            <!-- Home -->
            <button class="bottom-nav-item active">
                <div class="bottom-nav-icon">
                    <svg viewBox="0 0 24 24">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9 22 9 12 15 12 15 22"/>
                    </svg>
                </div>
                <span class="bottom-nav-label">Home</span>
            </button>
            <!-- Restaurants - Storefront -->
            <button class="bottom-nav-item">
                <div class="bottom-nav-icon">
                    <svg viewBox="0 0 24 24">
                        <path d="M3 9V21H21V9"/>
                        <path d="M21 9L19 3H5L3 9"/>
                        <path d="M3 9C3 9 3 11 5.5 11C8 11 8 9 8 9"/>
                        <path d="M8 9C8 9 8 11 10.5 11C13 11 13 9 13 9"/>
                        <path d="M13 9C13 9 13 11 15.5 11C18 11 18 9 18 9"/>
                        <path d="M18 9C18 9 18 11 20.5 11C21 11 21 10.5 21 9"/>
                        <rect x="9" y="14" width="6" height="7"/>
                    </svg>
                </div>
                <span class="bottom-nav-label">Places</span>
            </button>
            <!-- Center Add Button -->
            <button class="bottom-nav-item center-btn" onclick="showCreateGroup()">
                <div class="bottom-nav-icon">
                    <svg viewBox="0 0 24 24">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                </div>
            </button>
            <!-- Food Items - Pizza Slice -->
            <button class="bottom-nav-item">
                <div class="bottom-nav-icon">
                    <svg viewBox="0 0 24 24">
                        <g transform="rotate(40 12 12)">
                            <path d="M4.5 6C6.5 3 9 2 12 2s5.5 1 7.5 4L12 22 4.5 6z"/>
                            <path d="M6 7.5c1.5-1.5 3.5-2.5 6-2.5s4.5 1 6 2.5"/>
                            <circle cx="9" cy="9.5" r="1.8" class="filled"/>
                            <circle cx="14" cy="8.5" r="1.4" class="filled"/>
                            <circle cx="11" cy="13.5" r="1.2" class="filled"/>
                        </g>
                    </svg>
                </div>
                <span class="bottom-nav-label">Food</span>
            </button>
            <!-- Menu -->
            <button class="bottom-nav-item">
                <div class="bottom-nav-icon">
                    <svg viewBox="0 0 24 24">
                        <line x1="3" y1="6" x2="21" y2="6"/>
                        <line x1="3" y1="12" x2="21" y2="12"/>
                        <line x1="3" y1="18" x2="21" y2="18"/>
                    </svg>
                </div>
                <span class="bottom-nav-label">Menu</span>
            </button>
        </div>
    </div>

    <!-- ==================== MAIN APP ==================== -->
    <div id="mainApp" class="main-app">
    <div class="header">
        <div class="header-top">
            <div class="header-search">
                <input type="text" id="searchInput" placeholder="üîç Search restaurants, cuisine, or notes..." autocomplete="off">
                <div class="search-dropdown" id="searchDropdown"></div>
            </div>
            <button class="menu-btn" onclick="openFilterModal()">
                <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                    <line x1="4" y1="6" x2="20" y2="6"/>
                    <line x1="4" y1="12" x2="20" y2="12"/>
                    <line x1="4" y1="18" x2="20" y2="18"/>
                    <circle cx="8" cy="6" r="2" fill="currentColor"/>
                    <circle cx="16" cy="12" r="2" fill="currentColor"/>
                    <circle cx="10" cy="18" r="2" fill="currentColor"/>
                </svg>
            </button>
        </div>
    </div>

    <div class="filter-modal" id="filterModal">
        <div class="filter-modal-content">
            <div class="filter-modal-header">
                <h2 class="filter-modal-title">Filter</h2>
                <button class="filter-reset-btn" onclick="resetFilters()">Reset</button>
            </div>

            <div class="filter-section">
                <h3 class="filter-section-title">Main Category</h3>
                <div class="filter-main-categories" id="filterMainCategories">
                    <button class="filter-category-btn active" data-category="all" onclick="selectFilterMainCategory('all')">üçΩÔ∏è All</button>
                    <button class="filter-category-btn" data-category="restaurant" onclick="selectFilterMainCategory('restaurant')">üç¥ Restaurant</button>
                    <button class="filter-category-btn" data-category="dessert" onclick="selectFilterMainCategory('dessert')">üç∞ Dessert</button>
                    <button class="filter-category-btn" data-category="icecream" onclick="selectFilterMainCategory('icecream')">üç¶ Ice Cream</button>
                    <button class="filter-category-btn" data-category="drinks" onclick="selectFilterMainCategory('drinks')">üçπ Drinks</button>
                </div>
            </div>

            <div class="filter-section" id="filterSubcategorySection" style="display: none;">
                <h3 class="filter-section-title">Subcategory</h3>
                <div class="filter-subcategories" id="filterSubcategories">
                    <!-- Subcategories will be populated dynamically -->
                </div>
            </div>

            <div class="filter-section">
                <h3 class="filter-section-title">Rating</h3>
                <div class="filter-rating-chips">
                    <button class="rating-chip" onclick="toggleRating(this, 1)">1‚≠ê</button>
                    <button class="rating-chip" onclick="toggleRating(this, 2)">2‚≠ê</button>
                    <button class="rating-chip" onclick="toggleRating(this, 3)">3‚≠ê</button>
                    <button class="rating-chip" onclick="toggleRating(this, 4)">4‚≠ê</button>
                    <button class="rating-chip" onclick="toggleRating(this, 5)">5‚≠ê</button>
                </div>
            </div>

            <div class="filter-section">
                <h3 class="filter-section-title" id="filterPriceTitle">Price</h3>
                <div class="price-slider-container" id="filterPriceChips">
                    <button class="price-chip" onclick="togglePrice(this, 1)">‚Ç¨ <small>Under ‚Ç¨15</small></button>
                    <button class="price-chip" onclick="togglePrice(this, 2)">‚Ç¨‚Ç¨ <small>‚Ç¨15-30</small></button>
                    <button class="price-chip" onclick="togglePrice(this, 3)">‚Ç¨‚Ç¨‚Ç¨ <small>‚Ç¨30-60</small></button>
                    <button class="price-chip" onclick="togglePrice(this, 4)">‚Ç¨‚Ç¨‚Ç¨‚Ç¨ <small>‚Ç¨60+</small></button>
                </div>
            </div>

            <div id="filterResultCount" style="text-align: center; color: #636e72; font-size: 14px; margin-top: 16px;">
                Showing all restaurants
            </div>
            <button class="filter-show-results-btn" onclick="applyFilters()">Show results</button>
        </div>
    </div>

    <button class="demo-btn" id="demoPinBtn" onclick="openDemoMenu()">üé® Pin Styles</button>
    <!-- Old floating add button - now in bottom nav -->

    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
    
    <div class="sidebar" id="sidebar">
        <div id="restaurantsSidebarView">
            <div class="sidebar-header">
                <h2>Browse</h2>
                <button class="sidebar-close" onclick="toggleSidebar()">√ó</button>
            </div>
            
            <div class="profile-section">
                <div class="profile-avatar">üë§</div>
                <div class="profile-name">Food Explorer</div>
                <div class="profile-location">Makarska, Croatia</div>
                <div class="profile-tabs">
                    <button class="profile-tab" id="menuTab" onclick="switchTab('menu')">Menu Items</button>
                    <button class="profile-tab active" id="restaurantTab" onclick="switchTab('restaurant')">Restaurants</button>
                </div>
            </div>

            <div class="sidebar-content">
                <div id="menuReviewsSection" style="display: none;">
                    <div class="sidebar-section">
                        <h3>üçï Menu Items Reviews</h3>
                        <div class="review-cards" id="menuReviewCards"></div>
                    </div>
                </div>

                <div id="restaurantReviewsSection">
                    <div class="sidebar-section">
                        <h3>üçΩÔ∏è All Restaurants (<span id="restaurantCount">0</span>)</h3>
                        <ul class="sidebar-list" id="restaurantList"></ul>
                    </div>
                    <div class="sidebar-section">
                        <h3>ü•ò Cuisines</h3>
                        <ul class="sidebar-list" id="cuisineList"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <div id="restaurantsListView" class="restaurants-list-view" style="display: none;">
        <div class="dishes-header">
            <div class="dishes-title-row">
                <h2 class="dishes-title">Restaurants</h2>
            </div>

            <div class="dishes-search-container">
                <input type="text" class="dishes-search-input" id="restaurantsSearchInput" placeholder="Search restaurants..." oninput="filterRestaurantsList()">
            </div>

            <div class="dish-filters" id="restaurantCategoryFilters">
                <button class="dish-filter-btn active" data-category="all" onclick="selectRestaurantCategory('all')">üçΩÔ∏è All</button>
                <button class="dish-filter-btn" data-category="restaurant" onclick="selectRestaurantCategory('restaurant')">üç¥ Restaurant</button>
                <button class="dish-filter-btn" data-category="dessert" onclick="selectRestaurantCategory('dessert')">üç∞ Dessert</button>
                <button class="dish-filter-btn" data-category="icecream" onclick="selectRestaurantCategory('icecream')">üç¶ Ice Cream</button>
                <button class="dish-filter-btn" data-category="drinks" onclick="selectRestaurantCategory('drinks')">üçπ Drinks</button>
            </div>
        </div>
        <div id="restaurantsListContainer"></div>
    </div>

    <div id="topDishesView" class="restaurants-list-view" style="display: none;">
        <div class="dishes-header">
            <div class="dishes-title-row">
                <h2 class="dishes-title">Top Rated Dishes</h2>
            </div>

            <div class="dishes-search-container">
                <input type="text" class="dishes-search-input" id="foodSearchInput" placeholder="Search food items..." oninput="filterFoodList()">
            </div>

            <div class="dish-filters" id="mainCategoryFilters">
                <button class="dish-filter-btn active" data-category="all" onclick="selectMainCategory('all')">üçΩÔ∏è All</button>
                <button class="dish-filter-btn" data-category="restaurant" onclick="selectMainCategory('restaurant')">üç¥ Restaurant</button>
                <button class="dish-filter-btn" data-category="dessert" onclick="selectMainCategory('dessert')">üç∞ Dessert</button>
                <button class="dish-filter-btn" data-category="icecream" onclick="selectMainCategory('icecream')">üç¶ Ice Cream</button>
                <button class="dish-filter-btn" data-category="drinks" onclick="selectMainCategory('drinks')">üçπ Drinks</button>
            </div>
            <div class="dish-subcategories" id="subcategoryFilters" style="display: none;">
                <!-- Subcategories will be populated dynamically -->
            </div>
        </div>

        <div class="dishes-list" id="dishesList"></div>
    </div>

    <div class="bottom-nav">
        <!-- Home -->
        <button class="bottom-nav-item active" id="bottomNavHome" onclick="switchBottomNav('home')">
            <div class="bottom-nav-icon">
                <svg viewBox="0 0 24 24">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    <polyline points="9 22 9 12 15 12 15 22"/>
                </svg>
            </div>
            <span class="bottom-nav-label">Home</span>
        </button>
        <!-- Restaurants - Storefront -->
        <button class="bottom-nav-item" id="bottomNavRestaurants" onclick="switchBottomNav('restaurants')">
            <div class="bottom-nav-icon">
                <svg viewBox="0 0 24 24">
                    <path d="M3 9V21H21V9"/>
                    <path d="M21 9L19 3H5L3 9"/>
                    <path d="M3 9C3 9 3 11 5.5 11C8 11 8 9 8 9"/>
                    <path d="M8 9C8 9 8 11 10.5 11C13 11 13 9 13 9"/>
                    <path d="M13 9C13 9 13 11 15.5 11C18 11 18 9 18 9"/>
                    <path d="M18 9C18 9 18 11 20.5 11C21 11 21 10.5 21 9"/>
                    <rect x="9" y="14" width="6" height="7"/>
                </svg>
            </div>
            <span class="bottom-nav-label">Places</span>
        </button>
        <!-- Center Add Button -->
        <button class="bottom-nav-item center-btn" onclick="openAddModal()">
            <div class="bottom-nav-icon">
                <svg viewBox="0 0 24 24">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
            </div>
        </button>
        <!-- Food Items - Pizza Slice -->
        <button class="bottom-nav-item" id="bottomNavFood" onclick="switchBottomNav('food')">
            <div class="bottom-nav-icon">
                <svg viewBox="0 0 24 24">
                    <g transform="rotate(40 12 12)">
                        <path d="M4.5 6C6.5 3 9 2 12 2s5.5 1 7.5 4L12 22 4.5 6z"/>
                        <path d="M6 7.5c1.5-1.5 3.5-2.5 6-2.5s4.5 1 6 2.5"/>
                        <circle cx="9" cy="9.5" r="1.8" class="filled"/>
                        <circle cx="14" cy="8.5" r="1.4" class="filled"/>
                        <circle cx="11" cy="13.5" r="1.2" class="filled"/>
                    </g>
                </svg>
            </div>
            <span class="bottom-nav-label">Food</span>
        </button>
        <!-- Menu -->
        <button class="bottom-nav-item" id="bottomNavSettings" onclick="switchBottomNav('settings')">
            <div class="bottom-nav-icon">
                <svg viewBox="0 0 24 24">
                    <line x1="3" y1="6" x2="21" y2="6"/>
                    <line x1="3" y1="12" x2="21" y2="12"/>
                    <line x1="3" y1="18" x2="21" y2="18"/>
                </svg>
            </div>
            <span class="bottom-nav-label">Menu</span>
        </button>
    </div>

    <!-- Settings View - Main Menu -->
    <div id="settingsView" class="restaurants-list-view" style="display: none;">
        <div class="restaurants-integrated-header">
            <div class="restaurants-header-top">
                <div class="restaurants-header-title">
                    <span class="restaurants-header-icon">‚öôÔ∏è</span>
                    <span class="restaurants-header-name">Settings</span>
                </div>
            </div>
        </div>
        
        <div class="settings-content">
            <!-- Group Section -->
            <div class="settings-section-label">Group</div>
            <div class="settings-section">
                <div class="settings-menu-item" onclick="showSettingsPage('groupmembers')">
                    <div class="settings-menu-icon">üë•</div>
                    <div class="settings-menu-info">
                        <div class="settings-menu-title">Group Members</div>
                        <div class="settings-menu-desc">View & manage members</div>
                    </div>
                    <div class="settings-menu-arrow">‚Ä∫</div>
                </div>
                <div class="settings-menu-item" onclick="showGroupsList()">
                    <div class="settings-menu-icon">üìã</div>
                    <div class="settings-menu-info">
                        <div class="settings-menu-title">My Groups</div>
                        <div class="settings-menu-desc">Switch to another group</div>
                    </div>
                    <div class="settings-menu-arrow">‚Ä∫</div>
                </div>
            </div>

            <!-- App Configuration Section -->
            <div class="settings-section-label">App Configuration</div>
            <div class="settings-section">
                <div class="settings-menu-item" onclick="showSettingsPage('categories')">
                    <div class="settings-menu-icon">üìÅ</div>
                    <div class="settings-menu-info">
                        <div class="settings-menu-title">Categories</div>
                        <div class="settings-menu-desc">Manage restaurant categories</div>
                    </div>
                    <div class="settings-menu-arrow">‚Ä∫</div>
                </div>
                <div class="settings-menu-item" onclick="showSettingsPage('subcategories')">
                    <div class="settings-menu-icon">üìÇ</div>
                    <div class="settings-menu-info">
                        <div class="settings-menu-title">Subcategories</div>
                        <div class="settings-menu-desc">Manage food subcategories</div>
                    </div>
                    <div class="settings-menu-arrow">‚Ä∫</div>
                </div>
                <div class="settings-menu-item" onclick="showSettingsPage('priceranges')">
                    <div class="settings-menu-icon">üí∞</div>
                    <div class="settings-menu-info">
                        <div class="settings-menu-title">Price Ranges</div>
                        <div class="settings-menu-desc">Customize price filters</div>
                    </div>
                    <div class="settings-menu-arrow">‚Ä∫</div>
                </div>
            </div>
            
            <!-- Pin Location Help -->
            <div style="background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; padding: 16px; border-radius: 12px; margin-top: 8px;">
                <p style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">üìç Justera pin-positioner</p>
                <p style="font-size: 13px; line-height: 1.5; opacity: 0.95;">
                    <strong>S√• h√§r flyttar du en pin:</strong><br>
                    1. Klicka p√• en restaurang i listan<br>
                    2. Klicka p√• <strong>"üìç Flytta pin"</strong><br>
                    3. Klicka p√• r√§tt plats p√• kartan<br>
                    4. Klart! ‚úÖ
                </p>
            </div>
        </div>
    </div>

    <!-- Settings Sub-Page: Group Members -->
    <div id="settingsGroupMembersView" class="restaurants-list-view" style="display: none;">
        <div class="restaurants-integrated-header">
            <div class="restaurants-header-top">
                <div class="restaurants-header-title">
                    <button class="settings-back-btn" onclick="hideSettingsPage('groupmembers')">‚Üê</button>
                    <span class="restaurants-header-icon">üë•</span>
                    <span class="restaurants-header-name">Group Members</span>
                </div>
                <button class="settings-add-btn" onclick="showSettingsPage('invitemembers')">+ Add</button>
            </div>
        </div>
        <div class="settings-content">
            <div class="settings-group-header">
                <div class="settings-group-name" id="currentGroupName">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Trip 2025</div>
                <div class="settings-group-meta" id="currentGroupMeta">5 members</div>
            </div>
            <div id="groupMembersList" class="settings-list">
                <!-- Members will be rendered dynamically -->
            </div>
        </div>
    </div>

    <!-- Settings Sub-Page: Invite Members -->
    <div id="settingsInviteMembersView" class="restaurants-list-view" style="display: none;">
        <div class="restaurants-integrated-header">
            <div class="restaurants-header-top">
                <div class="restaurants-header-title">
                    <button class="settings-back-btn" onclick="showSettingsPage('groupmembers')">‚Üê</button>
                    <span class="restaurants-header-icon">‚úâÔ∏è</span>
                    <span class="restaurants-header-name">Invite Members</span>
                </div>
            </div>
        </div>
        <div class="settings-content">
            <div class="invite-code-box">
                <div class="invite-emoji">üéâ</div>
                <div class="invite-label">Share this code with friends</div>
                <div class="invite-code" id="inviteCodeDisplay">------</div>
                <button class="invite-copy-btn" onclick="copyCurrentGroupCode()">üìã Copy Code</button>
            </div>
            <div class="invite-share-section">
                <div class="invite-share-label">or share via</div>
                <div class="invite-share-buttons">
                    <button class="share-btn share-whatsapp" onclick="shareViaWhatsApp()">üí¨</button>
                    <button class="share-btn share-email" onclick="shareViaEmail()">‚úâÔ∏è</button>
                    <button class="share-btn share-link" onclick="shareViaLink()">üîó</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Sub-Page: Categories -->
    <div id="settingsCategoriesView" class="restaurants-list-view" style="display: none;">
        <div class="restaurants-integrated-header">
            <div class="restaurants-header-top">
                <div class="restaurants-header-title">
                    <button class="settings-back-btn" onclick="hideSettingsPage('categories')">‚Üê</button>
                    <span class="restaurants-header-icon">üìÅ</span>
                    <span class="restaurants-header-name">Categories</span>
                </div>
                <button class="settings-add-btn" onclick="openAddCategoryModal()">+ Add</button>
            </div>
        </div>
        <div class="settings-content">
            <div id="categoriesList" class="settings-list"></div>
        </div>
    </div>

    <!-- Settings Sub-Page: Subcategories -->
    <div id="settingsSubcategoriesView" class="restaurants-list-view" style="display: none;">
        <div class="restaurants-integrated-header">
            <div class="restaurants-header-top">
                <div class="restaurants-header-title">
                    <button class="settings-back-btn" onclick="hideSettingsPage('subcategories')">‚Üê</button>
                    <span class="restaurants-header-icon">üìÇ</span>
                    <span class="restaurants-header-name">Subcategories</span>
                </div>
                <button class="settings-add-btn" onclick="openAddSubcategoryModal()">+ Add</button>
            </div>
        </div>
        <div class="settings-content">
            <div id="subcategoriesList" class="settings-list"></div>
        </div>
    </div>

    <!-- Settings Sub-Page: Price Ranges -->
    <div id="settingsPriceRangesView" class="restaurants-list-view" style="display: none;">
        <div class="restaurants-integrated-header">
            <div class="restaurants-header-top">
                <div class="restaurants-header-title">
                    <button class="settings-back-btn" onclick="hideSettingsPage('priceranges')">‚Üê</button>
                    <span class="restaurants-header-icon">üí∞</span>
                    <span class="restaurants-header-name">Price Ranges</span>
                </div>
                <button class="settings-add-btn" onclick="openAddPriceRangeModal()">+ Add</button>
            </div>
        </div>
        <div class="settings-content">
            <div id="priceRangesList" class="settings-list"></div>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div id="addCategoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Category</h2>
                <button class="close-btn" onclick="closeAddCategoryModal()">√ó</button>
            </div>
            <form id="categoryForm">
                <div class="form-group">
                    <label>Category Name</label>
                    <input type="text" id="categoryName" placeholder="e.g., Bakery">
                </div>
                <div class="form-group">
                    <label>Emoji Icon</label>
                    <div class="emoji-input-wrapper">
                        <input type="text" id="categoryEmoji" placeholder="Tap to select">
                        <div class="emoji-picker" id="categoryEmojiPicker">
                            <span onclick="selectEmoji('categoryEmoji', 'üç¥')">üç¥</span>
                            <span onclick="selectEmoji('categoryEmoji', 'üçï')">üçï</span>
                            <span onclick="selectEmoji('categoryEmoji', 'üçî')">üçî</span>
                            <span onclick="selectEmoji('categoryEmoji', 'üåÆ')">üåÆ</span>
                            <span onclick="selectEmoji('categoryEmoji', 'üçú')">üçú</span>
                            <span onclick="selectEmoji('categoryEmoji', 'üç£')">üç£</span>
                            <span onclick="selectEmoji('categoryEmoji', 'ü•ê')">ü•ê</span>
                            <span onclick="selectEmoji('categoryEmoji', 'ü•ó')">ü•ó</span>
                            <span onclick="selectEmoji('categoryEmoji', 'ü•©')">ü•©</span>
                            <span onclick="selectEmoji('categoryEmoji', 'üêü')">üêü</span>
                            <span onclick="selectEmoji('categoryEmoji', 'ü¶ê')">ü¶ê</span>
                            <span onclick="selectEmoji('categoryEmoji', 'üçù')">üçù</span>
                            <span onclick="selectEmoji('categoryEmoji', 'üç∞')">üç∞</span>
                            <span onclick="selectEmoji('categoryEmoji', 'üç¶')">üç¶</span>
                            <span onclick="selectEmoji('categoryEmoji', 'üç©')">üç©</span>
                            <span onclick="selectEmoji('categoryEmoji', 'üßÅ')">üßÅ</span>
                            <span onclick="selectEmoji('categoryEmoji', 'üç™')">üç™</span>
                            <span onclick="selectEmoji('categoryEmoji', '‚òï')">‚òï</span>
                            <span onclick="selectEmoji('categoryEmoji', 'üçπ')">üçπ</span>
                            <span onclick="selectEmoji('categoryEmoji', 'üç∑')">üç∑</span>
                            <span onclick="selectEmoji('categoryEmoji', 'üç∫')">üç∫</span>
                            <span onclick="selectEmoji('categoryEmoji', 'ü•§')">ü•§</span>
                            <span onclick="selectEmoji('categoryEmoji', 'üßÉ')">üßÉ</span>
                            <span onclick="selectEmoji('categoryEmoji', 'üè™')">üè™</span>
                        </div>
                    </div>
                </div>
                <button type="button" class="submit-btn" onclick="saveCategory()">Save Category</button>
            </form>
        </div>
    </div>

    <!-- Add Subcategory Modal -->
    <div id="addSubcategoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Subcategory</h2>
                <button class="close-btn" onclick="closeAddSubcategoryModal()">√ó</button>
            </div>
            <form id="subcategoryForm">
                <div class="form-group">
                    <label>Parent Category</label>
                    <select id="parentCategory">
                        <option value="">Select category...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Subcategory Name</label>
                    <input type="text" id="subcategoryName" placeholder="e.g., Croissants">
                </div>
                <div class="form-group">
                    <label>Emoji Icon</label>
                    <div class="emoji-input-wrapper">
                        <input type="text" id="subcategoryEmoji" placeholder="Tap to select">
                        <div class="emoji-picker" id="subcategoryEmojiPicker">
                            <span onclick="selectEmoji('subcategoryEmoji', 'üç¥')">üç¥</span>
                            <span onclick="selectEmoji('subcategoryEmoji', 'üçï')">üçï</span>
                            <span onclick="selectEmoji('subcategoryEmoji', 'üçî')">üçî</span>
                            <span onclick="selectEmoji('subcategoryEmoji', 'üåÆ')">üåÆ</span>
                            <span onclick="selectEmoji('subcategoryEmoji', 'üçú')">üçú</span>
                            <span onclick="selectEmoji('subcategoryEmoji', 'üç£')">üç£</span>
                            <span onclick="selectEmoji('subcategoryEmoji', 'ü•ê')">ü•ê</span>
                            <span onclick="selectEmoji('subcategoryEmoji', 'ü•ó')">ü•ó</span>
                            <span onclick="selectEmoji('subcategoryEmoji', 'ü•©')">ü•©</span>
                            <span onclick="selectEmoji('subcategoryEmoji', 'üêü')">üêü</span>
                            <span onclick="selectEmoji('subcategoryEmoji', 'ü¶ê')">ü¶ê</span>
                            <span onclick="selectEmoji('subcategoryEmoji', 'üçù')">üçù</span>
                            <span onclick="selectEmoji('subcategoryEmoji', 'üç∞')">üç∞</span>
                            <span onclick="selectEmoji('subcategoryEmoji', 'üç¶')">üç¶</span>
                            <span onclick="selectEmoji('subcategoryEmoji', 'üç©')">üç©</span>
                            <span onclick="selectEmoji('subcategoryEmoji', 'üßÅ')">üßÅ</span>
                            <span onclick="selectEmoji('subcategoryEmoji', 'üç™')">üç™</span>
                            <span onclick="selectEmoji('subcategoryEmoji', '‚òï')">‚òï</span>
                            <span onclick="selectEmoji('subcategoryEmoji', 'üçπ')">üçπ</span>
                            <span onclick="selectEmoji('subcategoryEmoji', 'üç∑')">üç∑</span>
                            <span onclick="selectEmoji('subcategoryEmoji', 'üç∫')">üç∫</span>
                            <span onclick="selectEmoji('subcategoryEmoji', 'ü•§')">ü•§</span>
                            <span onclick="selectEmoji('subcategoryEmoji', 'üßÉ')">üßÉ</span>
                            <span onclick="selectEmoji('subcategoryEmoji', 'üè™')">üè™</span>
                        </div>
                    </div>
                </div>
                <button type="button" class="submit-btn" onclick="saveSubcategory()">Save Subcategory</button>
            </form>
        </div>
    </div>

    <!-- Add Price Range Modal -->
    <div id="addPriceRangeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Price Range</h2>
                <button class="close-btn" onclick="closeAddPriceRangeModal()">√ó</button>
            </div>
            <form id="priceRangeForm" onsubmit="savePriceRange(event)">
                <div class="form-group">
                    <label>Apply To</label>
                    <select id="priceRangeTarget" required onchange="updatePriceRangeTargetOptions()">
                        <option value="">Select...</option>
                        <option value="category">Category</option>
                        <option value="subcategory">Subcategory</option>
                    </select>
                </div>
                <div class="form-group" id="priceRangeCategoryGroup" style="display: none;">
                    <label>Category</label>
                    <select id="priceRangeCategory">
                        <option value="">Select category...</option>
                    </select>
                </div>
                <div class="form-group" id="priceRangeSubcategoryGroup" style="display: none;">
                    <label>Subcategory</label>
                    <select id="priceRangeSubcategory">
                        <option value="">Select subcategory...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Price Level (1-4)</label>
                    <select id="priceRangeLevel" required>
                        <option value="1">‚Ç¨ (Level 1)</option>
                        <option value="2">‚Ç¨‚Ç¨ (Level 2)</option>
                        <option value="3">‚Ç¨‚Ç¨‚Ç¨ (Level 3)</option>
                        <option value="4">‚Ç¨‚Ç¨‚Ç¨‚Ç¨ (Level 4)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Label</label>
                    <input type="text" id="priceRangeLabel" placeholder="e.g., ‚Ç¨" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="priceRangeDesc" placeholder="e.g., Under ‚Ç¨5" required>
                </div>
                <button type="submit" class="submit-btn">Save Price Range</button>
            </form>
        </div>
    </div>

    <div id="addChoiceModal" class="modal">
        <div class="modal-content" style="padding-bottom: 30px;">
            <div class="modal-header">
                <h2>What would you like to add?</h2>
                <button class="close-btn" onclick="closeAddChoiceModal()">√ó</button>
            </div>
            <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 10px;">
                <button class="add-choice-btn" onclick="openAddRestaurantModal()">
                    <span class="add-choice-icon">üè™</span>
                    <div class="add-choice-text">
                        <div class="add-choice-title">Add Restaurant</div>
                        <div class="add-choice-desc">Add a new restaurant location</div>
                    </div>
                </button>
                <button class="add-choice-btn" onclick="openAddFoodModal()">
                    <span class="add-choice-icon">üçΩÔ∏è</span>
                    <div class="add-choice-text">
                        <div class="add-choice-title">Add Food Item</div>
                        <div class="add-choice-desc">Add a dish to an existing restaurant</div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <div id="addRestaurantModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Restaurant</h2>
                <button class="close-btn" onclick="closeAddRestaurantModal()">√ó</button>
            </div>
            <form id="restaurantForm">
                <div class="form-group" style="position: relative;">
                    <label>Restaurant Name</label>
                    <input type="text" id="name" placeholder="Enter restaurant name..." required autocomplete="off">
                    <div id="autocompleteResults" class="autocomplete-results"></div>
                </div>
                <div class="form-group">
                    <label>Cuisine Type</label>
                    <select id="cuisine" required>
                        <option value="Croatian">Croatian</option>
                        <option value="Seafood">Seafood</option>
                        <option value="Italian">Italian</option>
                        <option value="Mediterranean">Mediterranean</option>
                        <option value="Pizza">Pizza</option>
                        <option value="Steakhouse">Steakhouse</option>
                        <option value="Asian">Asian</option>
                        <option value="Mexican">Mexican</option>
                        <option value="Cafe">Cafe</option>
                        <option value="International">International</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Price Range</label>
                    <select id="price" required>
                        <option value="1">‚Ç¨ - Budget (Under ‚Ç¨15)</option>
                        <option value="2">‚Ç¨‚Ç¨ - Moderate (‚Ç¨15-30)</option>
                        <option value="3">‚Ç¨‚Ç¨‚Ç¨ - Upscale (‚Ç¨30-60)</option>
                        <option value="4">‚Ç¨‚Ç¨‚Ç¨‚Ç¨ - Fine Dining (‚Ç¨60+)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>üìç Location</label>
                    <div class="location-picker-btn" onclick="openLocationPicker()">
                        <span class="location-picker-icon">üó∫Ô∏è</span>
                        <span class="location-picker-text" id="locationText">Tap to select location on map</span>
                        <span class="location-picker-arrow">‚Ä∫</span>
                    </div>
                    <input type="hidden" id="location" value="">
                    <input type="hidden" id="lat">
                    <input type="hidden" id="lng">
                </div>
                <div class="form-group">
                    <label>üì∏ Restaurant Photo</label>
                    <div class="food-photo-section">
                        <div class="food-photo-preview" id="restaurantPhotoPreview">
                            <div class="food-photo-empty">
                                <span>üè™</span>
                                <span>No photo added</span>
                            </div>
                        </div>
                        <div class="food-photo-buttons">
                            <button type="button" class="food-photo-btn camera" onclick="triggerRestaurantCamera()">
                                <span>üì∑</span> Camera
                            </button>
                            <button type="button" class="food-photo-btn gallery" onclick="triggerRestaurantGallery()">
                                <span>üñºÔ∏è</span> Gallery
                            </button>
                            <button type="button" class="food-photo-btn remove" id="removeRestaurantPhotoBtn" onclick="removeRestaurantPhoto()" style="display: none;">
                                <span>‚úï</span> Remove
                            </button>
                        </div>
                        <input type="file" id="restaurantCameraInput" class="photo-upload-input" accept="image/*" capture="environment" onchange="handleRestaurantPhotoSelect(event)">
                        <input type="file" id="restaurantGalleryInput" class="photo-upload-input" accept="image/*" onchange="handleRestaurantPhotoSelect(event)">
                        <input type="hidden" id="restaurantPhotoData" value="">
                    </div>
                </div>
                <button type="submit" class="submit-btn" onclick="saveRestaurant(event)">Save Restaurant</button>
            </form>
        </div>
    </div>

    <div id="addFoodModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Food Item</h2>
                <button class="close-btn" onclick="closeAddFoodModal()">√ó</button>
            </div>
            <form id="foodForm">
                <div class="form-group">
                    <label>Select Restaurant</label>
                    <select id="foodRestaurant" required>
                        <option value="">Choose a restaurant...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="foodCategory" required onchange="populateFoodSubcategories()">
                        <option value="">Choose category...</option>
                    </select>
                </div>
                <div class="form-group" id="foodSubcategoryGroup" style="display: none;">
                    <label>Subcategory</label>
                    <select id="foodSubcategory">
                        <option value="">Choose subcategory...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Dish Name</label>
                    <input type="text" id="dishName" placeholder="e.g., Grilled Sea Bass" required>
                </div>
                <div class="form-group">
                    <label>Price (optional)</label>
                    <input type="text" id="dishPrice" placeholder="e.g., ‚Ç¨15">
                </div>
                <div class="rating-group">
                    <div class="rating-item">
                        <label>Food Rating</label>
                        <div class="stars" id="foodStars">
                            <span class="star" data-rating="food" data-value="1">‚òÖ</span>
                            <span class="star" data-rating="food" data-value="2">‚òÖ</span>
                            <span class="star" data-rating="food" data-value="3">‚òÖ</span>
                            <span class="star" data-rating="food" data-value="4">‚òÖ</span>
                            <span class="star" data-rating="food" data-value="5">‚òÖ</span>
                        </div>
                        <input type="hidden" id="foodRating" value="0">
                    </div>
                    <div class="rating-item">
                        <label>Service</label>
                        <div class="stars" id="serviceStars">
                            <span class="star" data-rating="service" data-value="1">‚òÖ</span>
                            <span class="star" data-rating="service" data-value="2">‚òÖ</span>
                            <span class="star" data-rating="service" data-value="3">‚òÖ</span>
                            <span class="star" data-rating="service" data-value="4">‚òÖ</span>
                            <span class="star" data-rating="service" data-value="5">‚òÖ</span>
                        </div>
                        <input type="hidden" id="serviceRating" value="0">
                    </div>
                </div>
                <div class="form-group">
                    <label>Visit Date</label>
                    <input type="date" id="visitDate" required>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="foodNotes" placeholder="How was it? Any memorable details?"></textarea>
                </div>
                <div class="form-group">
                    <label>üì∏ Food Photo</label>
                    <div class="food-photo-section">
                        <div class="food-photo-preview" id="foodPhotoPreview">
                            <div class="food-photo-empty">
                                <span>üì∑</span>
                                <span>No photo added</span>
                            </div>
                        </div>
                        <div class="food-photo-buttons">
                            <button type="button" class="food-photo-btn camera" onclick="triggerFoodCamera()">
                                <span>üì∑</span> Take Photo
                            </button>
                            <button type="button" class="food-photo-btn gallery" onclick="triggerFoodGallery()">
                                <span>üñºÔ∏è</span> Gallery
                            </button>
                            <button type="button" class="food-photo-btn remove" id="removeFoodPhotoBtn" onclick="removeFoodPhoto()" style="display: none;">
                                <span>‚úï</span> Remove
                            </button>
                        </div>
                        <input type="file" id="foodCameraInput" class="photo-upload-input" accept="image/*" capture="environment" onchange="handleFoodPhotoSelect(event)">
                        <input type="file" id="foodGalleryInput" class="photo-upload-input" accept="image/*" onchange="handleFoodPhotoSelect(event)">
                        <input type="hidden" id="foodPhotoData" value="">
                    </div>
                </div>
                <button type="submit" class="submit-btn" onclick="saveFoodItem(event)">Save Food Item</button>
            </form>
        </div>
    </div>

    <div id="viewModal" class="restaurant-detail-modal">
        <div class="restaurant-detail-overlay" onclick="closeViewModal()"></div>
        <div class="restaurant-detail-content">
            <div class="restaurant-detail-hero" id="restaurantHero">
                <!-- Hero image or gradient will be inserted here -->
            </div>
            <button class="restaurant-detail-close" onclick="closeViewModal()">√ó</button>
            <div class="restaurant-detail-body" id="restaurantDetails"></div>
        </div>
    </div>

    <!-- Location Picker Modal -->
    <div id="locationPickerModal" class="location-picker-modal">
        <div class="location-picker-header">
            <button class="location-picker-back" onclick="closeLocationPicker()">‚úï</button>
            <h2>Select Location</h2>
            <button class="location-picker-confirm" id="confirmLocationBtn" onclick="confirmLocation()">Done</button>
        </div>
        <div class="location-picker-search">
            <input type="text" id="locationSearchInput" placeholder="üîç Search for a place...">
        </div>
        <div id="locationPickerMap" class="location-picker-map"></div>
        <div class="location-picker-instructions">
            <span>üìç</span> Tap on the map to drop a pin
        </div>
    </div>

    <div id="dishDetailModal" class="dish-detail-modal">
        <div class="dish-detail-content">
            <div class="dish-detail-header" id="dishDetailImage">
                üçï
            </div>
            <button class="dish-detail-close" onclick="closeDishDetail()">√ó</button>
            <div class="dish-detail-body" id="dishDetailBody"></div>
        </div>
    </div>

    <div id="demoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Choose Pin Style</h2>
                <button class="close-btn" onclick="closeDemoMenu()">√ó</button>
            </div>
            <p style="color: #636e72; margin-bottom: 20px; font-size: 14px;">Select your preferred marker style for the map</p>
            <div class="pin-options">
                <div class="pin-option selected" data-pin-type="float-card" onclick="selectPin('float-card')" style="grid-column: 1 / -1; padding: 20px;">
                    <div class="pin-name" style="margin-bottom: 8px; font-size: 16px;">Float Card</div>
                    <div class="pin-desc" style="margin-bottom: 16px;">Shows name + category/price/rating info</div>
                    
                    <div style="display: flex; gap: 16px; flex-wrap: wrap; justify-content: space-between;">
                        <!-- Card 1: Category Example -->
                        <div style="text-align: center; flex: 1; min-width: 140px;">
                            <div style="font-size: 10px; color: #636e72; margin-bottom: 6px;">üìÇ Category</div>
                            <div style="display: flex; align-items: center; background: white; border-radius: 20px; padding: 6px 14px 6px 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.12); gap: 8px; justify-content: center;">
                                <div style="width: 32px; height: 32px; background: #ff6b6b; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 15px;">üç¥</div>
                                <div style="line-height: 1.2; text-align: left;"><div style="font-size: 12px; font-weight: 700; color: #2d3436;">Restaurant</div><div style="font-size: 10px; color: #636e72;">250m</div></div>
                            </div>
                        </div>
                        
                        <!-- Card 2: Price Example -->
                        <div style="text-align: center; flex: 1; min-width: 140px;">
                            <div style="font-size: 10px; color: #636e72; margin-bottom: 6px;">üí∞ Price</div>
                            <div style="display: flex; align-items: center; background: white; border-radius: 20px; padding: 6px 14px 6px 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.12); gap: 8px; justify-content: center;">
                                <div style="width: 32px; height: 32px; background: #ff6b6b; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 15px;">üç¥</div>
                                <div style="line-height: 1.2; text-align: left;"><div style="font-size: 12px; font-weight: 700; color: #2d3436;">La Trattoria</div><div style="font-size: 10px; color: #51cf66;">‚Ç¨5-15</div></div>
                            </div>
                        </div>
                        
                        <!-- Card 3: Rating Example -->
                        <div style="text-align: center; flex: 1; min-width: 140px;">
                            <div style="font-size: 10px; color: #636e72; margin-bottom: 6px;">‚≠ê Rating</div>
                            <div style="display: flex; align-items: center; background: white; border-radius: 20px; padding: 6px 14px 6px 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.12); gap: 8px; justify-content: center;">
                                <div style="width: 32px; height: 32px; background: #ff6b6b; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 15px;">üç¥</div>
                                <div style="line-height: 1.2; text-align: left;"><div style="font-size: 12px; font-weight: 700; color: #2d3436;">Old Tavern</div><div style="font-size: 10px; color: #ff6b6b;">‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ 2.1</div></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="pin-option" data-pin-type="circle-dot" onclick="selectPin('circle-dot')" style="grid-column: 1 / -1; padding: 20px;">
                    <div class="pin-name" style="margin-bottom: 8px; font-size: 16px;">Circle + Dot</div>
                    <div class="pin-desc" style="margin-bottom: 16px;">Modern circle with dot marker - category color with badge indicators</div>
                    
                    <div style="display: flex; gap: 16px; flex-wrap: wrap; justify-content: space-between;">
                        <!-- 1a: Category (Restaurang) -->
                        <div style="text-align: center; flex: 1; min-width: 80px;">
                            <div style="font-size: 10px; color: #636e72; margin-bottom: 6px; font-weight: 600;">1a</div>
                            <div style="display: flex; flex-direction: column; align-items: center;">
                                <div style="width: 50px; height: 50px; background: #ff6b5b; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 16px rgba(0,0,0,0.2); border: 3px solid white;">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M11 9H9V2H7v7H5V2H3v7c0 2.12 1.66 3.84 3.75 3.97V22h2.5v-9.03C11.34 12.84 13 11.12 13 9V2h-2v7zm5-3v8h2.5v8H21V2c-2.76 0-5 2.24-5 4z"/></svg>
                                </div>
                                <div style="width: 10px; height: 10px; background: #ff6b5b; border-radius: 50%; margin-top: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>
                            </div>
                            <div style="font-size: 9px; color: #636e72; margin-top: 6px;">üìÇ Category</div>
                        </div>
                        
                        <!-- 1b: Price (Billig) -->
                        <div style="text-align: center; flex: 1; min-width: 80px;">
                            <div style="font-size: 10px; color: #636e72; margin-bottom: 6px; font-weight: 600;">1b</div>
                            <div style="display: flex; flex-direction: column; align-items: center;">
                                <div style="position: relative;">
                                    <div style="width: 50px; height: 50px; background: #ff6b5b; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 16px rgba(0,0,0,0.2); border: 3px solid white;">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M11 9H9V2H7v7H5V2H3v7c0 2.12 1.66 3.84 3.75 3.97V22h2.5v-9.03C11.34 12.84 13 11.12 13 9V2h-2v7zm5-3v8h2.5v8H21V2c-2.76 0-5 2.24-5 4z"/></svg>
                                    </div>
                                    <div style="position: absolute; top: -4px; right: -8px; background: #10b981; color: white; font-size: 9px; font-weight: 700; padding: 3px 5px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">$</div>
                                </div>
                                <div style="width: 10px; height: 10px; background: #ff6b5b; border-radius: 50%; margin-top: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>
                            </div>
                            <div style="font-size: 9px; color: #636e72; margin-top: 6px;">üí∞ Price</div>
                        </div>
                        
                        <!-- 1c: Rating (Bra) -->
                        <div style="text-align: center; flex: 1; min-width: 80px;">
                            <div style="font-size: 10px; color: #636e72; margin-bottom: 6px; font-weight: 600;">1c</div>
                            <div style="display: flex; flex-direction: column; align-items: center;">
                                <div style="position: relative;">
                                    <div style="width: 50px; height: 50px; background: #8b5cf6; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 16px rgba(0,0,0,0.2); border: 3px solid white;">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M20 3H4v10c0 2.21 1.79 4 4 4h6c2.21 0 4-1.79 4-4v-3h2c1.11 0 2-.9 2-2V5c0-1.11-.89-2-2-2z"/></svg>
                                    </div>
                                    <div style="position: absolute; top: -4px; left: -8px; background: #10b981; color: white; font-size: 9px; font-weight: 700; padding: 3px 5px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 2px;">
                                        <svg width="8" height="8" viewBox="0 0 24 24" fill="white"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>4.8
                                    </div>
                                </div>
                                <div style="width: 10px; height: 10px; background: #8b5cf6; border-radius: 50%; margin-top: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>
                            </div>
                            <div style="font-size: 9px; color: #636e72; margin-top: 6px;">‚≠ê Rating</div>
                        </div>
                        
                        <!-- 1d: Combined (Price + Rating) -->
                        <div style="text-align: center; flex: 1; min-width: 80px;">
                            <div style="font-size: 10px; color: #636e72; margin-bottom: 6px; font-weight: 600;">1d</div>
                            <div style="display: flex; flex-direction: column; align-items: center;">
                                <div style="position: relative;">
                                    <div style="width: 50px; height: 50px; background: #f59e0b; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 16px rgba(0,0,0,0.2); border: 3px solid white;">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M21 5V3H3v2l8 9v5H6v2h12v-2h-5v-5l8-9z"/></svg>
                                    </div>
                                    <div style="position: absolute; top: -4px; right: -8px; background: #10b981; color: white; font-size: 9px; font-weight: 700; padding: 3px 5px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">$</div>
                                    <div style="position: absolute; top: -4px; left: -8px; background: #10b981; color: white; font-size: 9px; font-weight: 700; padding: 3px 5px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 2px;">
                                        <svg width="8" height="8" viewBox="0 0 24 24" fill="white"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>4.5
                                    </div>
                                </div>
                                <div style="width: 10px; height: 10px; background: #f59e0b; border-radius: 50%; margin-top: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>
                            </div>
                            <div style="font-size: 9px; color: #636e72; margin-top: 6px;">üí∞+‚≠ê Combined</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    </div><!-- END MAIN APP -->

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCFAWge9ldMBE_ToKDBwn6_T1G1ZrBeQgY",
            authDomain: "makarsk-dining.firebaseapp.com",
            projectId: "makarsk-dining",
            storageBucket: "makarsk-dining.firebasestorage.app",
            messagingSenderId: "573489897014",
            appId: "1:573489897014:web:25889f1f530a70badd8297",
            measurementId: "G-1S9NFBM9D3"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Current user state
        let currentUser = null;

        // ========== AUTHENTICATION FUNCTIONS ==========

        // Convert username to email format for Firebase Auth
        function usernameToEmail(username) {
            return username.toLowerCase().trim() + '@makarska-dining.app';
        }

        // Show login form
        function showLoginForm() {
            document.getElementById('loginFormContainer').style.display = 'block';
            document.getElementById('registerFormContainer').style.display = 'none';
            document.getElementById('loginError').textContent = '';
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
        }

        // Show register form
        function showRegisterForm() {
            document.getElementById('loginFormContainer').style.display = 'none';
            document.getElementById('registerFormContainer').style.display = 'block';
            document.getElementById('registerError').textContent = '';
            document.getElementById('registerUsername').value = '';
            document.getElementById('registerPassword').value = '';
            document.getElementById('registerPasswordConfirm').value = '';
        }

        // Handle email/password login
        async function handleEmailLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            if (!username || !password) {
                errorDiv.textContent = 'Please enter username and password';
                return;
            }

            try {
                errorDiv.textContent = 'Signing in...';
                const email = usernameToEmail(username);
                await auth.signInWithEmailAndPassword(email, password);
                // Auth state listener will handle navigation
            } catch (error) {
                console.error('Login error:', error);
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorDiv.textContent = 'Invalid username or password';
                } else if (error.code === 'auth/too-many-requests') {
                    errorDiv.textContent = 'Too many attempts. Try again later.';
                } else {
                    errorDiv.textContent = 'Login failed. Please try again.';
                }
            }
        }

        // Handle registration
        async function handleRegister() {
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerPasswordConfirm').value;
            const errorDiv = document.getElementById('registerError');

            if (!username || !password || !confirmPassword) {
                errorDiv.textContent = 'Please fill in all fields';
                return;
            }

            if (username.length < 3) {
                errorDiv.textContent = 'Username must be at least 3 characters';
                return;
            }

            if (password.length < 6) {
                errorDiv.textContent = 'Password must be at least 6 characters';
                return;
            }

            if (password !== confirmPassword) {
                errorDiv.textContent = 'Passwords do not match';
                return;
            }

            try {
                errorDiv.textContent = 'Creating account...';
                const email = usernameToEmail(username);
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);

                // Update display name with username
                await userCredential.user.updateProfile({
                    displayName: username
                });

                // Save user profile to Firestore
                await db.collection('users').doc(userCredential.user.uid).set({
                    username: username,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Auth state listener will handle navigation
            } catch (error) {
                console.error('Registration error:', error);
                if (error.code === 'auth/email-already-in-use') {
                    errorDiv.textContent = 'Username already taken';
                } else if (error.code === 'auth/weak-password') {
                    errorDiv.textContent = 'Password is too weak';
                } else {
                    errorDiv.textContent = 'Registration failed. Please try again.';
                }
            }
        }

        // Handle logout
        async function handleLogout() {
            try {
                await auth.signOut();
                showLoginScreen();
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Auth state listener
        auth.onAuthStateChanged((user) => {
            currentUser = user;
            if (user) {
                console.log('User logged in:', user.displayName || user.email);
                // User is signed in, proceed to app
                handleLogin();
            } else {
                console.log('User logged out');
                // User is signed out, show login screen
                showLoginScreen();
            }
        });

        // Firestore helper functions
        async function saveRestaurantsToFirestore(restaurantsData) {
            try {
                const batch = db.batch();

                // Save each restaurant as a document
                restaurantsData.forEach(restaurant => {
                    const docRef = db.collection('restaurants').doc(String(restaurant.id));
                    batch.set(docRef, restaurant);
                });

                await batch.commit();
                console.log('Restaurants saved to Firestore');
                return true;
            } catch (error) {
                console.error('Error saving to Firestore:', error);
                return false;
            }
        }

        async function loadRestaurantsFromFirestore() {
            try {
                const snapshot = await db.collection('restaurants').get();
                if (snapshot.empty) {
                    console.log('No restaurants in Firestore');
                    return null;
                }

                const restaurantsData = [];
                snapshot.forEach(doc => {
                    restaurantsData.push(doc.data());
                });

                console.log('Loaded', restaurantsData.length, 'restaurants from Firestore');
                return restaurantsData;
            } catch (error) {
                console.error('Error loading from Firestore:', error);
                return null;
            }
        }

        async function saveRestaurantToFirestore(restaurant) {
            try {
                await db.collection('restaurants').doc(String(restaurant.id)).set(restaurant);
                console.log('‚òÅÔ∏è Saved to Firestore:', restaurant.name);
                return true;
            } catch (error) {
                console.error('‚ùå Error saving', restaurant.name, 'to Firestore:', error.message);
                // Check if it's a size issue
                const dataSize = JSON.stringify(restaurant).length;
                if (dataSize > 900000) {
                    console.warn('Document too large:', Math.round(dataSize/1024), 'KB (limit is ~1MB). Try removing photos.');
                }
                return false;
            }
        }

        async function deleteRestaurantFromFirestore(restaurantId) {
            try {
                await db.collection('restaurants').doc(String(restaurantId)).delete();
                console.log('Restaurant deleted from Firestore');
                return true;
            } catch (error) {
                console.error('Error deleting from Firestore:', error);
                return false;
            }
        }

        // ========== GROUPS FIRESTORE FUNCTIONS ==========

        async function saveGroupsToFirestore(groupsData) {
            try {
                // Save all groups as a single document (simpler for user-specific data)
                await db.collection('userdata').doc('groups').set({ groups: groupsData });
                console.log('‚òÅÔ∏è Groups saved to Firestore:', groupsData.length, 'groups');
                return true;
            } catch (error) {
                console.error('‚ùå Error saving groups to Firestore:', error);
                return false;
            }
        }

        async function loadGroupsFromFirestore() {
            try {
                const doc = await db.collection('userdata').doc('groups').get();
                if (doc.exists && doc.data().groups) {
                    console.log('‚òÅÔ∏è Loaded groups from Firestore:', doc.data().groups.length);
                    return doc.data().groups;
                }
                return null;
            } catch (error) {
                console.error('Error loading groups from Firestore:', error);
                return null;
            }
        }

        async function initGroupsFirestoreSync() {
            try {
                const firestoreGroups = await loadGroupsFromFirestore();

                if (firestoreGroups && firestoreGroups.length > 0) {
                    // Use Firestore data
                    userGroups = firestoreGroups;
                    localStorage.setItem('userGroups', JSON.stringify(userGroups));
                    console.log('‚úÖ Groups synced from Firestore');
                } else {
                    // Upload local groups to Firestore
                    const localGroups = JSON.parse(localStorage.getItem('userGroups')) || [];
                    if (localGroups.length > 0) {
                        await saveGroupsToFirestore(localGroups);
                        console.log('‚úÖ Local groups uploaded to Firestore');
                    }
                }
            } catch (error) {
                console.error('Groups Firestore sync failed:', error);
            }
        }

        // ========== END GROUPS FIRESTORE ==========

        // Sync status indicator
        let firestoreConnected = false;

        async function initFirestoreSync() {
            try {
                console.log('Starting Firestore sync...');

                // Try to load from Firestore first
                const firestoreData = await loadRestaurantsFromFirestore();

                if (firestoreData && firestoreData.length > 0) {
                    // Use Firestore data
                    restaurants = firestoreData;
                    localStorage.setItem('restaurants', JSON.stringify(restaurants));
                    firestoreConnected = true;
                    console.log('‚úÖ Synced from Firestore:', firestoreData.length, 'restaurants');
                } else {
                    // Upload local data to Firestore if Firestore is empty
                    const localData = JSON.parse(localStorage.getItem('restaurants'));
                    if (localData && localData.length > 0) {
                        console.log('Firestore empty, uploading', localData.length, 'restaurants...');

                        // Upload each restaurant individually (in case some are too large)
                        let uploaded = 0;
                        let failed = 0;
                        for (const restaurant of localData) {
                            try {
                                await db.collection('restaurants').doc(String(restaurant.id)).set(restaurant);
                                uploaded++;
                            } catch (err) {
                                console.warn('Failed to upload', restaurant.name, ':', err.message);
                                failed++;
                            }
                        }

                        firestoreConnected = true;
                        console.log('‚úÖ Uploaded to Firestore:', uploaded, 'success,', failed, 'failed');

                        if (failed > 0) {
                            console.warn('Some restaurants failed - they may have photos that are too large (>1MB limit)');
                        }
                    } else {
                        console.log('No local data to upload');
                        firestoreConnected = true;
                    }
                }

                // Also sync groups
                await initGroupsFirestoreSync();

                updateSyncStatus(true);
            } catch (error) {
                console.error('‚ùå Firestore sync failed:', error);
                updateSyncStatus(false);
            }
        }

        function updateSyncStatus(connected) {
            const statusEl = document.getElementById('syncStatus');
            if (statusEl) {
                statusEl.innerHTML = connected
                    ? '<span style="color: #27ae60;">‚òÅÔ∏è Synced</span>'
                    : '<span style="color: #e74c3c;">‚ö†Ô∏è Offline</span>';
            }
        }

        // Save a single restaurant to both localStorage and Firestore
        async function saveRestaurant(restaurant) {
            localStorage.setItem('restaurants', JSON.stringify(restaurants));

            if (firestoreConnected) {
                await saveRestaurantToFirestore(restaurant);
            }
        }

        // Delete a restaurant from both localStorage and Firestore
        async function deleteRestaurant(restaurantId) {
            if (firestoreConnected) {
                await deleteRestaurantFromFirestore(restaurantId);
            }
        }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.min.js"></script>
    <script>
        let map;
        let markers = [];
        let markerClusterGroup = null;
        
        // User's saved data is preserved - no automatic clearing
        // Use "Reset to Demo Data" in Settings if you want to reload default positions
        
        let restaurants = JSON.parse(localStorage.getItem('restaurants')) || [
            // === DINA RIKTIGA RESTAURANGER ===
            // Justera lat/lng f√∂r att flytta pins p√• kartan
            {
                id: 1,
                name: "Bruschetta",
                mainCategory: "restaurant",
                cuisine: "Italian",
                area: "Stora stranden",
                address: "≈†etali≈°te Dr. Franje Tuƒëmana 10",
                lat: 43.2948,
                lng: 17.0198,
                price: 2,
                foodRating: 4,
                serviceRating: 4,
                visitDate: "2024-09-01",
                notes: "Italiensk, pizza och pasta",
                foodItems: [
                    { name: "Bruschetta", category: "appetizer", rating: 4, price: "", comment: "" },
                    { name: "Carbonara", category: "pasta", rating: 3, price: "", comment: "god men ej smak av Carbonara" },
                    { name: "Bolognese", category: "pasta", rating: 4, price: "", comment: "god!" },
                    { name: "Gnocchi gorgonzola", category: "pasta", rating: 4, price: "", comment: "god" },
                    { name: "Kalkonsallad", category: "salad", rating: 5, price: "", comment: "v√§ldigt god!" },
                    { name: "Pizza bianco Kulen", category: "pizza", rating: 5, price: "", comment: "v√§ldigt god!" },
                    { name: "Petto di pollo tartufo", category: "meat", rating: 5, price: "", comment: "svingod s√•s!" },
                    { name: "Lasagne lax spenat", category: "pasta", rating: 3.5, price: "", comment: "helt okej, god" }
                ]
            },
            {
                id: 2,
                name: "Mucrum",
                mainCategory: "restaurant",
                cuisine: "Italian",
                area: "Centrum",
                address: "≈†etali≈°te Dr. Franje Tuƒëmana 14",
                lat: 43.2952,
                lng: 17.0178,
                price: 2,
                foodRating: 4,
                serviceRating: 4,
                visitDate: "2024-09-01",
                notes: "Italiensk",
                foodItems: [
                    { name: "Carbonara", category: "pasta", rating: 4, price: "", comment: "god! Smak av √§gg och parmesan" },
                    { name: "Husets vita vin", category: "wine", rating: 4, price: "", comment: "gott" },
                    { name: "Bolognese", category: "pasta", rating: 3, price: "", comment: "okej" }
                ]
            },
            {
                id: 3,
                name: "Hops",
                mainCategory: "restaurant",
                cuisine: "Croatian",
                area: "Riva",
                address: "Marineta 7",
                lat: 43.2957,
                lng: 17.0168,
                price: 3,
                foodRating: 4,
                serviceRating: 4,
                visitDate: "2024-09-01",
                notes: "God mat, varierat meny, eget bryggeri",
                foodItems: [
                    { name: "Tacos", category: "mexican", rating: 4, price: "", comment: "god" },
                    { name: "√ñl Biokovo", category: "beer", rating: 4, price: "", comment: "god" },
                    { name: "Teleƒáe peƒçenje (veal roast)", category: "meat", rating: 5, price: "", comment: "gott!! med potatis och k√•l" },
                    { name: "Veggie salad", category: "salad", rating: 5, price: "", comment: "mycket god!" },
                    { name: "Cevapi", category: "meat", rating: 4, price: "", comment: "bra k√∂ttsmak, med ljepinja" },
                    { name: "Bruntastic sandwich", category: "sandwich", rating: 4.5, price: "", comment: "god!! Gott br√∂d" }
                ]
            },
            {
                id: 4,
                name: "Europa",
                mainCategory: "restaurant",
                cuisine: "Croatian",
                area: "Centrum",
                address: "Kalalarga",
                lat: 43.2954,
                lng: 17.0180,
                price: 2,
                foodRating: 3,
                serviceRating: 3,
                visitDate: "2024-09-01",
                notes: "",
                foodItems: [
                    { name: "Soppa", category: "soup", rating: 3, price: "", comment: "okej" },
                    { name: "Cevapi", category: "meat", rating: 2, price: "", comment: "4 av 10" }
                ]
            },
            {
                id: 5,
                name: "Lemon Garden",
                mainCategory: "restaurant",
                cuisine: "Mediterranean",
                area: "Stora stranden",
                address: "≈†etali≈°te Dr. Franje Tuƒëmana 10-11",
                lat: 43.2945,
                lng: 17.0205,
                price: 2,
                foodRating: 4,
                serviceRating: 3,
                visitDate: "2024-09-01",
                notes: "Mindre sallad √§n p√• bilden",
                foodItems: [
                    { name: "Kalkonfilet med kroketter", category: "meat", rating: 5, price: "", comment: "j√§ttegod!" },
                    { name: "Bolognese", category: "pasta", rating: 3, price: "", comment: "okej, mycket s√•s" },
                    { name: "Kycklingsallad", category: "salad", rating: 4, price: "", comment: "god" },
                    { name: "Ljetna salata kyckling", category: "salad", rating: 4, price: "", comment: "matig och god" }
                ]
            },
            {
                id: 6,
                name: "Berlin",
                mainCategory: "restaurant",
                cuisine: "Mediterranean",
                area: "Stora stranden",
                address: "≈†etali≈°te Dr. Franje Tuƒëmana 13A",
                lat: 43.2943,
                lng: 17.0210,
                price: 2,
                foodRating: 3,
                serviceRating: 3,
                visitDate: "2024-09-01",
                notes: "",
                foodItems: [
                    { name: "Bolognese", category: "pasta", rating: 3, price: "", comment: "helt okej" },
                    { name: "Blandsallad", category: "salad", rating: 4, price: "", comment: "god dressing" },
                    { name: "Lax och r√§kpasta", category: "pasta", rating: 4, price: "", comment: "god!" },
                    { name: "Toast", category: "breakfast", rating: 3.5, price: "", comment: "" }
                ]
            },
            {
                id: 7,
                name: "Dinners Delight",
                mainCategory: "restaurant",
                cuisine: "Mediterranean",
                area: "Stora stranden",
                address: "≈†etali≈°te Dr. Franje Tuƒëmana 13",
                lat: 43.2941,
                lng: 17.0215,
                price: 2,
                foodRating: 4,
                serviceRating: 3,
                visitDate: "2024-09-01",
                notes: "30 min v√§ntan ibland",
                foodItems: [
                    { name: "Kycklingsallad", category: "salad", rating: 4, price: "", comment: "v√§ldigt god kyckling" },
                    { name: "Kyckling avokado sallad", category: "salad", rating: 5, price: "", comment: "mycket god!!" },
                    { name: "ƒåevapi med kajmak", category: "meat", rating: 4, price: "", comment: "gott!" },
                    { name: "Pasta siciliana", category: "pasta", rating: 5, price: "", comment: "5/5 kr√§mig god!!!" },
                    { name: "Schnitzel med svamps√•s", category: "meat", rating: 4, price: "", comment: "v√§ldigt god s√•s!" }
                ]
            },
            {
                id: 8,
                name: "Matteo",
                mainCategory: "restaurant",
                cuisine: "Italian",
                area: "Centrum",
                address: "Put Cvitaƒçke 6",
                lat: 43.2958,
                lng: 17.0165,
                price: 2,
                foodRating: 3,
                serviceRating: 3,
                visitDate: "2024-09-01",
                notes: "",
                foodItems: [
                    { name: "Weinerschnitzel", category: "meat", rating: 3, price: "", comment: "helt okej" },
                    { name: "Pasta fyra ostar", category: "pasta", rating: 3, price: "", comment: "helt okej" }
                ]
            },
            {
                id: 9,
                name: "Sloppy Joe",
                mainCategory: "restaurant",
                cuisine: "Croatian",
                area: "Centrum",
                address: "Marineta ul.",
                lat: 43.2960,
                lng: 17.0168,
                price: 2,
                foodRating: 3,
                serviceRating: 3,
                visitDate: "2024-09-01",
                notes: "",
                foodItems: [
                    { name: "ƒÜevapi", category: "meat", rating: 3, price: "", comment: "okej, be om kajmak och ajvar" }
                ]
            },
            {
                id: 10,
                name: "Franco",
                mainCategory: "restaurant",
                cuisine: "Italian",
                area: "Riva",
                address: "Obala Kralja Tomislava 7",
                lat: 43.2968,
                lng: 17.0175,
                price: 2,
                foodRating: 3,
                serviceRating: 4,
                visitDate: "2024-09-01",
                notes: "Bra service, utsp√§dd sprit",
                foodItems: [
                    { name: "Kyckling risotto", category: "risotto", rating: 3.5, price: "", comment: "helt okej, god" },
                    { name: "Kycklingpasta", category: "pasta", rating: 4, price: "", comment: "god!" },
                    { name: "Lasagne", category: "pasta", rating: 3.5, price: "", comment: "god men lite krydda" },
                    { name: "Weinerschnitzel", category: "meat", rating: 1, price: "", comment: "underk√§nt!" }
                ]
            },
            {
                id: 11,
                name: "Bolero",
                mainCategory: "restaurant",
                cuisine: "Mediterranean",
                area: "Centrum",
                address: "Marineta ul. (sista innan Dalmacija)",
                lat: 43.2956,
                lng: 17.0162,
                price: 2,
                foodRating: 3,
                serviceRating: 3,
                visitDate: "2024-09-01",
                notes: "",
                foodItems: [
                    { name: "Kycklingsallad", category: "salad", rating: 3, price: "", comment: "f√∂r mycket s√•s" },
                    { name: "Bolognese", category: "pasta", rating: 2, price: "", comment: "2/5" }
                ]
            },
            {
                id: 12,
                name: "Restoran Marina",
                mainCategory: "restaurant",
                cuisine: "Italian",
                area: "Riva",
                address: "Marineta ul. 11",
                lat: 43.2955,
                lng: 17.0170,
                price: 2,
                foodRating: 4,
                serviceRating: 4,
                visitDate: "2024-09-01",
                notes: "Bra service! Goda pizzor!",
                foodItems: [
                    { name: "Pizza bianco Quattro formaggio", category: "pizza", rating: 4.5, price: "", comment: "4.5/5" },
                    { name: "Pizza prosciutto", category: "pizza", rating: 5, price: "", comment: "mycket god!" },
                    { name: "Risotto seafood", category: "risotto", rating: 4, price: "", comment: "god smak" }
                ]
            },
            {
                id: 13,
                name: "Cajeta",
                mainCategory: "restaurant",
                cuisine: "Croatian",
                area: "Tuƒçepi",
                address: "Tuƒçepi",
                lat: 43.2700,
                lng: 17.0550,
                price: 3,
                foodRating: 5,
                serviceRating: 4,
                visitDate: "2024-09-01",
                notes: "",
                foodItems: [
                    { name: "R√§krisotto soltorkade tomater", category: "risotto", rating: 4, price: "", comment: "god!" },
                    { name: "Bolognese", category: "pasta", rating: 4, price: "", comment: "klart godk√§nd!" },
                    { name: "Lasagne", category: "pasta", rating: 5, price: "", comment: "10/10" }
                ]
            },
            {
                id: 14,
                name: "Hotel Milenij",
                mainCategory: "restaurant",
                cuisine: "Mediterranean",
                area: "Centrum",
                address: "≈†etali≈°te Dr. Franje Tuƒëmana",
                lat: 43.2950,
                lng: 17.0195,
                price: 3,
                foodRating: 3,
                serviceRating: 3,
                visitDate: "2024-09-01",
                notes: "",
                foodItems: [
                    { name: "Bolognese", category: "pasta", rating: 3, price: "", comment: "lite √∂verkokt" },
                    { name: "R√§krisotto", category: "risotto", rating: 3, price: "", comment: "√∂verkokta r√§kor" }
                ]
            },
            {
                id: 15,
                name: "Tempera",
                mainCategory: "restaurant",
                cuisine: "Croatian",
                area: "Lilla stranden",
                address: "Lilla stranden/Donja Luka",
                lat: 43.2980,
                lng: 17.0155,
                price: 2,
                foodRating: 4,
                serviceRating: 3,
                visitDate: "2024-09-01",
                notes: "God mat men l√•ng v√§ntan",
                foodItems: [
                    { name: "Mat", category: "general", rating: 4, price: "", comment: "God mat men l√•ng v√§ntan" }
                ]
            },
            {
                id: 16,
                name: "Centrum",
                mainCategory: "restaurant",
                cuisine: "Mediterranean",
                area: "Centrum",
                address: "Kalalarga/Trg",
                lat: 43.2955,
                lng: 17.0182,
                price: 2,
                foodRating: 4,
                serviceRating: 5,
                visitDate: "2024-09-01",
                notes: "Mycket bra service!",
                foodItems: [
                    { name: "R√§kpasta", category: "pasta", rating: 4, price: "", comment: "4/5" },
                    { name: "Bolognese", category: "pasta", rating: 3, price: "", comment: "3/5" }
                ]
            },
            {
                id: 17,
                name: "Gastro Diva",
                mainCategory: "restaurant",
                cuisine: "Croatian",
                area: "Centrum",
                address: "Kalalarga 22",
                lat: 43.2951,
                lng: 17.0202,
                price: 3,
                foodRating: 5,
                serviceRating: 5,
                visitDate: "2024-09-01",
                notes: "Bra service, varmt kl 19",
                foodItems: [
                    { name: "Beefsteak rostad potatis", category: "meat", rating: 4, price: "", comment: "god" },
                    { name: "Veal neck potato mash", category: "meat", rating: 5, price: "", comment: "svingott!!" },
                    { name: "Stone bass fillet", category: "seafood", rating: 5, price: "", comment: "svingott!" },
                    { name: "Vin malvazija benvenuti", category: "wine", rating: 4.5, price: "", comment: "gott" }
                ]
            },
            {
                id: 18,
                name: "Amadeus",
                mainCategory: "restaurant",
                cuisine: "Mediterranean",
                area: "Buba beach",
                address: "Buba beach",
                lat: 43.2920,
                lng: 17.0240,
                price: 2,
                foodRating: 4,
                serviceRating: 4,
                visitDate: "2024-09-01",
                notes: "",
                foodItems: [
                    { name: "Cevapi med lepinja", category: "meat", rating: 3.5, price: "", comment: "okej!" },
                    { name: "Kycklingsandwich", category: "sandwich", rating: 4, price: "", comment: "hel fil√©, god!" },
                    { name: "Pizza quattro formaggio", category: "pizza", rating: 4, price: "", comment: "goda!" },
                    { name: "Schnitzel svamps√•s", category: "meat", rating: 4.5, price: "", comment: "v√§ldigt bra smak!" },
                    { name: "Bolognese", category: "pasta", rating: 4, price: "", comment: "god!" }
                ]
            },
            {
                id: 19,
                name: "Po&Po",
                mainCategory: "restaurant",
                cuisine: "Italian",
                area: "Riva",
                address: "Obala Kralja Tomislava (efter Bruschetta)",
                lat: 43.2946,
                lng: 17.0200,
                price: 2,
                foodRating: 3,
                serviceRating: 2,
                visitDate: "2024-09-01",
                notes: "L√•ngsam service, bra fl√§ktar",
                foodItems: [
                    { name: "Tagliatelle med r√§kor", category: "pasta", rating: 3, price: "", comment: "r√§korna d√•liga" },
                    { name: "Bolognese", category: "pasta", rating: 2, price: "", comment: "smakl√∂s" }
                ]
            },
            {
                id: 20,
                name: "Casa Blanka",
                mainCategory: "restaurant",
                cuisine: "Mediterranean",
                area: "Riva",
                address: "Obala Kralja Tomislava (fin innerg√•rd)",
                lat: 43.2972,
                lng: 17.0180,
                price: 3,
                foodRating: 5,
                serviceRating: 5,
                visitDate: "2024-09-01",
                notes: "Mysigt! Bra service!",
                foodItems: [
                    { name: "Bolognese", category: "pasta", rating: 3, price: "", comment: "3/5" },
                    { name: "Tagliatelle with shrimps", category: "pasta", rating: 5, price: "", comment: "svingod! B√§sta i Makarska 9/10" },
                    { name: "Vitt vin kapja bilo", category: "wine", rating: 4, price: "", comment: "gott husets" }
                ]
            },
            {
                id: 21,
                name: "Herc",
                mainCategory: "restaurant",
                cuisine: "Seafood",
                area: "Riva",
                address: "≈†etali≈°te Dr. Franje Tuƒëmana 3a",
                lat: 43.2970,
                lng: 17.0145,
                price: 3,
                foodRating: 4,
                serviceRating: 4,
                visitDate: "2024-09-01",
                notes: "",
                foodItems: [
                    { name: "Orada na dalmantski", category: "seafood", rating: 4.5, price: "", comment: "alltid god" },
                    { name: "Schnitzel svamps√•s mos", category: "meat", rating: 4, price: "", comment: "gott!" },
                    { name: "Lasagne", category: "pasta", rating: 4, price: "", comment: "god, bra smak" },
                    { name: "K√∂ttallrik", category: "meat", rating: 5, price: "", comment: "mycket god!!" },
                    { name: "Cevapi", category: "meat", rating: 4, price: "", comment: "goda" },
                    { name: "Seabass", category: "seafood", rating: 4.5, price: "", comment: "god!" }
                ]
            },
            {
                id: 22,
                name: "Bura",
                mainCategory: "restaurant",
                cuisine: "Seafood",
                area: "Riva",
                address: "Obala Kralja Tomislava 23",
                lat: 43.2942,
                lng: 17.0155,
                price: 2,
                foodRating: 3,
                serviceRating: 3,
                visitDate: "2024-09-01",
                notes: "L√•ng tid att f√• mat",
                foodItems: [
                    { name: "Grillade r√§kor spaghetti", category: "seafood", rating: 3, price: "", comment: "med vits√•s" },
                    { name: "Pljeskavica", category: "meat", rating: 3, price: "", comment: "" }
                ]
            },
            {
                id: 23,
                name: "Lavanda",
                mainCategory: "restaurant",
                cuisine: "Italian",
                area: "Centrum",
                address: "Kalalarga",
                lat: 43.2953,
                lng: 17.0185,
                price: 2,
                foodRating: 4,
                serviceRating: 4,
                visitDate: "2024-09-01",
                notes: "Bra service, bra lunchpriser",
                foodItems: [
                    { name: "Ravioli ost prosciutto tryffel", category: "pasta", rating: 3.5, price: "", comment: "7.5/10" },
                    { name: "Tagliatelle biff tryffel", category: "pasta", rating: 3.5, price: "", comment: "√∂verkokt pasta" },
                    { name: "Vin kujundu≈æa Grabovac", category: "wine", rating: 4, price: "", comment: "gott vitt" },
                    { name: "Seafood pasta", category: "pasta", rating: 3.5, price: "", comment: "god!" }
                ]
            },
            {
                id: 24,
                name: "Mr Wok",
                mainCategory: "restaurant",
                cuisine: "Asian",
                area: "Centrum",
                address: "Kalalarga",
                lat: 43.2957,
                lng: 17.0188,
                price: 2,
                foodRating: 4,
                serviceRating: 4,
                visitDate: "2024-09-01",
                notes: "",
                foodItems: [
                    { name: "Tortilla piletina", category: "mexican", rating: 4, price: "", comment: "god! Stor" },
                    { name: "Wok sesam", category: "asian", rating: 3, price: "", comment: "bra wok" },
                    { name: "Wok last kiss med ris", category: "asian", rating: 4, price: "", comment: "gott!" }
                ]
            },
            // === GLASS/ICE CREAM ===
            {
                id: 25,
                name: "Premis Glass",
                mainCategory: "icecream",
                cuisine: "Gelato",
                area: "Stora stranden",
                address: "≈†etali≈°te Dr. Franje Tuƒëmana (h√∂rnet)",
                lat: 43.2940,
                lng: 17.0220,
                price: 1,
                foodRating: 5,
                serviceRating: 4,
                visitDate: "2024-09-01",
                notes: "",
                foodItems: [
                    { name: "Rocker", category: "gelato", rating: 5, price: "", comment: "svingod chokladig l√§tt n√∂tig" }
                ]
            },
            {
                id: 26,
                name: "Botanovic Sladoled",
                mainCategory: "icecream",
                cuisine: "Gelato",
                area: "Centrum",
                address: "≈†etali≈°te Dr. Franje Tuƒëmana 3",
                lat: 43.2968,
                lng: 17.0148,
                price: 1,
                foodRating: 5,
                serviceRating: 4,
                visitDate: "2024-09-01",
                notes: "",
                foodItems: [
                    { name: "Mango", category: "gelato", rating: 4.5, price: "", comment: "" },
                    { name: "Cheesecake", category: "gelato", rating: 4.5, price: "", comment: "" },
                    { name: "Pistage", category: "gelato", rating: 4.5, price: "", comment: "" },
                    { name: "Lime ginger", category: "gelato", rating: 4.5, price: "", comment: "" },
                    { name: "Salted caramel almond", category: "gelato", rating: 4, price: "", comment: "god!!" }
                ]
            },
            {
                id: 27,
                name: "Romana Kavana",
                mainCategory: "icecream",
                cuisine: "Gelato",
                area: "Centrum",
                address: "Kalalarga/Trg",
                lat: 43.2956,
                lng: 17.0184,
                price: 1,
                foodRating: 5,
                serviceRating: 4,
                visitDate: "2024-09-01",
                notes: "Glass",
                foodItems: [
                    { name: "Lemon cheesecake glass", category: "gelato", rating: 5, price: "", comment: "mycket god!" },
                    { name: "Dolce latte caramel", category: "gelato", rating: 4, price: "", comment: "god!" },
                    { name: "Puhuljica kokos", category: "gelato", rating: 5, price: "", comment: "god!!!" },
                    { name: "Tiramisu pistage", category: "gelato", rating: 4, price: "", comment: "god!" }
                ]
            },
            {
                id: 28,
                name: "Gajeta",
                mainCategory: "restaurant",
                cuisine: "Croatian",
                area: "Centrum",
                address: "Kalalarga",
                lat: 43.2954,
                lng: 17.0186,
                price: 2,
                foodRating: 4,
                serviceRating: 4,
                visitDate: "2024-09-01",
                notes: "Bra priser",
                foodItems: [
                    { name: "Pljeskavica med kroketter", category: "meat", rating: 4, price: "", comment: "gott! med ajvar" },
                    { name: "Bolognese", category: "pasta", rating: 3, price: "", comment: "okej!" },
                    { name: "Husets vita biokovo", category: "wine", rating: 4, price: "", comment: "gott, fruktig" }
                ]
            },
            {
                id: 29,
                name: "Basta",
                mainCategory: "restaurant",
                cuisine: "Italian",
                area: "Centrum",
                address: "Kalalarga",
                lat: 43.2952,
                lng: 17.0183,
                price: 2,
                foodRating: 5,
                serviceRating: 4,
                visitDate: "2024-09-01",
                notes: "Goda pizzor! Riktigt bra",
                foodItems: [
                    { name: "Pizza Primavera", category: "pizza", rating: 4.5, price: "", comment: "v√§ldigt god" },
                    { name: "Pizza Capricciosa", category: "pizza", rating: 3.5, price: "", comment: "helt okej! (Darko)" }
                ]
            },
            {
                id: 30,
                name: "Kantun",
                mainCategory: "icecream",
                cuisine: "Gelato",
                area: "Stora torget",
                address: "Trg Fra Andrije Kaƒçiƒáa Mio≈°iƒáa",
                lat: 43.2963,
                lng: 17.0192,
                price: 1,
                foodRating: 5,
                serviceRating: 4,
                visitDate: "2024-09-01",
                notes: "Vid stora torget",
                foodItems: [
                    { name: "Pistage", category: "gelato", rating: 5, price: "", comment: "god, kr√§mig" },
                    { name: "Choklad", category: "gelato", rating: 4, price: "", comment: "" },
                    { name: "Mango sorbet", category: "sorbet", rating: 3.5, price: "", comment: "god" },
                    { name: "Rafaello", category: "gelato", rating: 4.5, price: "", comment: "god!!" }
                ]
            },
            {
                id: 31,
                name: "Tempet",
                mainCategory: "icecream",
                cuisine: "Gelato",
                area: "Riva",
                address: "Obala Kralja Tomislava (vid font√§nen)",
                lat: 43.2976,
                lng: 17.0186,
                price: 1,
                foodRating: 4,
                serviceRating: 4,
                visitDate: "2024-09-01",
                notes: "Gratis vatten",
                foodItems: [
                    { name: "Bananasplit", category: "gelato", rating: 4, price: "", comment: "god" }
                ]
            }
        ];

        // === DATA MIGRATION: Add mainCategory to old data ===
        // This fixes restaurants saved before mainCategory was added
        (function migrateMainCategory() {
            let needsSave = false;
            restaurants.forEach(restaurant => {
                if (!restaurant.mainCategory) {
                    // Detect category based on cuisine/name
                    const cuisineLower = (restaurant.cuisine || '').toLowerCase();
                    const nameLower = (restaurant.name || '').toLowerCase();

                    if (cuisineLower.includes('gelato') || cuisineLower.includes('ice') ||
                        nameLower.includes('glass') || nameLower.includes('sladoled') ||
                        nameLower.includes('ice') || nameLower.includes('gelat')) {
                        restaurant.mainCategory = 'icecream';
                    } else if (cuisineLower.includes('dessert') || cuisineLower.includes('cake') ||
                               cuisineLower.includes('pastry') || cuisineLower.includes('bakery')) {
                        restaurant.mainCategory = 'dessert';
                    } else if (cuisineLower.includes('bar') || cuisineLower.includes('pub') ||
                               cuisineLower.includes('cafe') || cuisineLower.includes('coffee')) {
                        restaurant.mainCategory = 'drinks';
                    } else {
                        restaurant.mainCategory = 'restaurant';
                    }
                    needsSave = true;
                    console.log(`Migrated ${restaurant.name} to mainCategory: ${restaurant.mainCategory}`);
                }
            });
            if (needsSave) {
                localStorage.setItem('restaurants', JSON.stringify(restaurants));
                console.log('Data migration complete: mainCategory added to all restaurants');
            }
        })();

        let currentRestaurantId = null;
        let selectedLocation = null;
        let currentPinStyle = localStorage.getItem('pinStyle') || 'float-card';
        let selectedPinType = currentPinStyle;
        let currentFilter = 'none';

        const pinIcons = {
            classic: 'üìç',
            food: 'üçΩÔ∏è',
            star: '‚≠ê',
            chef: 'üë®‚Äçüç≥',
            pizza: 'üçï',
            'fork-knife': '<div style="width: 38px; height: 38px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: 2px solid #f1f3f5; font-size: 20px;">üç¥</div>',
            'hexagon-red': null,
            'hexagon-orange': null,
            'hexagon-yellow': null,
            'hexagon-purple': null,
            'hexagon-blue': null,
            'rating-badge': null
        };

        const cuisineColors = {
            'Croatian': '#ff6b6b',
            'Seafood': '#3498db',
            'Italian': '#27ae60',
            'Mediterranean': '#9b59b6',
            'Pizza': '#e67e22',
            'Steakhouse': '#c0392b',
            'Asian': '#f39c12',
            'Mexican': '#d35400',
            'Cafe': '#95a5a6',
            'International': '#16a085',
            'Bakery': '#f783ac',
            'Gelato': '#4dabf7',
            'Bar': '#9775fa'
        };

        // Main category colors for filter
        const mainCategoryColors = {
            'restaurant': '#ff6b6b',
            'dessert': '#f783ac',
            'icecream': '#4dabf7',
            'drinks': '#9775fa'
        };

        // Main category icons (emoji)
        const mainCategoryIcons = {
            'restaurant': 'üç¥',
            'dessert': 'üç∞',
            'icecream': 'üç¶',
            'drinks': 'üçπ'
        };

        // SVG icons for circle-dot style
        const mainCategorySvg = {
            'restaurant': '<svg width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M11 9H9V2H7v7H5V2H3v7c0 2.12 1.66 3.84 3.75 3.97V22h2.5v-9.03C11.34 12.84 13 11.12 13 9V2h-2v7zm5-3v8h2.5v8H21V2c-2.76 0-5 2.24-5 4z"/></svg>',
            'dessert': '<svg width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M12 2C8.43 2 5.23 3.54 3.01 6L12 22l8.99-16C18.78 3.55 15.57 2 12 2zM7 7c0-1.1.9-2 2-2s2 .9 2 2-.9 2-2 2-2-.9-2-2zm5 8c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>',
            'icecream': '<svg width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M12 2C9.01 2 6.5 4.37 6.5 7.5c0 .88.25 1.71.69 2.41L12 22l4.81-12.09c.44-.7.69-1.53.69-2.41C17.5 4.37 14.99 2 12 2zm0 8.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 5.5 12 5.5s2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>',
            'drinks': '<svg width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M21 5V3H3v2l8 9v5H6v2h12v-2h-5v-5l8-9zM5.66 5h12.69l-1.78 2H7.43l-1.77-2z"/></svg>'
        };

        const priceColors = {
            1: '#27ae60',
            2: '#f39c12',
            3: '#e74c3c',
            4: '#9b59b6'
        };

        const ratingColors = {
            5: '#27ae60',
            4: '#2ecc71',
            3: '#f39c12',
            2: '#e67e22',
            1: '#e74c3c'
        };

        function initMap() {
            map = L.map('map').setView([43.2964, 17.0175], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            map.on('click', function(e) {
                if (document.getElementById('addRestaurantModal').style.display === 'block') {
                    selectedLocation = e.latlng;
                    document.getElementById('lat').value = e.latlng.lat;
                    document.getElementById('lng').value = e.latlng.lng;
                    document.getElementById('location').value = `${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`;
                }
            });

            loadMarkers();
            populateSidebar();
            initAutocomplete();
        }

        // Restaurant autocomplete using OpenStreetMap
        function initAutocomplete() {
            const nameInput = document.getElementById('name');
            const resultsDiv = document.getElementById('autocompleteResults');
            let debounceTimer;
            let selectedRestaurantData = null;

            nameInput.addEventListener('input', function() {
                const query = this.value.trim();
                clearTimeout(debounceTimer);
                
                if (query.length < 3) {
                    resultsDiv.classList.remove('show');
                    return;
                }

                debounceTimer = setTimeout(() => {
                    searchRestaurants(query);
                }, 500);
            });

            nameInput.addEventListener('focus', function() {
                if (resultsDiv.children.length > 0 && this.value.length >= 3) {
                    resultsDiv.classList.add('show');
                }
            });

            document.addEventListener('click', function(e) {
                if (!nameInput.contains(e.target) && !resultsDiv.contains(e.target)) {
                    resultsDiv.classList.remove('show');
                }
            });

            async function searchRestaurants(query) {
                // Don't show loading state to avoid confusion if search fails
                try {
                    // Search for restaurants/cafes/bars in Makarska area
                    const bbox = '17.0,43.2,17.1,43.35'; // Makarska bounding box
                    const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}+restaurant+cafe+bar&format=json&limit=8&bounded=1&viewbox=${bbox}&addressdetails=1`;
                    
                    const response = await fetch(url, {
                        headers: {
                            'Accept-Language': 'en'
                        }
                    });
                    
                    if (!response.ok) {
                        resultsDiv.classList.remove('show');
                        return;
                    }
                    
                    const data = await response.json();
                    
                    if (data.length > 0) {
                        displayResults(data.slice(0, 8));
                    } else {
                        resultsDiv.classList.remove('show');
                    }
                } catch (error) {
                    // Silently fail - user can still type manually
                    resultsDiv.classList.remove('show');
                }
            }

            function displayResults(results) {
                if (results.length === 0) {
                    resultsDiv.classList.remove('show');
                    return;
                }

                resultsDiv.innerHTML = results.map(place => {
                    const name = place.name || place.display_name.split(',')[0];
                    const address = place.address ? 
                        [place.address.road, place.address.house_number, place.address.city || place.address.town].filter(Boolean).join(', ') :
                        place.display_name.split(',').slice(1, 3).join(',');
                    const type = place.type || place.class || '';
                    
                    return `
                        <div class="autocomplete-item" data-name="${name}" data-lat="${place.lat}" data-lng="${place.lon}" data-address="${address}">
                            <div class="name">${name}</div>
                            <div class="address">${address}</div>
                            ${type ? `<div class="type">${type}</div>` : ''}
                        </div>
                    `;
                }).join('');

                resultsDiv.classList.add('show');

                // Add click handlers
                resultsDiv.querySelectorAll('.autocomplete-item').forEach(item => {
                    item.addEventListener('click', function() {
                        nameInput.value = this.dataset.name;
                        document.getElementById('lat').value = this.dataset.lat;
                        document.getElementById('lng').value = this.dataset.lng;
                        document.getElementById('location').value = `${parseFloat(this.dataset.lat).toFixed(5)}, ${parseFloat(this.dataset.lng).toFixed(5)}`;
                        
                        // Update map marker
                        selectedLocation = {lat: parseFloat(this.dataset.lat), lng: parseFloat(this.dataset.lng)};
                        map.setView([this.dataset.lat, this.dataset.lng], 17);
                        
                        resultsDiv.classList.remove('show');
                    });
                });
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('open');
        }

        function switchTab(tab) {
            const menuTab = document.getElementById('menuTab');
            const restaurantTab = document.getElementById('restaurantTab');
            const menuSection = document.getElementById('menuReviewsSection');
            const restaurantSection = document.getElementById('restaurantReviewsSection');

            if (tab === 'menu') {
                menuTab.classList.add('active');
                restaurantTab.classList.remove('active');
                menuSection.style.display = 'block';
                restaurantSection.style.display = 'none';
                populateMenuReviews();
            } else {
                menuTab.classList.remove('active');
                restaurantTab.classList.add('active');
                menuSection.style.display = 'none';
                restaurantSection.style.display = 'block';
            }
        }

        function switchBottomNav(view) {
            const homeBtn = document.getElementById('bottomNavHome');
            const restaurantsBtn = document.getElementById('bottomNavRestaurants');
            const foodBtn = document.getElementById('bottomNavFood');
            const settingsBtn = document.getElementById('bottomNavSettings');
            const sidebar = document.getElementById('sidebar');
            const restaurantsSidebarView = document.getElementById('restaurantsSidebarView');
            const topDishesView = document.getElementById('topDishesView');
            const mapEl = document.getElementById('map');
            const restaurantsListView = document.getElementById('restaurantsListView');
            const settingsView = document.getElementById('settingsView');
            const floatingHeader = document.querySelector('.header');
            const floatingAddBtn = document.getElementById('floatingAddBtn');
            const demoPinBtn = document.getElementById('demoPinBtn');

            // Reset all buttons
            homeBtn.classList.remove('active');
            restaurantsBtn.classList.remove('active');
            foodBtn.classList.remove('active');
            if (settingsBtn) settingsBtn.classList.remove('active');

            // Hide all views
            sidebar.classList.remove('open');
            document.getElementById('sidebarOverlay').classList.remove('open');
            mapEl.style.display = 'none';
            restaurantsListView.style.display = 'none';
            topDishesView.style.display = 'none';
            if (settingsView) settingsView.style.display = 'none';
            
            // Also hide settings sub-pages
            hideAllSettingsSubPages();

            if (view === 'home') {
                homeBtn.classList.add('active');
                mapEl.style.display = 'block';
                if (floatingHeader) floatingHeader.style.display = 'block';
                if (floatingAddBtn) floatingAddBtn.classList.add('show');
                if (demoPinBtn) demoPinBtn.style.display = 'block';
                const headerIcon = document.querySelector('.header h1 .header-icon');
                if (headerIcon) headerIcon.textContent = 'üçΩÔ∏è';
                
            } else if (view === 'restaurants') {
                restaurantsBtn.classList.add('active');
                restaurantsListView.style.display = 'block';
                if (floatingHeader) floatingHeader.style.display = 'none';
                if (floatingAddBtn) floatingAddBtn.classList.remove('show');
                if (demoPinBtn) demoPinBtn.style.display = 'none';
                populateRestaurantsList();
                
            } else if (view === 'food') {
                foodBtn.classList.add('active');
                topDishesView.style.display = 'block';
                if (floatingHeader) floatingHeader.style.display = 'none';
                if (floatingAddBtn) floatingAddBtn.classList.remove('show');
                if (demoPinBtn) demoPinBtn.style.display = 'none';
                populateTopDishes();
                
            } else if (view === 'settings') {
                settingsBtn.classList.add('active');
                settingsView.style.display = 'block';
                if (floatingHeader) floatingHeader.style.display = 'none';
                if (floatingAddBtn) floatingAddBtn.classList.remove('show');
                if (demoPinBtn) demoPinBtn.style.display = 'none';
            }
        }

        // Settings sub-page navigation
        function hideAllSettingsSubPages() {
            const categoriesView = document.getElementById('settingsCategoriesView');
            const subcategoriesView = document.getElementById('settingsSubcategoriesView');
            const priceRangesView = document.getElementById('settingsPriceRangesView');
            const groupMembersView = document.getElementById('settingsGroupMembersView');
            const inviteMembersView = document.getElementById('settingsInviteMembersView');
            if (categoriesView) categoriesView.style.display = 'none';
            if (subcategoriesView) subcategoriesView.style.display = 'none';
            if (priceRangesView) priceRangesView.style.display = 'none';
            if (groupMembersView) groupMembersView.style.display = 'none';
            if (inviteMembersView) inviteMembersView.style.display = 'none';
        }

        function showSettingsPage(page) {
            const settingsView = document.getElementById('settingsView');
            settingsView.style.display = 'none';
            hideAllSettingsSubPages();

            if (page === 'categories') {
                document.getElementById('settingsCategoriesView').style.display = 'block';
                populateCategoriesList();
            } else if (page === 'subcategories') {
                document.getElementById('settingsSubcategoriesView').style.display = 'block';
                populateSubcategoriesList();
            } else if (page === 'priceranges') {
                document.getElementById('settingsPriceRangesView').style.display = 'block';
                populatePriceRangesList();
            } else if (page === 'groupmembers') {
                document.getElementById('settingsGroupMembersView').style.display = 'block';
                populateGroupMembersList();
            } else if (page === 'invitemembers') {
                document.getElementById('settingsInviteMembersView').style.display = 'block';
                displayCurrentGroupInviteCode();
            }
        }

        function hideSettingsPage(page) {
            hideAllSettingsSubPages();
            document.getElementById('settingsView').style.display = 'block';
        }

        // Group Members functions
        function populateGroupMembersList() {
            const container = document.getElementById('groupMembersList');
            const groupNameEl = document.getElementById('currentGroupName');
            const groupMetaEl = document.getElementById('currentGroupMeta');
            
            // Find current group
            const currentGroup = userGroups.find(g => g.id === currentGroupId) || userGroups[0];
            
            if (!currentGroup) {
                container.innerHTML = '<div class="settings-empty">No group selected</div>';
                return;
            }

            // Update header
            groupNameEl.textContent = currentGroup.name;
            groupMetaEl.textContent = (currentGroup.members || 1) + ' member' + ((currentGroup.members || 1) > 1 ? 's' : '');

            // Members for Darko & Jessica group
            let members;
            if (currentGroup.id === 'group_darko_jessica') {
                members = [
                    { name: 'Darko (You)', role: 'Admin ‚Ä¢ Created group', ratings: Math.floor(currentGroup.ratings / 2), color: 'linear-gradient(135deg, #ff6b6b 0%, #ff8787 100%)', initial: 'D' },
                    { name: 'Jessica', role: 'Member', ratings: Math.ceil(currentGroup.ratings / 2), color: 'linear-gradient(135deg, #fd79a8 0%, #e84393 100%)', initial: 'J' }
                ];
            } else {
                // Default members for other groups
                members = [
                    { name: 'Darko (You)', role: 'Admin ‚Ä¢ Created group', ratings: 0, color: 'linear-gradient(135deg, #ff6b6b 0%, #ff8787 100%)', initial: 'D' }
                ];
            }

            container.innerHTML = members.map(member => `
                <div class="member-card">
                    <div class="member-avatar" style="background: ${member.color};">${member.initial}</div>
                    <div class="member-info">
                        <div class="member-name">${member.name}</div>
                        <div class="member-role">${member.role}</div>
                    </div>
                    <div class="member-stats">
                        <div class="member-stat-value">${member.ratings}</div>
                        <div class="member-stat-label">ratings</div>
                    </div>
                </div>
            `).join('');
        }

        function displayCurrentGroupInviteCode() {
            const codeDisplay = document.getElementById('inviteCodeDisplay');
            const currentGroup = userGroups.find(g => g.id === currentGroupId) || userGroups[0];
            
            if (currentGroup && currentGroup.inviteCode) {
                codeDisplay.textContent = currentGroup.inviteCode;
            } else {
                codeDisplay.textContent = '------';
            }
        }

        function copyCurrentGroupCode() {
            const currentGroup = userGroups.find(g => g.id === currentGroupId) || userGroups[0];
            if (currentGroup && currentGroup.inviteCode) {
                navigator.clipboard.writeText(currentGroup.inviteCode).then(() => {
                    alert('Invite code copied: ' + currentGroup.inviteCode);
                });
            }
        }

        function shareViaWhatsApp() {
            const currentGroup = userGroups.find(g => g.id === currentGroupId) || userGroups[0];
            if (currentGroup) {
                const text = `Join my group "${currentGroup.name}" on Makarska Dining! Use code: ${currentGroup.inviteCode}`;
                window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
            }
        }

        function shareViaEmail() {
            const currentGroup = userGroups.find(g => g.id === currentGroupId) || userGroups[0];
            if (currentGroup) {
                const subject = `Join ${currentGroup.name} on Makarska Dining`;
                const body = `Join my group "${currentGroup.name}" on Makarska Dining!\n\nUse invite code: ${currentGroup.inviteCode}`;
                window.open(`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`, '_blank');
            }
        }

        function shareViaLink() {
            const currentGroup = userGroups.find(g => g.id === currentGroupId) || userGroups[0];
            if (currentGroup) {
                const link = `https://makarska-dining.app/join/${currentGroup.inviteCode}`;
                navigator.clipboard.writeText(link).then(() => {
                    alert('Link copied: ' + link);
                });
            }
        }

        function populateRestaurantsList() {
            const container = document.getElementById('restaurantsListContainer');
            if (!container) return;

            let filteredRestaurants = restaurants;
            
            // Filter by main category
            if (currentRestaurantCategory !== 'all') {
                filteredRestaurants = restaurants.filter(r => r.mainCategory === currentRestaurantCategory);
            }

            // Filter by search query
            const searchInput = document.getElementById('restaurantsSearchInput');
            if (searchInput && searchInput.value.trim()) {
                const query = searchInput.value.trim().toLowerCase();
                filteredRestaurants = filteredRestaurants.filter(r => 
                    r.name.toLowerCase().includes(query) || 
                    r.cuisine.toLowerCase().includes(query)
                );
            }

            const sortedRestaurants = [...filteredRestaurants].sort((a, b) => {
                const avgA = (a.foodRating + a.serviceRating) / 2;
                const avgB = (b.foodRating + b.serviceRating) / 2;
                return avgB - avgA;
            });

            container.innerHTML = '';

            sortedRestaurants.forEach(restaurant => {
                const avgRating = ((restaurant.foodRating + restaurant.serviceRating) / 2).toFixed(1);
                const stars = '‚òÖ'.repeat(Math.round(avgRating));
                const priceSymbol = '‚Ç¨'.repeat(restaurant.price);
                
                const cuisineEmoji = {
                    'Croatian': 'üá≠üá∑',
                    'Seafood': 'üêü',
                    'Italian': 'üçù',
                    'Mediterranean': 'üåä',
                    'Pizza': 'üçï',
                    'Steakhouse': 'ü•©',
                    'Asian': 'ü•¢',
                    'Mexican': 'üåÆ',
                    'Cafe': '‚òï',
                    'International': 'üåç'
                }[restaurant.cuisine] || 'üçΩÔ∏è';

                // Check if restaurant has a cover photo
                const hasCoverPhoto = restaurant.coverPhoto;

                const card = document.createElement('div');
                card.className = 'restaurant-card';
                card.onclick = () => viewRestaurantWithDishes(restaurant.id);
                card.innerHTML = `
                    <div class="restaurant-image-wrapper ${hasCoverPhoto ? 'has-photo' : ''}">
                        ${hasCoverPhoto 
                            ? `<img src="${restaurant.coverPhoto}" alt="${restaurant.name}" class="restaurant-cover-img">`
                            : cuisineEmoji
                        }
                    </div>
                    <div class="restaurant-card-info">
                        <div class="restaurant-card-name">${restaurant.name}</div>
                        <div class="restaurant-card-cuisine">${restaurant.cuisine} ‚Ä¢ ${priceSymbol}</div>
                        <div class="restaurant-card-rating">
                            <span style="color: #ffd700;">${stars}</span>
                            <span style="font-weight: 700;">${avgRating}/5</span>
                        </div>
                        <div class="restaurant-card-footer">
                            <span style="font-size: 12px; color: #636e72;">Last visit: ${new Date(restaurant.visitDate).toLocaleDateString()}</span>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function viewRestaurantWithDishes(id) {
            const restaurant = restaurants.find(r => r.id === id);
            if (!restaurant) return;
            
            currentRestaurantId = id;
            
            const avgRating = ((restaurant.foodRating + restaurant.serviceRating) / 2).toFixed(1);
            const priceSymbol = '‚Ç¨'.repeat(restaurant.price);
            
            // Get actual dishes added for this restaurant
            const restaurantDishes = restaurant.foodItems || [];
            // Get photos for this restaurant (food photos only, not cover)
            const restaurantPhotos = restaurant.photos || [];
            
            // Get cuisine emoji for fallback
            const cuisineEmoji = {
                'Croatian': 'üá≠üá∑',
                'Seafood': 'üêü',
                'Italian': 'üçù',
                'Mediterranean': 'üåä',
                'Pizza': 'üçï',
                'Steakhouse': 'ü•©',
                'Asian': 'ü•¢',
                'Mexican': 'üåÆ',
                'Cafe': '‚òï',
                'International': 'üåç'
            }[restaurant.cuisine] || 'üçΩÔ∏è';

            // Set hero image
            const heroEl = document.getElementById('restaurantHero');
            if (restaurant.coverPhoto) {
                heroEl.innerHTML = `
                    <img src="${restaurant.coverPhoto}" alt="${restaurant.name}">
                    <div class="restaurant-detail-hero-overlay"></div>
                    <div class="restaurant-detail-hero-name">${restaurant.name}</div>
                    <div class="hero-photo-buttons">
                        <button class="hero-photo-btn" onclick="event.stopPropagation(); changeCoverPhotoCamera(${id})">üì∑</button>
                        <button class="hero-photo-btn gallery" onclick="event.stopPropagation(); changeCoverPhotoGallery(${id})">üñºÔ∏è</button>
                    </div>
                    <input type="file" id="coverPhotoCameraInput-${id}" class="photo-upload-input" accept="image/*" capture="environment" onchange="handleCoverPhotoChange(event, ${id})">
                    <input type="file" id="coverPhotoGalleryInput-${id}" class="photo-upload-input" accept="image/*" onchange="handleCoverPhotoChange(event, ${id})">
                `;
            } else {
                heroEl.innerHTML = `
                    <span class="restaurant-detail-hero-emoji">${cuisineEmoji}</span>
                    <div class="restaurant-detail-hero-overlay"></div>
                    <div class="restaurant-detail-hero-name">${restaurant.name}</div>
                    <div class="hero-photo-buttons">
                        <button class="hero-photo-btn add" onclick="event.stopPropagation(); changeCoverPhotoCamera(${id})">üì∑</button>
                        <button class="hero-photo-btn add" onclick="event.stopPropagation(); changeCoverPhotoGallery(${id})">üñºÔ∏è</button>
                    </div>
                    <input type="file" id="coverPhotoCameraInput-${id}" class="photo-upload-input" accept="image/*" capture="environment" onchange="handleCoverPhotoChange(event, ${id})">
                    <input type="file" id="coverPhotoGalleryInput-${id}" class="photo-upload-input" accept="image/*" onchange="handleCoverPhotoChange(event, ${id})">
                `;
            }

            let dishesHtml = '';
            if (restaurantDishes.length > 0) {
                dishesHtml = `
                    <div class="restaurant-dishes-section">
                        <h4 class="restaurant-dishes-title">Added Dishes (${restaurantDishes.length})</h4>
                        ${restaurantDishes.map(dish => {
                            // Determine price category
                            let priceCategory = '';
                            if (dish.price) {
                                const priceNum = parseFloat(dish.price.replace(/[^0-9.,]/g, '').replace(',', '.'));
                                if (!isNaN(priceNum)) {
                                    if (priceNum <= 10) priceCategory = '(Budget)';
                                    else if (priceNum <= 20) priceCategory = '(Mid-range)';
                                    else if (priceNum <= 35) priceCategory = '(Expensive)';
                                    else priceCategory = '(Premium)';
                                }
                            }
                            return `
                            <div class="dish-card">
                                <div class="dish-image-wrapper">
                                    ${dish.photo 
                                        ? `<img src="${dish.photo}" alt="${dish.name}" style="width: 100%; height: 100%; object-fit: cover;">`
                                        : `<div class="dish-image">${getCategoryEmoji(dish.category || 'food')}</div>`
                                    }
                                </div>
                                <div class="dish-info">
                                    <div class="dish-name">${dish.name}</div>
                                    <div class="dish-meta">
                                        ${dish.category ? `<div class="dish-meta-item">${getCategoryEmoji(dish.category)} ${dish.category}</div>` : ''}
                                        ${dish.subcategory ? `<div class="dish-meta-item">‚Ä∫ ${dish.subcategory}</div>` : ''}
                                    </div>
                                    <div class="dish-description">${dish.notes || 'No notes'}</div>
                                    <div class="dish-footer">
                                        <div class="dish-price-info">
                                            <span class="dish-price-label">Price:</span>
                                            <span class="dish-price-value">${dish.price ? dish.price + (dish.price.includes('‚Ç¨') ? '' : ' ‚Ç¨') : '-'}</span>
                                            ${priceCategory ? `<span class="dish-price-category">${priceCategory}</span>` : ''}
                                        </div>
                                        <div class="dish-rating">
                                            <span class="dish-rating-label">Rating:</span>
                                            <span class="dish-rating-emoji">‚≠ê</span>
                                            <span>${dish.foodRating || 0}/5</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                `;
            } else {
                dishesHtml = `
                    <div class="restaurant-dishes-section">
                        <h4 class="restaurant-dishes-title">Added Dishes</h4>
                        <p style="color: #999; font-size: 14px; text-align: center; padding: 16px 0;">No dishes added yet. Use the Food Items tab to add dishes!</p>
                    </div>
                `;
            }

            // Photo gallery section
            let photosHtml = `
                <div class="restaurant-photos-section">
                    <div class="restaurant-photos-header">
                        <h4 class="restaurant-photos-title">üì∏ Food Photos (${restaurantPhotos.length})</h4>
                        <div class="photo-buttons">
                            <button class="add-photo-btn" onclick="triggerCameraCapture(${id})">
                                <span>üì∑</span> Camera
                            </button>
                            <button class="add-photo-btn gallery-btn" onclick="triggerGalleryUpload(${id})">
                                <span>üñºÔ∏è</span> Gallery
                            </button>
                        </div>
                        <input type="file" id="cameraCapture-${id}" class="photo-upload-input" accept="image/*" capture="environment" onchange="handlePhotoCapture(event, ${id})">
                        <input type="file" id="galleryUpload-${id}" class="photo-upload-input" accept="image/*" onchange="handlePhotoCapture(event, ${id})">
                    </div>
                    <div class="photo-gallery">
                        ${restaurantPhotos.length > 0 ? 
                            restaurantPhotos.map((photo, index) => `
                                <div class="photo-item" onclick="openPhotoModalByIndex(${id}, ${index})">
                                    <div class="photo-item-image">
                                        <img src="${typeof photo === 'object' ? photo.url : photo}" alt="Food photo ${index + 1}">
                                    </div>
                                    <div class="photo-item-info">
                                        ${typeof photo === 'object' && photo.dishName ? `<div class="photo-item-name">${photo.dishName}</div>` : ''}
                                        <div class="photo-item-rating">
                                            <span class="stars">${'‚òÖ'.repeat(typeof photo === 'object' ? photo.rating || 0 : 0)}${'‚òÜ'.repeat(5 - (typeof photo === 'object' ? photo.rating || 0 : 0))}</span>
                                            <span class="rating-text">${typeof photo === 'object' && photo.rating ? photo.rating + '/5' : 'Not rated'}</span>
                                        </div>
                                        ${typeof photo === 'object' && photo.price ? `<div class="photo-item-price">${photo.price}</div>` : ''}
                                        <div class="photo-item-date">${typeof photo === 'object' && photo.date ? new Date(photo.date).toLocaleDateString() : ''}</div>
                                    </div>
                                    <button class="photo-item-delete" onclick="event.stopPropagation(); deletePhoto(${id}, ${index})">√ó</button>
                                </div>
                            `).join('') 
                            : `<div class="photo-empty">
                                <div class="photo-empty-icon">üì∑</div>
                                <div>No photos yet</div>
                                <div style="margin-top: 8px; font-size: 12px;">Take a photo of your food or choose from gallery!</div>
                            </div>`
                        }
                    </div>
                </div>
            `;
            
            document.getElementById('restaurantDetails').innerHTML = `
                <div class="restaurant-info">
                    <div class="info-row" style="flex-direction: column; align-items: flex-start; gap: 8px;">
                        <span class="info-label">üìç Adress</span>
                        <input type="text" id="addressInput-${id}" value="${restaurant.address || ''}" 
                            placeholder="Ange adress..." 
                            style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;"
                            onchange="updateAddress(${id}, this.value)">
                        <div style="display: flex; width: 100%; gap: 8px; flex-wrap: wrap;">
                            <button onclick="geocodeRestaurant(${id})" 
                                id="geocodeBtn-${id}"
                                style="flex: 1; min-width: 80px; padding: 10px 12px; background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap;"
                                title="Hitta p√• kartan fr√•n adress">
                                üîç S√∂k
                            </button>
                            <button onclick="editLocation(${id})" 
                                style="flex: 1; min-width: 100px; padding: 10px 12px; background: linear-gradient(135deg, #3498db, #2980b9); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; display: flex; align-items: center; justify-content: center; gap: 6px;">
                                üìç Flytta pin
                            </button>
                        </div>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Cuisine</span>
                        <span class="info-value">${restaurant.cuisine}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Price Range</span>
                        <span class="info-value" style="color: #27ae60; font-weight: 700;">${priceSymbol}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Overall Rating</span>
                        <span class="info-value rating-stars">${'‚òÖ'.repeat(Math.round(avgRating))}${'‚òÜ'.repeat(5 - Math.round(avgRating))} ${avgRating}/5</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Food Quality</span>
                        <span class="info-value rating-stars">${'‚òÖ'.repeat(restaurant.foodRating)}${'‚òÜ'.repeat(5 - restaurant.foodRating)}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Service</span>
                        <span class="info-value rating-stars">${'‚òÖ'.repeat(restaurant.serviceRating)}${'‚òÜ'.repeat(5 - restaurant.serviceRating)}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Last Visit</span>
                        <span class="info-value">${new Date(restaurant.visitDate).toLocaleDateString()}</span>
                    </div>
                </div>
                ${dishesHtml}
                ${photosHtml}
                ${restaurant.notes ? `
                    <div class="notes-section">
                        <h4>Notes</h4>
                        <p>${restaurant.notes}</p>
                    </div>
                ` : ''}
                <button class="delete-btn" onclick="event.stopPropagation(); deleteRestaurant(${id})">Delete Restaurant</button>
            `;
            
            document.getElementById('viewModal').classList.add('open');
        }

        // Category and subcategory definitions
        const categorySubcategories = {
            'restaurant': [
                { id: 'all', label: 'üçΩÔ∏è All', emoji: 'üçΩÔ∏è' },
                { id: 'seafood', label: 'üêü Seafood', emoji: 'üêü' },
                { id: 'meat', label: 'ü•© Meat', emoji: 'ü•©' },
                { id: 'pasta', label: 'üçù Pasta', emoji: 'üçù' },
                { id: 'pizza', label: 'üçï Pizza', emoji: 'üçï' },
                { id: 'salad', label: 'ü•ó Salad', emoji: 'ü•ó' }
            ],
            'dessert': [
                { id: 'all', label: 'üç∞ All', emoji: 'üç∞' },
                { id: 'cake', label: 'üéÇ Cake', emoji: 'üéÇ' },
                { id: 'pastry', label: 'ü•ê Pastry', emoji: 'ü•ê' },
                { id: 'chocolate', label: 'üç´ Chocolate', emoji: 'üç´' },
                { id: 'fruit', label: 'üçì Fruit', emoji: 'üçì' }
            ],
            'icecream': [
                { id: 'all', label: 'üç¶ All', emoji: 'üç¶' },
                { id: 'gelato', label: 'üç® Gelato', emoji: 'üç®' },
                { id: 'sorbet', label: 'üßä Sorbet', emoji: 'üßä' },
                { id: 'sundae', label: 'üçß Sundae', emoji: 'üçß' },
                { id: 'cone', label: 'üç¶ Cone', emoji: 'üç¶' }
            ],
            'drinks': [
                { id: 'all', label: 'üçπ All', emoji: 'üçπ' },
                { id: 'coffee', label: '‚òï Coffee', emoji: '‚òï' },
                { id: 'cocktail', label: 'üç∏ Cocktails', emoji: 'üç∏' },
                { id: 'wine', label: 'üç∑ Wine', emoji: 'üç∑' },
                { id: 'beer', label: 'üç∫ Beer', emoji: 'üç∫' },
                { id: 'juice', label: 'üßÉ Juice', emoji: 'üßÉ' }
            ]
        };

        let currentMainCategory = 'all';
        let currentSubcategory = 'all';

        function selectMainCategory(category) {
            currentMainCategory = category;
            currentSubcategory = 'all';

            // Update main category buttons
            const mainButtons = document.querySelectorAll('#mainCategoryFilters .dish-filter-btn');
            mainButtons.forEach(btn => {
                if (btn.dataset.category === category) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Show/hide subcategories
            const subcategoryContainer = document.getElementById('subcategoryFilters');
            if (category === 'all') {
                subcategoryContainer.style.display = 'none';
            } else {
                subcategoryContainer.style.display = 'flex';
                populateSubcategories(category);
            }

            // Refresh dishes list
            populateTopDishes();
        }

        // Restaurant category filter
        let currentRestaurantCategory = 'all';
        
        function selectRestaurantCategory(category) {
            currentRestaurantCategory = category;

            // Update category buttons
            const buttons = document.querySelectorAll('#restaurantCategoryFilters .dish-filter-btn');
            buttons.forEach(btn => {
                if (btn.dataset.category === category) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Refresh restaurants list
            populateRestaurantsList();
        }

        function populateSubcategories(category) {
            const container = document.getElementById('subcategoryFilters');
            const subcategories = categorySubcategories[category] || [];

            container.innerHTML = subcategories.map(sub => `
                <button class="subcategory-btn ${sub.id === 'all' ? 'active' : ''}" 
                        data-subcategory="${sub.id}"
                        onclick="selectSubcategory('${sub.id}')">
                    ${sub.label}
                </button>
            `).join('');
        }

        function selectSubcategory(subcategory) {
            currentSubcategory = subcategory;

            // Update subcategory buttons
            const subButtons = document.querySelectorAll('#subcategoryFilters .subcategory-btn');
            subButtons.forEach(btn => {
                if (btn.dataset.subcategory === subcategory) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Refresh dishes list
            populateTopDishes();
        }

        function filterRestaurantsList() {
            populateRestaurantsList();
        }

        function filterFoodList() {
            populateTopDishes();
        }

        function populateTopDishes() {
            const dishesList = document.getElementById('dishesList');
            if (!dishesList) return;
            
            // Collect all user-added food items from restaurants
            let allDishes = [];
            
            // Get photos from all restaurants
            restaurants.forEach(restaurant => {
                if (restaurant.photos && restaurant.photos.length > 0) {
                    restaurant.photos.forEach(photo => {
                        if (typeof photo === 'object' && photo.dishName) {
                            allDishes.push({
                                name: photo.dishName,
                                description: photo.caption || '',
                                restaurant: restaurant.name,
                                restaurantId: restaurant.id,
                                mainCategory: photo.category || 'restaurant',
                                category: photo.subcategory || 'all',
                                rating: photo.rating ? photo.rating * 2 : 0, // Convert 5-scale to 10-scale for display
                                price: photo.price || '',
                                emoji: getCategoryEmoji(photo.category),
                                imageUrl: photo.url,
                                date: photo.date,
                                isUserAdded: true
                            });
                        }
                    });
                }
                
                // Also include food items if any
                if (restaurant.foodItems && restaurant.foodItems.length > 0) {
                    restaurant.foodItems.forEach(item => {
                        allDishes.push({
                            name: item.name,
                            description: item.notes || '',
                            restaurant: restaurant.name,
                            restaurantId: restaurant.id,
                            mainCategory: item.category || 'restaurant',
                            category: item.subcategory || 'all',
                            rating: item.foodRating ? item.foodRating * 2 : 0,
                            price: item.price || '',
                            emoji: getCategoryEmoji(item.category),
                            date: item.visitDate,
                            isUserAdded: true
                        });
                    });
                }
            });
            
            // No demo data - only show user's real dishes

            // Filter dishes based on current selections
            let filteredDishes = allDishes;
            
            // Filter by search query
            const searchInput = document.getElementById('foodSearchInput');
            if (searchInput && searchInput.value.trim()) {
                const query = searchInput.value.trim().toLowerCase();
                filteredDishes = filteredDishes.filter(dish => 
                    dish.name.toLowerCase().includes(query) || 
                    dish.restaurant.toLowerCase().includes(query) ||
                    (dish.description && dish.description.toLowerCase().includes(query))
                );
            }
            
            if (currentMainCategory !== 'all') {
                filteredDishes = filteredDishes.filter(dish => dish.mainCategory === currentMainCategory);
                
                if (currentSubcategory !== 'all') {
                    filteredDishes = filteredDishes.filter(dish => dish.category === currentSubcategory);
                }
            }

            // Sort by rating
            filteredDishes.sort((a, b) => b.rating - a.rating);

            dishesList.innerHTML = '';
            
            if (filteredDishes.length === 0) {
                dishesList.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üì∑</div>
                        <div style="font-size: 16px; margin-bottom: 8px;">No items yet</div>
                        <div style="font-size: 14px;">Add photos with ratings from your restaurant visits!</div>
                    </div>
                `;
                return;
            }
            
            try {
                filteredDishes.forEach((dish, index) => {
                    const card = document.createElement('div');
                    card.className = 'dish-card';
                    card.onclick = () => viewDishDetail(dish);
                    
                    // Use image if available, otherwise emoji
                    const imageContent = dish.imageUrl 
                        ? `<img src="${dish.imageUrl}" alt="${dish.name}" style="width: 100%; height: 100%; object-fit: cover;">`
                        : `<div class="dish-image">${dish.emoji}</div>`;
                    
                    card.innerHTML = `
                        <div class="dish-image-wrapper">
                            ${imageContent}
                        </div>
                        <div class="dish-info">
                            <div class="dish-name">${dish.name}</div>
                            <div class="dish-description">${dish.description || 'No notes'}</div>
                            <div class="dish-meta">
                                <div class="dish-meta-item">üìç ${dish.restaurant}</div>
                                <div class="dish-meta-item">üçΩÔ∏è ${dish.category || dish.mainCategory}</div>
                            </div>
                            <div class="dish-footer">
                                <div class="dish-price">${dish.price || '-'}</div>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div class="dish-rating">
                                        <span class="dish-rating-emoji">üòã</span>
                                        <span>${dish.rating.toFixed(1)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    dishesList.appendChild(card);
                });
            } catch (error) {
                console.error('Error populating dishes:', error);
            }
        }
        
        function getCategoryEmoji(category) {
            const emojis = {
                'restaurant': 'üçΩÔ∏è',
                'dessert': 'üç∞',
                'icecream': 'üç®',
                'drinks': 'üçπ',
                'seafood': 'üêü',
                'meat': 'ü•©',
                'pasta': 'üçù',
                'pizza': 'üçï',
                'coffee': '‚òï',
                'beer': 'üç∫',
                'wine': 'üç∑',
                'cocktail': 'üç∏'
            };
            return emojis[category] || 'üçΩÔ∏è';
        }

        function viewDishDetail(dish) {
            try {
                const modal = document.getElementById('dishDetailModal');
                const imageHeader = document.getElementById('dishDetailImage');
                const body = document.getElementById('dishDetailBody');

                if (!modal || !imageHeader || !body) {
                    console.error('Modal elements not found');
                    return;
                }

                // Set image
                imageHeader.textContent = dish.emoji;

                // Calculate ratings - ensure valid values
                const overallRating = dish.rating;
                const overallStars = Math.max(0, Math.min(5, Math.round(overallRating / 2))); // Convert 10-scale to 5-scale
                const foodRating = Math.max(0, Math.min(5, Math.round(overallRating / 2)));
                const serviceRating = Math.max(0, Math.min(5, Math.round((overallRating / 2) - 0.5)));

                // Build detail view
                body.innerHTML = `
                    <h2 class="dish-detail-title">${dish.name}</h2>
                    <div class="dish-detail-restaurant">üìç at ${dish.restaurant}</div>

                    <div class="dish-info-grid">
                        <div class="dish-info-row">
                            <span class="dish-info-label">Category</span>
                            <span class="dish-info-value">${dish.category}</span>
                        </div>
                        <div class="dish-info-row">
                            <span class="dish-info-label">Price</span>
                            <span class="dish-info-value" style="color: #27ae60; font-weight: 700;">${dish.price}</span>
                        </div>
                        <div class="dish-info-row">
                            <span class="dish-info-label">Overall Rating</span>
                            <span class="dish-info-value"><span style="color: #ffd700;">${'‚òÖ'.repeat(overallStars)}${'‚òÜ'.repeat(5 - overallStars)}</span> ${overallRating}/10</span>
                        </div>
                        <div class="dish-info-row">
                            <span class="dish-info-label">Taste</span>
                            <span class="dish-info-value" style="color: #ffd700;">${'‚òÖ'.repeat(foodRating)}${'‚òÜ'.repeat(5 - foodRating)}</span>
                        </div>
                        <div class="dish-info-row">
                            <span class="dish-info-label">Presentation</span>
                            <span class="dish-info-value" style="color: #ffd700;">${'‚òÖ'.repeat(serviceRating)}${'‚òÜ'.repeat(5 - serviceRating)}</span>
                        </div>
                    </div>

                    <div class="dish-notes-section">
                        <h4>Description</h4>
                        <p>${dish.description}</p>
                    </div>
                `;

                modal.style.display = 'block';
            } catch (error) {
                console.error('Error displaying dish detail:', error);
            }
        }

        function closeDishDetail() {
            document.getElementById('dishDetailModal').style.display = 'none';
        }

        function populateMenuReviews() {
            const menuReviewCards = document.getElementById('menuReviewCards');
            
            // Sample menu items from visited restaurants
            const menuItems = [
                {
                    name: "Grilled Sea Bass",
                    restaurant: "Ivo",
                    rating: 5,
                    price: "‚Ç¨24.99",
                    image: "üêü",
                    notes: "Perfectly cooked, fresh from the Adriatic"
                },
                {
                    name: "Black Risotto",
                    restaurant: "Ante",
                    rating: 5,
                    price: "‚Ç¨18.50",
                    image: "üçö",
                    notes: "Rich squid ink flavor, al dente"
                },
                {
                    name: "Margherita Pizza",
                    restaurant: "Pizzeria Mamma Mia",
                    rating: 4,
                    price: "‚Ç¨9.99",
                    image: "üçï",
                    notes: "Simple but delicious wood-fired"
                },
                {
                    name: "Pa≈°ticada",
                    restaurant: "Konoba Kalalarga",
                    rating: 3,
                    price: "‚Ç¨22.00",
                    image: "üçñ",
                    notes: "Traditional Croatian beef stew"
                },
                {
                    name: "Lobster Thermidor",
                    restaurant: "Ribar",
                    rating: 5,
                    price: "‚Ç¨45.00",
                    image: "ü¶û",
                    notes: "Outstanding! Worth every kuna"
                },
                {
                    name: "Tuna Tartare",
                    restaurant: "Bistro Marinero",
                    rating: 5,
                    price: "‚Ç¨16.50",
                    image: "üç£",
                    notes: "Fresh, creative presentation"
                }
            ];

            menuReviewCards.innerHTML = '';
            
            menuItems.forEach(item => {
                const stars = '‚òÖ'.repeat(item.rating) + '‚òÜ'.repeat(5 - item.rating);
                
                const card = document.createElement('div');
                card.className = 'review-card';
                card.innerHTML = `
                    <div class="review-card-image" style="display: flex; align-items: center; justify-content: center; font-size: 60px;">
                        ${item.image}
                    </div>
                    <div class="review-card-content">
                        <div class="review-card-title">${item.name}</div>
                        <div class="review-card-subtitle">at ${item.restaurant}</div>
                        <div class="review-card-footer">
                            <span class="review-card-rating">${stars}</span>
                            <span class="review-card-price">${item.price}</span>
                        </div>
                    </div>
                `;
                
                menuReviewCards.appendChild(card);
            });
        }

        function populateSidebar() {
            // Update restaurant count
            document.getElementById('restaurantCount').textContent = restaurants.length;

            // Populate restaurants list
            const restaurantList = document.getElementById('restaurantList');
            restaurantList.innerHTML = '';
            
            const sortedRestaurants = [...restaurants].sort((a, b) => a.name.localeCompare(b.name));
            
            sortedRestaurants.forEach(restaurant => {
                const avgRating = ((restaurant.foodRating + restaurant.serviceRating) / 2).toFixed(1);
                const priceSymbol = '‚Ç¨'.repeat(restaurant.price);
                const stars = '‚òÖ'.repeat(Math.round(avgRating));
                
                const li = document.createElement('li');
                li.className = 'sidebar-item';
                li.onclick = () => {
                    viewRestaurant(restaurant.id);
                    toggleSidebar();
                    map.setView([restaurant.lat, restaurant.lng], 16);
                };
                
                li.innerHTML = `
                    <div class="sidebar-item-name">${restaurant.name}</div>
                    <div class="sidebar-item-meta">
                        <span class="cuisine-badge" style="border-color: ${cuisineColors[restaurant.cuisine]}20; color: ${cuisineColors[restaurant.cuisine]};">${restaurant.cuisine}</span>
                        <span style="color: #27ae60; font-weight: 700;">${priceSymbol}</span>
                        <span style="color: #ffd700;">${stars}</span>
                        <span>${avgRating}</span>
                    </div>
                `;
                
                restaurantList.appendChild(li);
            });

            // Populate cuisines list
            const cuisineList = document.getElementById('cuisineList');
            cuisineList.innerHTML = '';
            
            const cuisineCounts = {};
            restaurants.forEach(restaurant => {
                cuisineCounts[restaurant.cuisine] = (cuisineCounts[restaurant.cuisine] || 0) + 1;
            });

            Object.entries(cuisineCounts).sort((a, b) => b[1] - a[1]).forEach(([cuisine, count]) => {
                const li = document.createElement('li');
                li.className = 'sidebar-item';
                li.onclick = () => {
                    document.getElementById('filterSelect').value = 'cuisine';
                    currentFilter = 'cuisine';
                    loadMarkers();
                    toggleSidebar();
                    
                    // Filter search to show only this cuisine
                    document.getElementById('searchInput').value = cuisine;
                    const searchEvent = new Event('input', { bubbles: true });
                    document.getElementById('searchInput').dispatchEvent(searchEvent);
                };
                
                li.innerHTML = `
                    <div class="sidebar-item-name" style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="display: flex; align-items: center; gap: 8px;">
                            <span style="width: 12px; height: 12px; background: ${cuisineColors[cuisine]}; border-radius: 50%; display: inline-block;"></span>
                            ${cuisine}
                        </span>
                        <span style="background: ${cuisineColors[cuisine]}20; color: ${cuisineColors[cuisine]}; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 700;">${count}</span>
                    </div>
                `;
                
                cuisineList.appendChild(li);
            });
        }

        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('star')) {
                const ratingType = e.target.dataset.rating;
                const value = e.target.dataset.value;
                const stars = document.querySelectorAll(`[data-rating="${ratingType}"]`);
                
                stars.forEach((star, index) => {
                    if (index < value) {
                        star.classList.add('active');
                    } else {
                        star.classList.remove('active');
                    }
                });
                
                document.getElementById(`${ratingType}Rating`).value = value;
            }
        });

        // Geocode using Google Maps API (works when running locally)
        const GOOGLE_API_KEY = 'AIzaSyDlyFKGOFUYSdFChTse3dZvFnOWU2E94JM';
        
        async function geocodeAddress(address, restaurantName) {
            if (!address) return null;
            
            const searchQuery = `${address}, Makarska, Croatia`;
            
            try {
                // Try Google Geocoding API
                const response = await fetch(
                    `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(searchQuery)}&key=${GOOGLE_API_KEY}`
                );
                const data = await response.json();
                
                if (data.status === 'OK' && data.results && data.results.length > 0) {
                    const location = data.results[0].geometry.location;
                    console.log(`Geocoded "${restaurantName}": ${location.lat}, ${location.lng}`);
                    return {
                        lat: location.lat,
                        lng: location.lng
                    };
                } else {
                    console.error(`Geocoding failed for ${restaurantName}: ${data.status}`);
                }
            } catch (error) {
                console.error(`Geocoding failed for ${restaurantName}:`, error);
                console.log('Tips: K√∂r filen lokalt i din webbl√§sare f√∂r att geocoding ska fungera.');
            }
            return null;
        }

        function loadMarkers() {
            // Remove existing cluster group
            if (markerClusterGroup) {
                map.removeLayer(markerClusterGroup);
            }
            markers = [];
            
            // Create new cluster group
            markerClusterGroup = L.markerClusterGroup({
                maxClusterRadius: 50,
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: false,
                zoomToBoundsOnClick: true,
                iconCreateFunction: function(cluster) {
                    const count = cluster.getChildCount();
                    let size = 40;
                    if (count >= 10) size = 50;
                    if (count >= 50) size = 60;
                    
                    return L.divIcon({
                        html: `<div style="width: ${size}px; height: ${size}px; background: #2d3436; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); border: 3px solid white;">${count}</div>`,
                        className: 'custom-cluster-icon',
                        iconSize: [size, size],
                        iconAnchor: [size/2, size/2]
                    });
                }
            });

            restaurants.forEach(restaurant => {
                const mainCat = restaurant.mainCategory || 'restaurant';
                const icon = mainCategoryIcons[mainCat] || 'üç¥';
                const iconBg = mainCategoryColors[mainCat] || '#ff6b6b';
                const svg = mainCategorySvg[mainCat] || mainCategorySvg['restaurant'];
                const shortName = restaurant.name.length > 12 ? restaurant.name.substring(0, 11) + '‚Ä¶' : restaurant.name;

                let iconHtml;
                let iconSize;
                let iconAnchor;

                if (currentPinStyle === 'circle-dot') {
                    // Circle + Dot style
                    iconHtml = `<div style="display: flex; flex-direction: column; align-items: center;">
                        <div style="width: 50px; height: 50px; background: ${iconBg}; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 16px rgba(0,0,0,0.2); border: 3px solid white;">
                            ${svg}
                        </div>
                        <div style="width: 10px; height: 10px; background: ${iconBg}; border-radius: 50%; margin-top: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>
                    </div>`;
                    iconSize = [56, 70];
                    iconAnchor = [28, 66];
                } else {
                    // Float Card style (default)
                    iconHtml = `<div style="display: flex; align-items: center; background: white; border-radius: 20px; padding: 6px 12px 6px 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); gap: 8px; white-space: nowrap;">
                        <div style="width: 32px; height: 32px; background: ${iconBg}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0;">${icon}</div>
                        <span style="font-size: 12px; font-weight: 700; color: #2d3436;">${shortName}</span>
                    </div>`;
                    iconSize = [140, 44];
                    iconAnchor = [20, 22];
                }

                const emojiIcon = L.divIcon({
                    html: iconHtml,
                    className: 'custom-emoji-icon',
                    iconSize: iconSize,
                    iconAnchor: iconAnchor
                });

                const marker = L.marker([restaurant.lat, restaurant.lng], { icon: emojiIcon });
                marker.restaurantId = restaurant.id;
                marker.on('click', function() {
                    viewRestaurantWithDishes(restaurant.id);
                });

                markers.push(marker);
                markerClusterGroup.addLayer(marker);
            });
            
            map.addLayer(markerClusterGroup);
        }

        const searchInput = document.getElementById('searchInput');
        const searchDropdown = document.getElementById('searchDropdown');
        let activeDropdownIndex = -1;
        
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            
            // Filter markers on map
            markers.forEach((marker, index) => {
                const restaurant = restaurants[index];
                if (restaurant.name.toLowerCase().includes(searchTerm) || 
                    restaurant.notes.toLowerCase().includes(searchTerm) ||
                    restaurant.cuisine.toLowerCase().includes(searchTerm)) {
                    marker.setOpacity(1);
                } else {
                    marker.setOpacity(0.3);
                }
            });
            
            // Show dropdown with suggestions
            if (searchTerm.length >= 1) {
                showSearchSuggestions(searchTerm);
            } else {
                hideSearchDropdown();
            }
        });
        
        searchInput.addEventListener('keydown', function(e) {
            const items = searchDropdown.querySelectorAll('.search-dropdown-item');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                activeDropdownIndex = Math.min(activeDropdownIndex + 1, items.length - 1);
                updateActiveDropdownItem(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                activeDropdownIndex = Math.max(activeDropdownIndex - 1, 0);
                updateActiveDropdownItem(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (activeDropdownIndex >= 0 && items[activeDropdownIndex]) {
                    items[activeDropdownIndex].click();
                }
            } else if (e.key === 'Escape') {
                hideSearchDropdown();
                searchInput.blur();
            }
        });
        
        searchInput.addEventListener('focus', function() {
            const searchTerm = this.value.toLowerCase().trim();
            if (searchTerm.length >= 1) {
                showSearchSuggestions(searchTerm);
            }
        });
        
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.header-search')) {
                hideSearchDropdown();
            }
        });
        
        function showSearchSuggestions(searchTerm) {
            const matchingRestaurants = restaurants.filter(r => 
                r.name.toLowerCase().includes(searchTerm) ||
                r.cuisine.toLowerCase().includes(searchTerm) ||
                r.notes.toLowerCase().includes(searchTerm)
            ).slice(0, 5);
            
            // Get matching cuisines
            const allCuisines = [...new Set(restaurants.map(r => r.cuisine))];
            const matchingCuisines = allCuisines.filter(c => 
                c.toLowerCase().includes(searchTerm)
            ).slice(0, 3);
            
            // Get matching food items from photos
            let matchingDishes = [];
            restaurants.forEach(r => {
                if (r.photos) {
                    r.photos.forEach(photo => {
                        if (typeof photo === 'object' && photo.dishName && 
                            photo.dishName.toLowerCase().includes(searchTerm)) {
                            matchingDishes.push({
                                ...photo,
                                restaurantName: r.name,
                                restaurantId: r.id
                            });
                        }
                    });
                }
            });
            matchingDishes = matchingDishes.slice(0, 3);
            
            if (matchingRestaurants.length === 0 && matchingCuisines.length === 0 && matchingDishes.length === 0) {
                hideSearchDropdown();
                return;
            }
            
            let html = '';
            
            // Restaurants section
            if (matchingRestaurants.length > 0) {
                html += '<div class="search-dropdown-section">Restaurants</div>';
                matchingRestaurants.forEach(r => {
                    const cuisineEmoji = getCuisineEmoji(r.cuisine);
                    const imageContent = r.coverPhoto 
                        ? `<img src="${r.coverPhoto}" alt="${r.name}">`
                        : cuisineEmoji;
                    html += `
                        <div class="search-dropdown-item" onclick="selectSearchRestaurant(${r.id})">
                            <div class="search-dropdown-item-icon">${imageContent}</div>
                            <div class="search-dropdown-item-info">
                                <div class="search-dropdown-item-name">${highlightMatch(r.name, searchTerm)}</div>
                                <div class="search-dropdown-item-meta">
                                    <span>${r.cuisine}</span>
                                    <span>‚≠ê ${((r.foodRating + r.serviceRating) / 2).toFixed(1)}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            // Cuisines section
            if (matchingCuisines.length > 0) {
                html += '<div class="search-dropdown-section">Cuisines</div>';
                matchingCuisines.forEach(c => {
                    const count = restaurants.filter(r => r.cuisine === c).length;
                    html += `
                        <div class="search-dropdown-item" onclick="selectSearchCuisine('${c}')">
                            <div class="search-dropdown-item-icon">${getCuisineEmoji(c)}</div>
                            <div class="search-dropdown-item-info">
                                <div class="search-dropdown-item-name">${highlightMatch(c, searchTerm)}</div>
                                <div class="search-dropdown-item-meta">
                                    <span>${count} restaurant${count !== 1 ? 's' : ''}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            // Dishes section
            if (matchingDishes.length > 0) {
                html += '<div class="search-dropdown-section">Food Items</div>';
                matchingDishes.forEach(d => {
                    html += `
                        <div class="search-dropdown-item" onclick="selectSearchDish(${d.restaurantId})">
                            <div class="search-dropdown-item-icon"><img src="${d.url}" alt="${d.dishName}"></div>
                            <div class="search-dropdown-item-info">
                                <div class="search-dropdown-item-name">${highlightMatch(d.dishName, searchTerm)}</div>
                                <div class="search-dropdown-item-meta">
                                    <span>üìç ${d.restaurantName}</span>
                                    <span>‚≠ê ${d.rating}/5</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            searchDropdown.innerHTML = html;
            searchDropdown.classList.add('show');
            activeDropdownIndex = -1;
        }
        
        function hideSearchDropdown() {
            searchDropdown.classList.remove('show');
            activeDropdownIndex = -1;
        }
        
        function updateActiveDropdownItem(items) {
            items.forEach((item, i) => {
                item.classList.toggle('active', i === activeDropdownIndex);
            });
            if (items[activeDropdownIndex]) {
                items[activeDropdownIndex].scrollIntoView({ block: 'nearest' });
            }
        }
        
        function highlightMatch(text, searchTerm) {
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<strong style="color: #ff6b6b;">$1</strong>');
        }
        
        function getCuisineEmoji(cuisine) {
            const emojis = {
                'Croatian': 'üá≠üá∑',
                'Seafood': 'üêü',
                'Italian': 'üçù',
                'Mediterranean': 'üåä',
                'Pizza': 'üçï',
                'Steakhouse': 'ü•©',
                'Asian': 'ü•¢',
                'Mexican': 'üåÆ',
                'Cafe': '‚òï',
                'International': 'üåç'
            };
            return emojis[cuisine] || 'üçΩÔ∏è';
        }
        
        function selectSearchRestaurant(id) {
            hideSearchDropdown();
            searchInput.value = '';
            // Reset marker opacity
            markers.forEach(m => m.setOpacity(1));
            // Find and open the restaurant
            const restaurant = restaurants.find(r => r.id === id);
            if (restaurant) {
                const markerIndex = restaurants.indexOf(restaurant);
                if (markers[markerIndex]) {
                    map.setView([restaurant.lat, restaurant.lng], 17);
                    markers[markerIndex].openPopup();
                }
            }
        }
        
        function selectSearchCuisine(cuisine) {
            hideSearchDropdown();
            searchInput.value = cuisine;
            // Filter markers
            markers.forEach((marker, index) => {
                const restaurant = restaurants[index];
                marker.setOpacity(restaurant.cuisine === cuisine ? 1 : 0.3);
            });
        }
        
        function selectSearchDish(restaurantId) {
            hideSearchDropdown();
            searchInput.value = '';
            markers.forEach(m => m.setOpacity(1));
            viewRestaurantWithDishes(restaurantId);
        }

        function openAddModal() {
            document.getElementById('addChoiceModal').style.display = 'block';
        }

        function closeAddChoiceModal() {
            document.getElementById('addChoiceModal').style.display = 'none';
        }

        function openAddRestaurantModal() {
            closeAddChoiceModal();
            document.getElementById('addRestaurantModal').style.display = 'block';
            document.getElementById('restaurantForm').reset();
            selectedLocation = null;
            
            // Reset photo section
            resetRestaurantPhotoForm();
            
            // Reset location picker
            resetLocationPicker();
        }

        function closeAddRestaurantModal() {
            document.getElementById('addRestaurantModal').style.display = 'none';
            resetRestaurantPhotoForm();
            resetLocationPicker();
        }

        // Location Picker functions
        let locationPickerMap = null;
        let locationPickerMarker = null;
        let pickedLocation = null;

        function openLocationPicker() {
            const modal = document.getElementById('locationPickerModal');
            modal.classList.add('open');
            
            // Initialize map if not already done
            setTimeout(() => {
                if (!locationPickerMap) {
                    locationPickerMap = L.map('locationPickerMap').setView([43.2965, 17.0175], 14);
                    
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap'
                    }).addTo(locationPickerMap);
                    
                    // Add click handler to map
                    locationPickerMap.on('click', function(e) {
                        placeLocationMarker(e.latlng.lat, e.latlng.lng);
                    });
                } else {
                    locationPickerMap.invalidateSize();
                }
                
                // If we already have a picked location, show it
                if (pickedLocation) {
                    placeLocationMarker(pickedLocation.lat, pickedLocation.lng);
                    locationPickerMap.setView([pickedLocation.lat, pickedLocation.lng], 16);
                }
            }, 100);
        }

        function closeLocationPicker() {
            const modal = document.getElementById('locationPickerModal');
            modal.classList.remove('open');
        }

        function placeLocationMarker(lat, lng) {
            // Remove existing marker
            if (locationPickerMarker) {
                locationPickerMap.removeLayer(locationPickerMarker);
            }
            
            // Create custom pin icon
            const pinIcon = L.divIcon({
                html: '<div style="font-size: 40px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));">üìç</div>',
                className: 'custom-pin-icon',
                iconSize: [40, 40],
                iconAnchor: [20, 40]
            });
            
            // Add new marker
            locationPickerMarker = L.marker([lat, lng], { 
                icon: pinIcon,
                draggable: true 
            }).addTo(locationPickerMap);
            
            // Update on drag
            locationPickerMarker.on('dragend', function(e) {
                const pos = e.target.getLatLng();
                pickedLocation = { lat: pos.lat, lng: pos.lng };
                reverseGeocode(pos.lat, pos.lng);
            });
            
            pickedLocation = { lat, lng };
            
            // Enable confirm button
            document.getElementById('confirmLocationBtn').disabled = false;
            
            // Get address for this location
            reverseGeocode(lat, lng);
        }

        function reverseGeocode(lat, lng) {
            // Show coordinates as fallback immediately
            const coordsText = `üìç ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
            document.getElementById('locationSearchInput').value = coordsText;
            
            // Try to get address using Nominatim (may fail due to CORS)
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`, {
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) throw new Error('Network error');
                return response.json();
            })
            .then(data => {
                if (data && data.display_name) {
                    // Shorten the address
                    const parts = data.display_name.split(',');
                    const shortAddress = parts.slice(0, 3).join(',').trim();
                    document.getElementById('locationSearchInput').value = shortAddress;
                }
            })
            .catch(() => {
                // Silently fail - coordinates are already shown as fallback
            });
        }

        function confirmLocation() {
            if (!pickedLocation) return;
            
            // Update the form fields
            document.getElementById('lat').value = pickedLocation.lat;
            document.getElementById('lng').value = pickedLocation.lng;
            document.getElementById('location').value = document.getElementById('locationSearchInput').value || `${pickedLocation.lat.toFixed(4)}, ${pickedLocation.lng.toFixed(4)}`;
            
            // Update the button text
            const locationBtn = document.querySelector('.location-picker-btn');
            const locationText = document.getElementById('locationText');
            locationText.textContent = document.getElementById('locationSearchInput').value || 'Location selected ‚úì';
            locationBtn.classList.add('has-location');
            
            // Also update selectedLocation for compatibility
            selectedLocation = pickedLocation;
            
            closeLocationPicker();
        }

        function resetLocationPicker() {
            pickedLocation = null;
            if (locationPickerMarker && locationPickerMap) {
                locationPickerMap.removeLayer(locationPickerMarker);
                locationPickerMarker = null;
            }
            
            const locationBtn = document.querySelector('.location-picker-btn');
            const locationText = document.getElementById('locationText');
            if (locationBtn) locationBtn.classList.remove('has-location');
            if (locationText) locationText.textContent = 'Tap to select location on map';
            
            const searchInput = document.getElementById('locationSearchInput');
            if (searchInput) searchInput.value = '';
            
            const confirmBtn = document.getElementById('confirmLocationBtn');
            if (confirmBtn) confirmBtn.disabled = true;
        }

        // Location search functionality
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('locationSearchInput');
            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', function(e) {
                    clearTimeout(searchTimeout);
                    const query = e.target.value.trim();
                    
                    if (query.length < 3) return;
                    
                    searchTimeout = setTimeout(() => {
                        // Search using Nominatim
                        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ' Makarska Croatia')}&limit=1`, {
                            headers: {
                                'Accept': 'application/json'
                            }
                        })
                        .then(response => {
                            if (!response.ok) throw new Error('Network error');
                            return response.json();
                        })
                        .then(data => {
                            if (data && data.length > 0) {
                                const result = data[0];
                                const lat = parseFloat(result.lat);
                                const lng = parseFloat(result.lon);
                                
                                locationPickerMap.setView([lat, lng], 17);
                                placeLocationMarker(lat, lng);
                            }
                        })
                        .catch(() => {
                            // Silently fail - user can still tap on map
                        });
                    }, 500);
                });
            }
        });

        // Restaurant photo functions
        function triggerRestaurantCamera() {
            document.getElementById('restaurantCameraInput').click();
        }

        function triggerRestaurantGallery() {
            document.getElementById('restaurantGalleryInput').click();
        }

        function handleRestaurantPhotoSelect(event) {
            try {
                const file = event.target.files && event.target.files[0];
                if (!file) {
                    event.target.value = '';
                    return;
                }

                // Check file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('Photo is too large. Please select an image under 5MB.');
                    event.target.value = '';
                    return;
                }

                // Check file type
                if (!file.type || !file.type.startsWith('image/')) {
                    alert('Please select an image file.');
                    event.target.value = '';
                    return;
                }

                const reader = new FileReader();
                
                reader.onerror = function() {
                    alert('Error reading photo. Please try again.');
                    event.target.value = '';
                };
                
                reader.onload = function(e) {
                    try {
                        // Compress and show preview
                        compressImage(e.target.result, 800, 0.8, function(compressedImage) {
                            showRestaurantPhotoPreview(compressedImage);
                        });
                    } catch (err) {
                        alert('Error processing photo. Please try again.');
                    }
                };
                reader.readAsDataURL(file);
                
                // Reset the input
                event.target.value = '';
            } catch (err) {
                alert('Error with photo. Please try again.');
                if (event.target) event.target.value = '';
            }
        }

        function showRestaurantPhotoPreview(imageData) {
            const previewContainer = document.getElementById('restaurantPhotoPreview');
            const photoDataInput = document.getElementById('restaurantPhotoData');
            const removeBtn = document.getElementById('removeRestaurantPhotoBtn');

            previewContainer.innerHTML = `<img src="${imageData}" alt="Restaurant photo preview">`;
            photoDataInput.value = imageData;
            removeBtn.style.display = 'flex';
        }

        function removeRestaurantPhoto() {
            const previewContainer = document.getElementById('restaurantPhotoPreview');
            const photoDataInput = document.getElementById('restaurantPhotoData');
            const removeBtn = document.getElementById('removeRestaurantPhotoBtn');

            previewContainer.innerHTML = `
                <div class="food-photo-empty">
                    <span>üè™</span>
                    <span>No photo added</span>
                </div>
            `;
            photoDataInput.value = '';
            removeBtn.style.display = 'none';
        }

        function resetRestaurantPhotoForm() {
            removeRestaurantPhoto();
            const cameraInput = document.getElementById('restaurantCameraInput');
            const galleryInput = document.getElementById('restaurantGalleryInput');
            if (cameraInput) cameraInput.value = '';
            if (galleryInput) galleryInput.value = '';
        }

        function openAddFoodModal() {
            closeAddChoiceModal();
            document.getElementById('addFoodModal').style.display = 'block';
            document.getElementById('foodForm').reset();
            document.querySelectorAll('.star').forEach(star => star.classList.remove('active'));
            document.getElementById('visitDate').valueAsDate = new Date();
            
            // Reset photo section
            resetFoodPhotoForm();
            
            // Populate restaurant dropdown
            const select = document.getElementById('foodRestaurant');
            select.innerHTML = '<option value="">Choose a restaurant...</option>';
            restaurants.forEach(r => {
                select.innerHTML += `<option value="${r.id}">${r.name}</option>`;
            });
            
            // Populate category dropdown
            const catSelect = document.getElementById('foodCategory');
            catSelect.innerHTML = '<option value="">Choose category...</option>';
            const categories = JSON.parse(localStorage.getItem('customCategories')) || [
                { id: 'food', name: 'Food', emoji: 'üçΩÔ∏è' },
                { id: 'drinks', name: 'Drinks', emoji: 'üç∫' },
                { id: 'ice-cream', name: 'Ice Cream', emoji: 'üç¶' }
            ];
            categories.forEach(cat => {
                catSelect.innerHTML += `<option value="${cat.id}">${cat.emoji} ${cat.name}</option>`;
            });
            
            // Hide subcategory initially
            document.getElementById('foodSubcategoryGroup').style.display = 'none';
        }
        
        function populateFoodSubcategories() {
            const category = document.getElementById('foodCategory').value;
            const subGroup = document.getElementById('foodSubcategoryGroup');
            const subSelect = document.getElementById('foodSubcategory');
            
            const subcategories = JSON.parse(localStorage.getItem('customSubcategories')) || [
                { id: 'pasta', name: 'Pasta', parentId: 'food' },
                { id: 'pizza', name: 'Pizza', parentId: 'food' },
                { id: 'seafood', name: 'Seafood', parentId: 'food' },
                { id: 'meat', name: 'Meat', parentId: 'food' },
                { id: 'salad', name: 'Salad', parentId: 'food' },
                { id: 'dessert', name: 'Dessert', parentId: 'food' },
                { id: 'beer', name: 'Beer', parentId: 'drinks' },
                { id: 'wine', name: 'Wine', parentId: 'drinks' },
                { id: 'cocktail', name: 'Cocktail', parentId: 'drinks' },
                { id: 'coffee', name: 'Coffee', parentId: 'drinks' },
                { id: 'gelato', name: 'Gelato', parentId: 'ice-cream' },
                { id: 'sorbet', name: 'Sorbet', parentId: 'ice-cream' }
            ];
            
            const filtered = subcategories.filter(s => s.parentId === category);
            
            if (filtered.length > 0) {
                subSelect.innerHTML = '<option value="">Choose subcategory...</option>';
                filtered.forEach(sub => {
                    subSelect.innerHTML += `<option value="${sub.id}">${sub.name}</option>`;
                });
                subGroup.style.display = 'block';
            } else {
                subGroup.style.display = 'none';
            }
        }

        function closeAddFoodModal() {
            document.getElementById('addFoodModal').style.display = 'none';
            resetFoodPhotoForm();
        }

        function closeAddModal() {
            closeAddChoiceModal();
            closeAddRestaurantModal();
            closeAddFoodModal();
        }

        function closeViewModal() {
            document.getElementById('viewModal').classList.remove('open');
        }

        // Update address for a restaurant
        async function updateAddress(id, newAddress) {
            const restaurant = restaurants.find(r => r.id === id);
            if (restaurant) {
                restaurant.address = newAddress;
                saveRestaurants();
                
                // Auto-geocode if address is long enough
                if (newAddress && newAddress.length > 5) {
                    await geocodeRestaurant(id);
                }
            }
        }
        
        async function geocodeRestaurant(id) {
            const restaurant = restaurants.find(r => r.id === id);
            if (!restaurant || !restaurant.address) {
                alert('Ange en adress f√∂rst');
                return;
            }
            
            const btn = document.getElementById(`geocodeBtn-${id}`);
            const input = document.getElementById(`addressInput-${id}`);
            
            // Show loading state
            if (btn) {
                btn.textContent = '‚è≥';
                btn.disabled = true;
            }
            if (input) {
                input.style.background = '#fffbea';
            }
            
            const coords = await geocodeAddress(restaurant.address, restaurant.name);
            
            if (coords) {
                restaurant.lat = coords.lat;
                restaurant.lng = coords.lng;
                saveRestaurants();
                loadMarkers();
                
                // Success feedback
                if (btn) {
                    btn.textContent = '‚úÖ';
                    setTimeout(() => { btn.textContent = 'üîç'; btn.disabled = false; }, 1500);
                }
                if (input) {
                    input.style.background = '#e8f5e9';
                    setTimeout(() => { input.style.background = ''; }, 2000);
                }
                
                alert(`‚úÖ "${restaurant.name}" placerad p√• kartan!\n\nAdress: ${restaurant.address}`);
            } else {
                // Error feedback
                if (btn) {
                    btn.textContent = '‚ùå';
                    setTimeout(() => { btn.textContent = 'üîç'; btn.disabled = false; }, 1500);
                }
                if (input) {
                    input.style.background = '#ffebee';
                    setTimeout(() => { input.style.background = ''; }, 2000);
                }
                
                alert(`‚ùå Kunde inte hitta "${restaurant.address}" p√• kartan.\n\nTips: L√§gg till "Makarska" i adressen eller anv√§nd "Flytta pin" f√∂r att placera manuellt.`);
            }
        }

        // Edit location - allow user to click on map to set new coordinates
        let editingLocationId = null;
        
        function editLocation(id) {
            editingLocationId = id;
            const restaurant = restaurants.find(r => r.id === id);
            
            closeViewModal();
            switchTab('map');
            
            const overlay = document.createElement('div');
            overlay.id = 'locationEditOverlay';
            overlay.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 16px 20px; z-index: 10000; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                    <div style="font-weight: 700; font-size: 16px; margin-bottom: 4px;">üìç Flytta pin f√∂r "${restaurant.name}"</div>
                    <div style="font-size: 13px; opacity: 0.9;">Klicka p√• kartan d√§r restaurangen ligger</div>
                    <button onclick="cancelLocationEdit()" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 20px; font-size: 13px; cursor: pointer;">‚úï Avbryt</button>
                </div>
            `;
            document.body.appendChild(overlay);
            
            if (restaurant.lat && restaurant.lng) {
                map.setView([restaurant.lat, restaurant.lng], 17);
            }
            
            map.once('click', function(e) {
                if (editingLocationId) {
                    const r = restaurants.find(r => r.id === editingLocationId);
                    if (r) {
                        r.lat = e.latlng.lat;
                        r.lng = e.latlng.lng;
                        saveRestaurants();
                        loadMarkers();
                        alert(`‚úÖ Pin f√∂r "${r.name}" har flyttats!\n\nAdress: ${r.address || 'Ej angiven'}`);
                    }
                    cancelLocationEdit();
                }
            });
        }
        
        function cancelLocationEdit() {
            editingLocationId = null;
            const overlay = document.getElementById('locationEditOverlay');
            if (overlay) overlay.remove();
        }

        function openDemoMenu() {
            document.getElementById('demoModal').style.display = 'block';
            selectedPinType = currentPinStyle;
            
            document.querySelectorAll('.pin-option').forEach(option => {
                if (option.dataset.pinType === currentPinStyle) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
        }

        function closeDemoMenu() {
            document.getElementById('demoModal').style.display = 'none';
        }

        function selectPin(type) {
            selectedPinType = type;
            currentPinStyle = type;
            localStorage.setItem('pinStyle', currentPinStyle);
            
            document.querySelectorAll('.pin-option').forEach(option => {
                if (option.dataset.pinType === type) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
            
            // Apply immediately
            loadMarkers();
        }

        function applyPinStyle() {
            currentPinStyle = selectedPinType;
            localStorage.setItem('pinStyle', currentPinStyle);
            loadMarkers();
            closeDemoMenu();
        }

        function applyFilter() {
            currentFilter = document.getElementById('filterSelect').value;
            loadMarkers();
        }

        // ========== REACT-STYLE FILTER (Simple & Direct) ==========
        // State: empty array = show all
        let filterMainCategory = 'all';
        let selectedRatings = [];
        let selectedPrices = [];

        // Core filter function - runs instantly on any change
        function getFilteredRestaurants() {
            return restaurants.filter(r => {
                // Type/Category match
                const restaurantType = r.mainCategory || 'restaurant';
                const typeMatch = filterMainCategory === 'all' || restaurantType === filterMainCategory;

                // Subcategory match (e.g., Seafood within Restaurant)
                let subcategoryMatch = true;
                if (filterSubcategory !== 'all' && filterMainCategory !== 'all') {
                    // Check if restaurant has dishes with this subcategory
                    if (r.foodItems && r.foodItems.length > 0) {
                        // foodItems use 'category' field, not 'subcategory'
                        subcategoryMatch = r.foodItems.some(item => item.category === filterSubcategory);
                    }
                    // Also check photos array (they have 'category' or 'subcategory' field)
                    if (!subcategoryMatch && r.photos && r.photos.length > 0) {
                        subcategoryMatch = r.photos.some(photo =>
                            photo.category === filterSubcategory ||
                            photo.subcategory === filterSubcategory
                        );
                    }
                    // Fallback: check cuisine field
                    if (!subcategoryMatch && r.cuisine) {
                        subcategoryMatch = r.cuisine.toLowerCase().includes(filterSubcategory.toLowerCase());
                    }
                }

                // Rating match (empty = show all)
                const avgRating = Math.round(((r.foodRating || 0) + (r.serviceRating || 0)) / 2) || 0;
                const ratingMatch = selectedRatings.length === 0 || selectedRatings.includes(avgRating);

                // Price match (empty = show all)
                const priceMatch = selectedPrices.length === 0 || selectedPrices.includes(r.price);

                return typeMatch && subcategoryMatch && ratingMatch && priceMatch;
            });
        }

        // Apply filter and update map - call this on every filter change
        function applyFilterAndUpdateMap() {
            const filtered = getFilteredRestaurants();

            // Dynamic display flags (like React reference)
            const showRating = selectedRatings.length > 0;
            const showPrice = selectedPrices.length > 0;

            // Clear existing markers
            if (markerClusterGroup) {
                markerClusterGroup.clearLayers();
            }
            markers = [];

            // Add filtered markers with ADAPTIVE pin style
            filtered.forEach(restaurant => {
                const mainCat = restaurant.mainCategory || 'restaurant';
                const icon = mainCategoryIcons[mainCat] || 'üç¥';
                const iconBg = mainCategoryColors[mainCat] || '#ff6b6b';
                const svg = mainCategorySvg[mainCat] || mainCategorySvg['restaurant'];
                const avgRating = Math.round(((restaurant.foodRating || 0) + (restaurant.serviceRating || 0)) / 2) || 0;
                const price = restaurant.price || 1;

                // Price color based on level (like React)
                const priceColor = price === 1 ? '#4ade80' : price === 2 ? '#facc15' : price === 3 ? '#f97316' : '#ef4444';
                const priceSymbol = '‚Ç¨'.repeat(price);
                const ratingStars = '‚òÖ'.repeat(avgRating);

                // Build ADAPTIVE pin HTML based on active filters AND pin style
                let iconHtml;
                let iconSize;
                let iconAnchor;

                if (currentPinStyle === 'circle-dot') {
                    // === CIRCLE + DOT STYLE ===
                    // Build badge HTML based on active filters
                    let priceBadge = '';
                    let ratingBadge = '';

                    if (showPrice) {
                        priceBadge = `<div style="position: absolute; top: -4px; right: -8px; background: ${priceColor}; color: white; font-size: 9px; font-weight: 700; padding: 3px 5px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">${priceSymbol}</div>`;
                    }
                    if (showRating) {
                        ratingBadge = `<div style="position: absolute; top: -4px; left: -8px; background: #fbbf24; color: white; font-size: 9px; font-weight: 700; padding: 3px 5px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 2px;">
                            <svg width="8" height="8" viewBox="0 0 24 24" fill="white"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>${avgRating.toFixed(1)}
                        </div>`;
                    }

                    iconHtml = `<div style="display: flex; flex-direction: column; align-items: center;">
                        <div style="position: relative;">
                            <div style="width: 50px; height: 50px; background: ${iconBg}; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 16px rgba(0,0,0,0.2); border: 3px solid white;">
                                ${svg}
                            </div>
                            ${priceBadge}
                            ${ratingBadge}
                        </div>
                        <div style="width: 10px; height: 10px; background: ${iconBg}; border-radius: 50%; margin-top: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>
                    </div>`;
                    iconSize = [70, 70];
                    iconAnchor = [35, 66];
                } else {
                    // === FLOAT CARD STYLE (default) - Light theme, no border ===
                    if (!showRating && !showPrice) {
                        // Default: Icon + name (white background)
                        const shortName = restaurant.name.length > 10 ? restaurant.name.substring(0, 9) + '‚Ä¶' : restaurant.name;
                        iconHtml = `<div style="display: flex; align-items: center; background: white; border-radius: 20px; padding: 6px 12px 6px 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); gap: 8px; white-space: nowrap;">
                            <div style="width: 32px; height: 32px; background: ${iconBg}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0;">${icon}</div>
                            <span style="font-size: 12px; font-weight: 700; color: #2d3436;">${shortName}</span>
                        </div>`;
                    } else if (showRating && !showPrice) {
                        // Rating filter active: Light theme + icon + rating stars
                        iconHtml = `<div style="display: flex; align-items: center; background: white; border-radius: 20px; padding: 6px 12px 6px 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); gap: 8px; white-space: nowrap;">
                            <div style="width: 32px; height: 32px; background: ${iconBg}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0;">${icon}</div>
                            <span style="color: #f59e0b; font-size: 13px; font-weight: 700;">${ratingStars}</span>
                        </div>`;
                    } else if (!showRating && showPrice) {
                        // Price filter active: Light theme + icon + price
                        iconHtml = `<div style="display: flex; align-items: center; background: white; border-radius: 20px; padding: 6px 12px 6px 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); gap: 8px; white-space: nowrap;">
                            <div style="width: 32px; height: 32px; background: ${iconBg}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0;">${icon}</div>
                            <span style="color: ${priceColor}; font-size: 13px; font-weight: 700;">${priceSymbol}</span>
                        </div>`;
                    } else {
                        // Both filters active: Light theme + icon + rating + price stacked
                        iconHtml = `<div style="display: flex; align-items: center; background: white; border-radius: 20px; padding: 6px 12px 6px 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); gap: 8px; white-space: nowrap;">
                            <div style="width: 32px; height: 32px; background: ${iconBg}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0;">${icon}</div>
                            <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 1px;">
                                <span style="color: #f59e0b; font-size: 10px; font-weight: 700;">${ratingStars}</span>
                                <span style="color: ${priceColor}; font-size: 11px; font-weight: 700;">${priceSymbol}</span>
                            </div>
                        </div>`;
                    }
                    iconSize = [160, 50];
                    iconAnchor = [25, 25];
                }

                const emojiIcon = L.divIcon({
                    html: iconHtml,
                    className: 'custom-emoji-icon',
                    iconSize: iconSize,
                    iconAnchor: iconAnchor
                });

                const marker = L.marker([restaurant.lat, restaurant.lng], { icon: emojiIcon });
                marker.restaurantId = restaurant.id;
                marker.on('click', function() {
                    viewRestaurantWithDishes(restaurant.id);
                });

                markers.push(marker);
                markerClusterGroup.addLayer(marker);
            });

            // Update count display
            const countEl = document.getElementById('filterResultCount');
            if (countEl) {
                if (filtered.length === restaurants.length) {
                    countEl.innerHTML = `<span style="color: #27ae60;">Showing all ${filtered.length}</span>`;
                } else if (filtered.length === 0) {
                    countEl.innerHTML = `<span style="color: #ff6b6b;">No matches</span>`;
                } else {
                    countEl.innerHTML = `<span style="color: #ff6b6b; font-weight: 600;">${filtered.length}</span> of ${restaurants.length}`;
                }
            }

            console.log('Filter applied:', { filterMainCategory, selectedRatings, selectedPrices, showRating, showPrice, showing: filtered.length });
        }

        // Filter subcategory state
        let filterSubcategory = 'all';

        // Filter subcategories (same as top dishes)
        const filterSubcategories = {
            'restaurant': [
                { id: 'all', label: 'üçΩÔ∏è All' },
                { id: 'seafood', label: 'üêü Seafood' },
                { id: 'meat', label: 'ü•© Meat' },
                { id: 'pasta', label: 'üçù Pasta' },
                { id: 'pizza', label: 'üçï Pizza' },
                { id: 'salad', label: 'ü•ó Salad' }
            ],
            'dessert': [
                { id: 'all', label: 'üç∞ All' },
                { id: 'cake', label: 'üéÇ Cake' },
                { id: 'pastry', label: 'ü•ê Pastry' },
                { id: 'chocolate', label: 'üç´ Chocolate' },
                { id: 'fruit', label: 'üçì Fruit' }
            ],
            'icecream': [
                { id: 'all', label: 'üç¶ All' },
                { id: 'gelato', label: 'üç® Gelato' },
                { id: 'sorbet', label: 'üßä Sorbet' },
                { id: 'sundae', label: 'üçß Sundae' },
                { id: 'cone', label: 'üç¶ Cone' }
            ],
            'drinks': [
                { id: 'all', label: 'üçπ All' },
                { id: 'coffee', label: '‚òï Coffee' },
                { id: 'cocktail', label: 'üç∏ Cocktails' },
                { id: 'wine', label: 'üç∑ Wine' },
                { id: 'beer', label: 'üç∫ Beer' },
                { id: 'juice', label: 'üßÉ Juice' }
            ]
        };

        function openFilterModal() {
            document.getElementById('filterModal').classList.add('open');
            updateFilterPreview(); // Show current filter count
        }

        function closeFilterModal() {
            document.getElementById('filterModal').classList.remove('open');
        }

        function selectFilterMainCategory(category) {
            filterMainCategory = category;
            filterSubcategory = 'all';

            // Update main category buttons
            const mainButtons = document.querySelectorAll('#filterMainCategories .filter-category-btn');
            mainButtons.forEach(btn => {
                if (btn.dataset.category === category) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Show/hide subcategories
            const subcategorySection = document.getElementById('filterSubcategorySection');
            if (category === 'all') {
                subcategorySection.style.display = 'none';
            } else {
                subcategorySection.style.display = 'block';
                populateFilterSubcategories(category);
            }

            // Update price filters based on category
            updatePriceFilters(category);

            // INSTANT FILTER - Apply immediately!
            applyFilterAndUpdateMap();
        }
        
        function updatePriceFilters(category, subcategory = null) {
            const priceContainer = document.getElementById('filterPriceChips');
            const priceTitle = document.getElementById('filterPriceTitle');
            
            let priceOptions = [];
            
            if (category === 'icecream') {
                priceTitle.textContent = 'Price (Ice Cream)';
                priceOptions = [
                    { value: 1, label: '‚Ç¨', desc: 'Under ‚Ç¨3' },
                    { value: 2, label: '‚Ç¨‚Ç¨', desc: '‚Ç¨3-5' },
                    { value: 3, label: '‚Ç¨‚Ç¨‚Ç¨', desc: '‚Ç¨5-8' },
                    { value: 4, label: '‚Ç¨‚Ç¨‚Ç¨‚Ç¨', desc: '‚Ç¨8+' }
                ];
            } else if (category === 'dessert') {
                priceTitle.textContent = 'Price (Dessert)';
                priceOptions = [
                    { value: 1, label: '‚Ç¨', desc: 'Under ‚Ç¨5' },
                    { value: 2, label: '‚Ç¨‚Ç¨', desc: '‚Ç¨5-10' },
                    { value: 3, label: '‚Ç¨‚Ç¨‚Ç¨', desc: '‚Ç¨10-15' },
                    { value: 4, label: '‚Ç¨‚Ç¨‚Ç¨‚Ç¨', desc: '‚Ç¨15+' }
                ];
            } else if (category === 'drinks') {
                priceTitle.textContent = 'Price (Drinks)';
                if (subcategory === 'wine') {
                    priceOptions = [
                        { value: 1, label: 'üç∑', desc: 'Under ‚Ç¨5/glass' },
                        { value: 2, label: 'üç∑üç∑', desc: '‚Ç¨5-10/glass' },
                        { value: 3, label: 'üç∑üç∑üç∑', desc: '‚Ç¨10-20/glass' },
                        { value: 4, label: 'üç∑üç∑üç∑üç∑', desc: '‚Ç¨20+/bottle' }
                    ];
                } else if (subcategory === 'beer') {
                    priceOptions = [
                        { value: 1, label: 'üç∫', desc: 'Under ‚Ç¨3' },
                        { value: 2, label: 'üç∫üç∫', desc: '‚Ç¨3-5' },
                        { value: 3, label: 'üç∫üç∫üç∫', desc: '‚Ç¨5-8' },
                        { value: 4, label: 'üç∫üç∫üç∫üç∫', desc: '‚Ç¨8+' }
                    ];
                } else if (subcategory === 'cocktail' || subcategory === 'cocktails') {
                    priceOptions = [
                        { value: 1, label: 'üçπ', desc: 'Under ‚Ç¨8' },
                        { value: 2, label: 'üçπüçπ', desc: '‚Ç¨8-12' },
                        { value: 3, label: 'üçπüçπüçπ', desc: '‚Ç¨12-18' },
                        { value: 4, label: 'üçπüçπüçπüçπ', desc: '‚Ç¨18+' }
                    ];
                } else if (subcategory === 'coffee') {
                    priceOptions = [
                        { value: 1, label: '‚òï', desc: 'Under ‚Ç¨2' },
                        { value: 2, label: '‚òï‚òï', desc: '‚Ç¨2-4' },
                        { value: 3, label: '‚òï‚òï‚òï', desc: '‚Ç¨4-6' },
                        { value: 4, label: '‚òï‚òï‚òï‚òï', desc: '‚Ç¨6+' }
                    ];
                } else {
                    priceOptions = [
                        { value: 1, label: '‚Ç¨', desc: 'Under ‚Ç¨4' },
                        { value: 2, label: '‚Ç¨‚Ç¨', desc: '‚Ç¨4-8' },
                        { value: 3, label: '‚Ç¨‚Ç¨‚Ç¨', desc: '‚Ç¨8-15' },
                        { value: 4, label: '‚Ç¨‚Ç¨‚Ç¨‚Ç¨', desc: '‚Ç¨15+' }
                    ];
                }
            } else {
                // Restaurant / All
                priceTitle.textContent = 'Price (Food)';
                priceOptions = [
                    { value: 1, label: '‚Ç¨', desc: 'Under ‚Ç¨15' },
                    { value: 2, label: '‚Ç¨‚Ç¨', desc: '‚Ç¨15-30' },
                    { value: 3, label: '‚Ç¨‚Ç¨‚Ç¨', desc: '‚Ç¨30-60' },
                    { value: 4, label: '‚Ç¨‚Ç¨‚Ç¨‚Ç¨', desc: '‚Ç¨60+' }
                ];
            }
            
            priceContainer.innerHTML = priceOptions.map(opt => `
                <button class="price-chip" onclick="togglePrice(this, ${opt.value})">
                    ${opt.label} <small>${opt.desc}</small>
                </button>
            `).join('');
        }

        function populateFilterSubcategories(category) {
            const container = document.getElementById('filterSubcategories');
            const subcategories = filterSubcategories[category] || [];

            container.innerHTML = subcategories.map(sub => `
                <button class="filter-subcategory-btn ${sub.id === 'all' ? 'active' : ''}" 
                        data-subcategory="${sub.id}"
                        onclick="selectFilterSubcategory('${sub.id}')">
                    ${sub.label}
                </button>
            `).join('');
        }

        function selectFilterSubcategory(subcategory) {
            filterSubcategory = subcategory;

            // Update subcategory buttons
            const subButtons = document.querySelectorAll('#filterSubcategories .filter-subcategory-btn');
            subButtons.forEach(btn => {
                if (btn.dataset.subcategory === subcategory) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Update price filters for drinks subcategories
            const activeMainCategory = document.querySelector('#filterMainCategories .filter-category-btn.active');
            if (activeMainCategory && activeMainCategory.dataset.category === 'drinks') {
                updatePriceFilters('drinks', subcategory);
            }

            // Real-time preview
            updateFilterPreview();
        }

        function toggleRating(chipElement, rating) {
            chipElement.classList.toggle('active');
            const index = selectedRatings.indexOf(rating);
            if (index > -1) {
                selectedRatings.splice(index, 1);
            } else {
                selectedRatings.push(rating);
            }
            // INSTANT FILTER - Apply immediately!
            applyFilterAndUpdateMap();
        }

        function togglePrice(chipElement, price) {
            chipElement.classList.toggle('active');
            const index = selectedPrices.indexOf(price);
            if (index > -1) {
                selectedPrices.splice(index, 1);
            } else {
                selectedPrices.push(price);
            }
            // INSTANT FILTER - Apply immediately!
            applyFilterAndUpdateMap();
        }

        // Real-time filter preview - shows count without applying
        function updateFilterPreview() {
            const count = restaurants.filter(restaurant => {
                // Default to 'restaurant' if mainCategory is missing (for old data)
                const restaurantCategory = restaurant.mainCategory || 'restaurant';
                const categoryMatch = filterMainCategory === 'all' || restaurantCategory === filterMainCategory;

                let subcategoryMatch = true;
                if (filterSubcategory !== 'all' && filterMainCategory !== 'all') {
                    if (restaurant.foodItems && restaurant.foodItems.length > 0) {
                        subcategoryMatch = restaurant.foodItems.some(item => item.subcategory === filterSubcategory);
                    } else {
                        subcategoryMatch = false;
                    }
                }

                let ratingMatch = true;
                if (selectedRatings.length > 0) {
                    const avgRating = Math.round((restaurant.foodRating + restaurant.serviceRating) / 2);
                    ratingMatch = selectedRatings.includes(avgRating);
                }

                let priceMatch = true;
                if (selectedPrices.length > 0) {
                    priceMatch = selectedPrices.includes(restaurant.price);
                }

                return categoryMatch && subcategoryMatch && ratingMatch && priceMatch;
            }).length;

            const countEl = document.getElementById('filterResultCount');
            if (countEl) {
                if (count === restaurants.length) {
                    countEl.innerHTML = `<span style="color: #27ae60;">Showing all ${count} restaurants</span>`;
                } else if (count === 0) {
                    countEl.innerHTML = `<span style="color: #ff6b6b;">No restaurants match</span>`;
                } else {
                    countEl.innerHTML = `<span style="color: #ff6b6b; font-weight: 600;">${count}</span> of ${restaurants.length} restaurants`;
                }
            }
        }

        function resetFilters() {
            // Reset all filter state to defaults
            selectedRatings = [];
            selectedPrices = [];
            filterMainCategory = 'all';
            filterSubcategory = 'all';

            // Reset main category buttons
            document.querySelectorAll('#filterMainCategories .filter-category-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.category === 'all') btn.classList.add('active');
            });

            // Hide subcategories
            const subSection = document.getElementById('filterSubcategorySection');
            if (subSection) subSection.style.display = 'none';

            // Reset all chips
            document.querySelectorAll('.category-chip').forEach(chip => chip.classList.remove('active'));
            document.querySelectorAll('.rating-chip').forEach(chip => chip.classList.remove('active'));
            document.querySelectorAll('.price-chip').forEach(chip => chip.classList.remove('active'));

            // INSTANT FILTER - Apply immediately (show all)
            applyFilterAndUpdateMap();

            // Update count
            updateFilterCount(restaurants.length, restaurants.length);
        }

        // Called when user clicks "Show Results" button in filter modal
        function applyFilters() {
            applyFilterAndUpdateMap();
            closeFilterModal();
        }

        function updateFilterCount(shown, total) {
            // Update any UI showing filter results count
            const countEl = document.getElementById('filterResultCount');
            if (countEl) {
                countEl.textContent = `Showing ${shown} of ${total}`;
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('filterModal');
            if (e.target === modal) {
                closeFilterModal();
            }
        });

        // Helper function to save restaurants to localStorage AND Firestore
        function saveRestaurants() {
            localStorage.setItem('restaurants', JSON.stringify(restaurants));
            // Sync all to Firestore
            if (typeof saveRestaurantsToFirestore === 'function') {
                saveRestaurantsToFirestore(restaurants);
            }
        }

        function saveRestaurant(e) {
            if (e) e.preventDefault();
            
            const nameValue = document.getElementById('name').value;
            const cuisineValue = document.getElementById('cuisine').value;
            const priceValue = document.getElementById('price').value;
            
            if (!nameValue || !nameValue.trim()) {
                alert('Please enter a restaurant name');
                return;
            }
            
            try {
                const restaurantPhotoData = document.getElementById('restaurantPhotoData').value;
                
                const restaurant = {
                    id: Date.now(),
                    name: nameValue.trim(),
                    cuisine: cuisineValue,
                    price: parseInt(priceValue),
                    lat: parseFloat(document.getElementById('lat').value) || 43.2964,
                    lng: parseFloat(document.getElementById('lng').value) || 17.0175,
                    foodRating: 0,
                    serviceRating: 0,
                    visitDate: new Date().toISOString().split('T')[0],
                    notes: '',
                    foodItems: [],
                    photos: [],
                    coverPhoto: restaurantPhotoData || null
                };
                
                restaurants.push(restaurant);

                try {
                    localStorage.setItem('restaurants', JSON.stringify(restaurants));
                    // Sync to Firestore
                    saveRestaurantToFirestore(restaurant);
                } catch (storageError) {
                    alert('Storage is full! Try deleting some old restaurants or photos first.');
                    restaurants.pop();
                    return;
                }

                loadMarkers();
                populateSidebar();
                closeAddRestaurantModal();
                resetRestaurantPhotoForm();
                
            } catch (error) {
                alert('Error saving restaurant: ' + error.message);
            }
        }

        document.getElementById('restaurantForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveRestaurant(e);
        });

        function saveFoodItem(e) {
            if (e) e.preventDefault();
            
            const restaurantId = parseInt(document.getElementById('foodRestaurant').value);
            const category = document.getElementById('foodCategory').value;
            const subcategory = document.getElementById('foodSubcategory').value;
            const dishName = document.getElementById('dishName').value.trim();
            const foodRating = parseInt(document.getElementById('foodRating').value) || 0;
            const visitDate = document.getElementById('visitDate').value;
            
            // Validation
            if (!restaurantId) {
                alert('Please select a restaurant');
                return;
            }
            if (!category) {
                alert('Please select a category');
                return;
            }
            if (!dishName) {
                alert('Please enter a dish name');
                return;
            }
            if (foodRating === 0) {
                alert('Please give a food rating');
                return;
            }
            if (!visitDate) {
                alert('Please select a visit date');
                return;
            }
            
            const restaurant = restaurants.find(r => r.id === restaurantId);
            if (!restaurant) {
                alert('Restaurant not found');
                return;
            }
            
            try {
                const foodPhotoData = document.getElementById('foodPhotoData').value;
                
                const foodItem = {
                    id: Date.now(),
                    name: dishName,
                    category: category,
                    subcategory: subcategory,
                    price: document.getElementById('dishPrice').value,
                    foodRating: foodRating,
                    serviceRating: parseInt(document.getElementById('serviceRating').value) || 0,
                    visitDate: visitDate,
                    notes: document.getElementById('foodNotes').value,
                    photo: foodPhotoData || null
                };
                
                if (!restaurant.foodItems) {
                    restaurant.foodItems = [];
                }
                restaurant.foodItems.push(foodItem);
                
                if (foodPhotoData) {
                    if (!restaurant.photos) {
                        restaurant.photos = [];
                    }
                    restaurant.photos.push({
                        url: foodPhotoData,
                        rating: foodItem.foodRating,
                        category: category,
                        subcategory: subcategory,
                        dishName: foodItem.name,
                        caption: foodItem.notes,
                        date: foodItem.visitDate
                    });
                }
                
                const allRatings = restaurant.foodItems.filter(f => f.foodRating > 0);
                if (allRatings.length > 0) {
                    restaurant.foodRating = Math.round(allRatings.reduce((sum, f) => sum + f.foodRating, 0) / allRatings.length);
                    restaurant.serviceRating = Math.round(allRatings.reduce((sum, f) => sum + f.serviceRating, 0) / allRatings.length);
                }
                restaurant.visitDate = foodItem.visitDate;
                
                localStorage.setItem('restaurants', JSON.stringify(restaurants));
                
                loadMarkers();
                populateSidebar();
                closeAddFoodModal();
                
            } catch (error) {
                alert('Error saving food item: ' + error.message);
            }
        }

        document.getElementById('foodForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveFoodItem(e);
        });

        // Food item photo functions
        function triggerFoodCamera() {
            document.getElementById('foodCameraInput').click();
        }

        function triggerFoodGallery() {
            document.getElementById('foodGalleryInput').click();
        }

        function handleFoodPhotoSelect(event) {
            try {
                const file = event.target.files && event.target.files[0];
                if (!file) {
                    event.target.value = '';
                    return;
                }

                // Check file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('Photo is too large. Please select an image under 5MB.');
                    event.target.value = '';
                    return;
                }

                // Check file type
                if (!file.type || !file.type.startsWith('image/')) {
                    alert('Please select an image file.');
                    event.target.value = '';
                    return;
                }

                const reader = new FileReader();
                
                reader.onerror = function() {
                    alert('Error reading photo. Please try again.');
                    event.target.value = '';
                };
                
                reader.onload = function(e) {
                    try {
                        // Compress and show preview
                        compressImage(e.target.result, 800, 0.8, function(compressedImage) {
                            showFoodPhotoPreview(compressedImage);
                        });
                    } catch (err) {
                        alert('Error processing photo. Please try again.');
                    }
                };
                reader.readAsDataURL(file);
                
                // Reset the input
                event.target.value = '';
            } catch (err) {
                alert('Error with photo. Please try again.');
                if (event.target) event.target.value = '';
            }
        }

        function showFoodPhotoPreview(imageData) {
            const previewContainer = document.getElementById('foodPhotoPreview');
            const photoDataInput = document.getElementById('foodPhotoData');
            const removeBtn = document.getElementById('removeFoodPhotoBtn');

            previewContainer.innerHTML = `<img src="${imageData}" alt="Food photo preview">`;
            photoDataInput.value = imageData;
            removeBtn.style.display = 'flex';
        }

        function removeFoodPhoto() {
            const previewContainer = document.getElementById('foodPhotoPreview');
            const photoDataInput = document.getElementById('foodPhotoData');
            const removeBtn = document.getElementById('removeFoodPhotoBtn');

            previewContainer.innerHTML = `
                <div class="food-photo-empty">
                    <span>üì∑</span>
                    <span>No photo added</span>
                </div>
            `;
            photoDataInput.value = '';
            removeBtn.style.display = 'none';
        }

        function resetFoodPhotoForm() {
            removeFoodPhoto();
            document.getElementById('foodCameraInput').value = '';
            document.getElementById('foodGalleryInput').value = '';
        }

        function viewRestaurant(id) {
            // Use the same view that includes dishes and photos
            viewRestaurantWithDishes(id);
        }

        function deleteRestaurant(id) {
            // Create custom confirm dialog
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:10000;display:flex;align-items:center;justify-content:center;';
            
            const dialog = document.createElement('div');
            dialog.style.cssText = 'background:white;padding:24px;border-radius:16px;max-width:300px;text-align:center;';
            dialog.innerHTML = `
                <h3 style="margin-bottom:16px;color:#2d3436;">Delete Restaurant?</h3>
                <p style="margin-bottom:20px;color:#636e72;">This action cannot be undone.</p>
                <div style="display:flex;gap:12px;justify-content:center;">
                    <button id="cancelDeleteBtn" style="padding:10px 24px;border:2px solid #e9ecef;background:white;border-radius:8px;font-weight:600;cursor:pointer;">Cancel</button>
                    <button id="confirmDeleteBtn" style="padding:10px 24px;border:none;background:#ff6b6b;color:white;border-radius:8px;font-weight:600;cursor:pointer;">Delete</button>
                </div>
            `;
            
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
            
            document.getElementById('cancelDeleteBtn').onclick = function() {
                document.body.removeChild(overlay);
            };
            
            document.getElementById('confirmDeleteBtn').onclick = async function() {
                try {
                    restaurants = restaurants.filter(r => r.id !== id);
                    localStorage.setItem('restaurants', JSON.stringify(restaurants));
                    // Delete from Firestore
                    deleteRestaurantFromFirestore(id);
                    document.body.removeChild(overlay);
                    closeViewModal();
                    loadMarkers();
                    populateSidebar();
                } catch (error) {
                    alert('Error deleting restaurant');
                    document.body.removeChild(overlay);
                }
            };
            
            overlay.onclick = function(e) {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                }
            };
        }

        // Photo handling functions
        // Photo handling variables
        let pendingPhotoData = null;
        let pendingPhotoRestaurantId = null;
        let currentPhotoRating = 0;

        // Cover photo change functions
        function changeCoverPhotoCamera(restaurantId) {
            const input = document.getElementById(`coverPhotoCameraInput-${restaurantId}`);
            if (input) {
                input.click();
            }
        }

        function changeCoverPhotoGallery(restaurantId) {
            const input = document.getElementById(`coverPhotoGalleryInput-${restaurantId}`);
            if (input) {
                input.click();
            }
        }

        function handleCoverPhotoChange(event, restaurantId) {
            try {
                const file = event.target.files && event.target.files[0];
                if (!file) {
                    event.target.value = '';
                    return;
                }

                // Check file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('Photo is too large. Please select an image under 5MB.');
                    event.target.value = '';
                    return;
                }

                // Check file type
                if (!file.type || !file.type.startsWith('image/')) {
                    alert('Please select an image file.');
                    event.target.value = '';
                    return;
                }

                const reader = new FileReader();
                
                reader.onerror = function() {
                    alert('Error reading photo. Please try again.');
                    event.target.value = '';
                };
                
                reader.onload = function(e) {
                    try {
                        // Compress and save
                        compressImage(e.target.result, 800, 0.8, function(compressedImage) {
                            const restaurant = restaurants.find(r => r.id === restaurantId);
                            if (!restaurant) return;

                            // Update cover photo
                            restaurant.coverPhoto = compressedImage;
                            localStorage.setItem('restaurants', JSON.stringify(restaurants));

                            // Refresh the view
                            viewRestaurantWithDishes(restaurantId);
                            
                            // Also update markers to show new photo in list
                            loadMarkers();
                            populateSidebar();
                        });
                    } catch (err) {
                        alert('Error processing photo. Please try again.');
                    }
                };
                reader.readAsDataURL(file);

                // Reset the input
                event.target.value = '';
            } catch (err) {
                alert('Error with photo. Please try again.');
                if (event.target) event.target.value = '';
            }
        }

        function triggerCameraCapture(restaurantId) {
            const input = document.getElementById(`cameraCapture-${restaurantId}`);
            if (input) {
                input.click();
            }
        }

        function triggerGalleryUpload(restaurantId) {
            const input = document.getElementById(`galleryUpload-${restaurantId}`);
            if (input) {
                input.click();
            }
        }

        function handlePhotoCapture(event, restaurantId) {
            try {
                const file = event.target.files && event.target.files[0];
                if (!file) {
                    event.target.value = '';
                    return;
                }

                // Check file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('Photo is too large. Please select an image under 5MB.');
                    event.target.value = '';
                    return;
                }

                // Check file type
                if (!file.type || !file.type.startsWith('image/')) {
                    alert('Please select an image file.');
                    event.target.value = '';
                    return;
                }

                const reader = new FileReader();
                
                reader.onerror = function() {
                    alert('Error reading photo. Please try again.');
                    event.target.value = '';
                };
                
                reader.onload = function(e) {
                    try {
                        // Show crop modal first before compression
                        showPhotoCropModal(e.target.result, restaurantId);
                    } catch (err) {
                        alert('Error processing photo. Please try again.');
                    }
                };
                reader.readAsDataURL(file);
                
                // Reset the input so the same file can be selected again
                event.target.value = '';
            } catch (err) {
                alert('Error capturing photo. Please try again.');
                if (event.target) event.target.value = '';
            }
        }

        // Photo crop modal state
        let cropImageScale = 1;
        let cropImageX = 0;
        let cropImageY = 0;
        let cropStartX = 0;
        let cropStartY = 0;
        let cropIsDragging = false;
        let cropOriginalImage = null;
        let cropRestaurantId = null;

        function showPhotoCropModal(imageUrl, restaurantId) {
            // Debug: confirm function is called
            console.log('showPhotoCropModal called', restaurantId);
            
            cropOriginalImage = imageUrl;
            cropRestaurantId = restaurantId;
            cropImageScale = 1;
            cropImageX = 0;
            cropImageY = 0;

            // Create modal if it doesn't exist
            let modal = document.getElementById('photoCropModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'photoCropModal';
                modal.className = 'photo-crop-modal';
                document.body.appendChild(modal);
            }

            modal.innerHTML = `
                <div class="photo-crop-header">
                    <span class="photo-crop-title">Adjust Photo</span>
                    <button class="photo-crop-close" onclick="closePhotoCropModal()">√ó</button>
                </div>
                
                <div class="photo-crop-container" id="cropContainer"
                     ontouchstart="handleCropTouchStart(event)"
                     ontouchmove="handleCropTouchMove(event)"
                     ontouchend="handleCropTouchEnd(event)"
                     onmousedown="handleCropMouseDown(event)"
                     onmousemove="handleCropMouseMove(event)"
                     onmouseup="handleCropMouseUp(event)"
                     onmouseleave="handleCropMouseUp(event)">
                    <img class="photo-crop-image" id="cropImage" src="${imageUrl}" alt="Crop preview" draggable="false">
                    <div class="photo-crop-frame">
                        <div class="photo-crop-grid-v1"></div>
                        <div class="photo-crop-grid-v2"></div>
                    </div>
                </div>
                
                <div class="photo-crop-hint">Drag to position ‚Ä¢ Pinch or use buttons to zoom</div>
                
                <div class="photo-crop-controls">
                    <div class="photo-crop-zoom">
                        <button class="photo-crop-zoom-btn" onclick="cropZoom(-0.2)">‚àí</button>
                        <span class="photo-crop-zoom-label" id="cropZoomLabel">100%</span>
                        <button class="photo-crop-zoom-btn" onclick="cropZoom(0.2)">+</button>
                    </div>
                </div>
                
                <div class="photo-crop-footer">
                    <button class="photo-crop-btn cancel" onclick="closePhotoCropModal()">Cancel</button>
                    <button class="photo-crop-btn confirm" onclick="confirmPhotoCrop()">Use Photo</button>
                </div>
            `;

            modal.classList.add('open');
            
            // Initialize transform
            setTimeout(updateCropTransform, 50);
        }

        // Touch handlers
        let lastTouchDist = 0;
        let pinchStartScale = 1;

        function handleCropTouchStart(e) {
            e.preventDefault();
            if (e.touches.length === 1) {
                cropIsDragging = true;
                cropStartX = e.touches[0].clientX - cropImageX;
                cropStartY = e.touches[0].clientY - cropImageY;
            } else if (e.touches.length === 2) {
                cropIsDragging = false;
                lastTouchDist = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX,
                    e.touches[0].clientY - e.touches[1].clientY
                );
                pinchStartScale = cropImageScale;
            }
        }

        function handleCropTouchMove(e) {
            e.preventDefault();
            if (e.touches.length === 1 && cropIsDragging) {
                cropImageX = e.touches[0].clientX - cropStartX;
                cropImageY = e.touches[0].clientY - cropStartY;
                updateCropTransform();
            } else if (e.touches.length === 2) {
                const dist = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX,
                    e.touches[0].clientY - e.touches[1].clientY
                );
                cropImageScale = Math.max(0.5, Math.min(3, pinchStartScale * (dist / lastTouchDist)));
                document.getElementById('cropZoomLabel').textContent = Math.round(cropImageScale * 100) + '%';
                updateCropTransform();
            }
        }

        function handleCropTouchEnd(e) {
            cropIsDragging = false;
        }

        // Mouse handlers
        function handleCropMouseDown(e) {
            e.preventDefault();
            cropIsDragging = true;
            cropStartX = e.clientX - cropImageX;
            cropStartY = e.clientY - cropImageY;
        }

        function handleCropMouseMove(e) {
            if (!cropIsDragging) return;
            e.preventDefault();
            cropImageX = e.clientX - cropStartX;
            cropImageY = e.clientY - cropStartY;
            updateCropTransform();
        }

        function handleCropMouseUp(e) {
            cropIsDragging = false;
        }

        function setupCropEvents() {
            // Now using inline handlers
        }

        function cropZoom(delta) {
            cropImageScale = Math.max(0.5, Math.min(3, cropImageScale + delta));
            document.getElementById('cropZoomLabel').textContent = Math.round(cropImageScale * 100) + '%';
            updateCropTransform();
        }

        function updateCropTransform() {
            const img = document.getElementById('cropImage');
            if (img) {
                img.style.transform = `translate(${cropImageX}px, ${cropImageY}px) scale(${cropImageScale})`;
            }
        }

        function closePhotoCropModal() {
            const modal = document.getElementById('photoCropModal');
            if (modal) {
                modal.classList.remove('open');
            }
            cropOriginalImage = null;
            cropRestaurantId = null;
        }

        function confirmPhotoCrop() {
            // Create cropped image from canvas
            const img = document.getElementById('cropImage');
            const frame = document.querySelector('.photo-crop-frame');
            const container = document.getElementById('cropContainer');
            
            if (!img || !frame || !container) {
                closePhotoCropModal();
                return;
            }

            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Get frame dimensions and position
                const frameRect = frame.getBoundingClientRect();
                const containerRect = container.getBoundingClientRect();
                const imgRect = img.getBoundingClientRect();
                
                // Calculate what part of the image is in the frame
                const scaleX = img.naturalWidth / imgRect.width;
                const scaleY = img.naturalHeight / imgRect.height;
                
                const cropX = (frameRect.left - imgRect.left) * scaleX;
                const cropY = (frameRect.top - imgRect.top) * scaleY;
                const cropWidth = frameRect.width * scaleX;
                const cropHeight = frameRect.height * scaleY;
                
                // Set canvas size (square output)
                canvas.width = 800;
                canvas.height = 800;
                
                // Draw cropped portion
                ctx.drawImage(
                    img,
                    Math.max(0, cropX),
                    Math.max(0, cropY),
                    cropWidth,
                    cropHeight,
                    0,
                    0,
                    800,
                    800
                );
                
                const croppedImage = canvas.toDataURL('image/jpeg', 0.85);
                
                // Close crop modal and show rating modal
                closePhotoCropModal();
                
                pendingPhotoData = croppedImage;
                pendingPhotoRestaurantId = cropRestaurantId;
                currentPhotoRating = 0;
                showPhotoRatingModal(croppedImage);
                
            } catch (err) {
                // If cropping fails, use original image
                closePhotoCropModal();
                compressImage(cropOriginalImage, 800, 0.8, function(compressedImage) {
                    pendingPhotoData = compressedImage;
                    pendingPhotoRestaurantId = cropRestaurantId;
                    currentPhotoRating = 0;
                    showPhotoRatingModal(compressedImage);
                });
            }
        }

        function showPhotoRatingModal(imageUrl) {
            // Create modal if it doesn't exist
            let modal = document.getElementById('photoRateModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'photoRateModal';
                modal.className = 'photo-rate-modal';
                document.body.appendChild(modal);
            }
            
            // Build category options
            const categories = getAllCategories();
            const categoryOptions = categories.map(cat => 
                `<option value="${cat.id}">${cat.emoji} ${cat.name}</option>`
            ).join('');
            
            modal.innerHTML = `
                <div class="photo-rate-content">
                    <img class="photo-rate-preview" id="photoRatePreview" src="${imageUrl}" alt="Preview">
                    <div class="photo-rate-body">
                        <h3 class="photo-rate-title">Rate this item</h3>
                        
                        <div class="photo-rate-field">
                            <label class="photo-rate-label">What is this? üìÇ</label>
                            <select class="photo-rate-input" id="photoCategory" onchange="updatePhotoSubcategories()">
                                <option value="">Select category...</option>
                                ${categoryOptions}
                            </select>
                        </div>
                        
                        <div class="photo-rate-field" id="photoSubcategoryField" style="display: none;">
                            <label class="photo-rate-label">Type üìÅ</label>
                            <select class="photo-rate-input" id="photoSubcategory">
                                <option value="">Select type...</option>
                            </select>
                        </div>
                        
                        <div class="photo-rate-field">
                            <label class="photo-rate-label">How was it? ‚≠ê</label>
                            <div class="photo-rate-stars" id="photoRateStars">
                                <span class="photo-rate-star" data-rating="1" onclick="setPhotoRating(1)">‚òÜ</span>
                                <span class="photo-rate-star" data-rating="2" onclick="setPhotoRating(2)">‚òÜ</span>
                                <span class="photo-rate-star" data-rating="3" onclick="setPhotoRating(3)">‚òÜ</span>
                                <span class="photo-rate-star" data-rating="4" onclick="setPhotoRating(4)">‚òÜ</span>
                                <span class="photo-rate-star" data-rating="5" onclick="setPhotoRating(5)">‚òÜ</span>
                            </div>
                        </div>
                        
                        <div class="photo-rate-field">
                            <label class="photo-rate-label">Name</label>
                            <input type="text" class="photo-rate-input" id="photoDishName" placeholder="e.g. Grilled Sea Bass, Mojito...">
                        </div>
                        
                        <div class="photo-rate-field">
                            <label class="photo-rate-label">Price (optional)</label>
                            <input type="text" class="photo-rate-input" id="photoPrice" placeholder="e.g. ‚Ç¨15">
                        </div>
                        
                        <div class="photo-rate-field">
                            <label class="photo-rate-label">Notes (optional)</label>
                            <input type="text" class="photo-rate-input" id="photoCaption" placeholder="e.g. Best fish I've ever had!">
                        </div>
                        
                        <div class="photo-rate-buttons">
                            <button class="photo-rate-btn cancel" onclick="closePhotoRatingModal()">Cancel</button>
                            <button class="photo-rate-btn save" onclick="savePhotoWithRating()">Save</button>
                        </div>
                    </div>
                </div>
            `;

            currentPhotoRating = 0;
            modal.classList.add('open');
        }
        
        function updatePhotoSubcategories() {
            const categoryId = document.getElementById('photoCategory').value;
            const subcategoryField = document.getElementById('photoSubcategoryField');
            const subcategorySelect = document.getElementById('photoSubcategory');
            
            if (!categoryId) {
                subcategoryField.style.display = 'none';
                return;
            }
            
            // Get subcategories for this category
            const subs = filterSubcategories[categoryId] || [];
            const customSubs = customSubcategories.filter(s => s.categoryId === categoryId);
            const allSubs = [...subs.filter(s => s.id !== 'all'), ...customSubs];
            
            if (allSubs.length === 0) {
                subcategoryField.style.display = 'none';
                return;
            }
            
            subcategorySelect.innerHTML = '<option value="">Select type...</option>' +
                allSubs.map(sub => `<option value="${sub.id}">${sub.label}</option>`).join('');
            subcategoryField.style.display = 'block';
        }

        function setPhotoRating(rating) {
            currentPhotoRating = rating;
            updateStarDisplay();
        }

        function updateStarDisplay() {
            const stars = document.querySelectorAll('#photoRateStars .photo-rate-star');
            stars.forEach((star, index) => {
                if (index < currentPhotoRating) {
                    star.textContent = '‚òÖ';
                    star.classList.add('active');
                } else {
                    star.textContent = '‚òÜ';
                    star.classList.remove('active');
                }
            });
        }

        function closePhotoRatingModal() {
            const modal = document.getElementById('photoRateModal');
            if (modal) {
                modal.classList.remove('open');
            }
            pendingPhotoData = null;
            pendingPhotoRestaurantId = null;
            currentPhotoRating = 0;
        }

        function savePhotoWithRating() {
            const categoryId = document.getElementById('photoCategory').value;
            const dishName = document.getElementById('photoDishName').value.trim();
            
            if (!categoryId) {
                alert('Please select a category');
                return;
            }
            if (!dishName) {
                alert('Please enter a name');
                return;
            }
            if (currentPhotoRating === 0) {
                alert('Please give a rating');
                return;
            }
            
            if (!pendingPhotoData || !pendingPhotoRestaurantId) {
                alert('Error: No photo data');
                return;
            }

            const restaurant = restaurants.find(r => r.id === pendingPhotoRestaurantId);
            if (!restaurant) {
                alert('Error: Restaurant not found');
                return;
            }

            // Initialize photos array if not exists
            if (!restaurant.photos) {
                restaurant.photos = [];
            }

            // Create photo object with metadata
            const photoObject = {
                url: pendingPhotoData,
                rating: currentPhotoRating,
                category: categoryId,
                subcategory: document.getElementById('photoSubcategory')?.value || '',
                dishName: dishName,
                price: document.getElementById('photoPrice').value.trim(),
                caption: document.getElementById('photoCaption').value.trim(),
                date: new Date().toISOString()
            };

            restaurant.photos.push(photoObject);

            try {
                localStorage.setItem('restaurants', JSON.stringify(restaurants));
                // Sync to Firestore
                saveRestaurantToFirestore(restaurant);
            } catch (e) {
                alert('Storage full! Try deleting some photos first.');
                restaurant.photos.pop();
                return;
            }

            // Close modal and refresh view
            closePhotoRatingModal();
            viewRestaurantWithDishes(pendingPhotoRestaurantId);
        }

        function compressImage(dataUrl, maxWidth, quality, callback) {
            // Target max size: 500KB (safe for Firestore 1MB limit with other data)
            const MAX_SIZE_BYTES = 500 * 1024;

            try {
                const img = new Image();

                img.onerror = function() {
                    callback(dataUrl);
                };

                img.onload = function() {
                    try {
                        let currentMaxWidth = maxWidth;
                        let currentQuality = quality;

                        function tryCompress() {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;

                            // Calculate new dimensions
                            if (width > currentMaxWidth) {
                                height = Math.round((height * currentMaxWidth) / width);
                                width = currentMaxWidth;
                            }

                            canvas.width = width;
                            canvas.height = height;

                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);

                            // Convert to compressed JPEG
                            const compressedDataUrl = canvas.toDataURL('image/jpeg', currentQuality);

                            // Check size
                            const sizeBytes = Math.round((compressedDataUrl.length * 3) / 4);

                            if (sizeBytes > MAX_SIZE_BYTES && currentQuality > 0.3) {
                                // Still too big - reduce quality and try again
                                currentQuality -= 0.1;
                                currentMaxWidth = Math.round(currentMaxWidth * 0.8);
                                console.log(`Photo too large (${Math.round(sizeBytes/1024)}KB), reducing to ${currentMaxWidth}px @ ${Math.round(currentQuality*100)}%`);
                                tryCompress();
                            } else {
                                console.log(`Photo compressed to ${Math.round(sizeBytes/1024)}KB`);
                                callback(compressedDataUrl);
                            }
                        }

                        tryCompress();
                    } catch (err) {
                        callback(dataUrl);
                    }
                };
                img.src = dataUrl;
            } catch (err) {
                callback(dataUrl);
            }
        }

        function deletePhoto(restaurantId, photoIndex) {
            if (!confirm('Delete this photo?')) return;

            const restaurant = restaurants.find(r => r.id === restaurantId);
            if (!restaurant || !restaurant.photos) return;

            restaurant.photos.splice(photoIndex, 1);
            localStorage.setItem('restaurants', JSON.stringify(restaurants));
            // Sync to Firestore
            saveRestaurantToFirestore(restaurant);

            // Refresh the view
            viewRestaurantWithDishes(restaurantId);
        }

        function openPhotoModalByIndex(restaurantId, photoIndex) {
            const restaurant = restaurants.find(r => r.id === restaurantId);
            if (!restaurant || !restaurant.photos || !restaurant.photos[photoIndex]) return;
            
            const photo = restaurant.photos[photoIndex];
            const photoUrl = typeof photo === 'object' ? photo.url : photo;
            
            // If it's just a URL string, use simple modal
            if (typeof photo !== 'object') {
                openPhotoModal(photoUrl);
                return;
            }
            
            // Show detailed dish modal
            openDishDetailModal(photo, restaurant, photoIndex);
        }
        
        function openDishDetailModal(photo, restaurant, photoIndex) {
            let modal = document.getElementById('dishInfoModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'dishInfoModal';
                modal.className = 'photo-modal';
                document.body.appendChild(modal);
            }
            
            const stars = '‚òÖ'.repeat(photo.rating || 0) + '‚òÜ'.repeat(5 - (photo.rating || 0));
            const category = getAllCategories().find(c => c.id === photo.category);
            const categoryLabel = category ? `${category.emoji} ${category.name}` : '';
            
            modal.innerHTML = `
                <div class="dish-info-modal-content">
                    <button class="photo-modal-close" onclick="closeDishInfoModal()">√ó</button>
                    <img class="dish-info-image" src="${photo.url}" alt="${photo.dishName || 'Dish'}">
                    <div class="dish-info-body">
                        <h2 class="dish-info-name">${photo.dishName || 'Unnamed'}</h2>
                        <div class="dish-info-rating">
                            <span class="dish-info-stars">${stars}</span>
                            <span class="dish-info-rating-num">${photo.rating || 0}/5</span>
                        </div>
                        ${categoryLabel ? `<div class="dish-info-category">${categoryLabel}${photo.subcategory ? ' ‚Ä¢ ' + photo.subcategory : ''}</div>` : ''}
                        ${photo.price ? `<div class="dish-info-price">${photo.price}</div>` : ''}
                        <div class="dish-info-restaurant">üìç ${restaurant.name}</div>
                        ${photo.caption ? `<div class="dish-info-notes">"${photo.caption}"</div>` : ''}
                        ${photo.date ? `<div class="dish-info-date">üìÖ ${new Date(photo.date).toLocaleDateString()}</div>` : ''}
                        <button class="dish-info-delete-btn" onclick="deletePhotoFromModal(${restaurant.id}, ${photoIndex})">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `;
            
            modal.classList.add('open');
        }
        
        function closeDishInfoModal() {
            const modal = document.getElementById('dishInfoModal');
            if (modal) {
                modal.classList.remove('open');
            }
        }
        
        function deletePhotoFromModal(restaurantId, photoIndex) {
            if (!confirm('Delete this item?')) return;

            const restaurant = restaurants.find(r => r.id === restaurantId);
            if (!restaurant || !restaurant.photos) return;

            restaurant.photos.splice(photoIndex, 1);
            localStorage.setItem('restaurants', JSON.stringify(restaurants));
            // Sync to Firestore
            saveRestaurantToFirestore(restaurant);

            closeDishInfoModal();
            viewRestaurantWithDishes(restaurantId);
        }

        function openPhotoModal(photoUrl) {
            // Create modal if it doesn't exist
            let modal = document.getElementById('photoViewModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'photoViewModal';
                modal.className = 'photo-modal';
                modal.innerHTML = `
                    <button class="photo-modal-close" onclick="closePhotoModal()">√ó</button>
                    <img class="photo-modal-content" id="photoModalImage" src="" alt="Food photo">
                `;
                document.body.appendChild(modal);
            }

            document.getElementById('photoModalImage').src = photoUrl;
            modal.classList.add('open');
        }

        function closePhotoModal() {
            const modal = document.getElementById('photoViewModal');
            if (modal) {
                modal.classList.remove('open');
            }
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
            if (event.target.id === 'dishDetailModal') {
                event.target.style.display = 'none';
            }
            if (event.target.id === 'photoViewModal') {
                closePhotoModal();
            }
            if (event.target.id === 'photoRateModal') {
                closePhotoRatingModal();
            }
            if (event.target.id === 'dishInfoModal') {
                closeDishInfoModal();
            }
        }

        // Settings data - stored in localStorage
        let customCategories = JSON.parse(localStorage.getItem('customCategories')) || [];
        let customSubcategories = JSON.parse(localStorage.getItem('customSubcategories')) || [];
        let customPriceRanges = JSON.parse(localStorage.getItem('customPriceRanges')) || [];

        // Default categories for reference
        const defaultCategories = [
            { id: 'restaurant', name: 'Restaurant', emoji: 'üç¥' },
            { id: 'dessert', name: 'Dessert', emoji: 'üç∞' },
            { id: 'icecream', name: 'Ice Cream', emoji: 'üç¶' },
            { id: 'drinks', name: 'Drinks', emoji: 'üçπ' }
        ];

        function getAllCategories() {
            return [...defaultCategories, ...customCategories];
        }

        function populateSettingsLists() {
            populateCategoriesList();
            populateSubcategoriesList();
            populatePriceRangesList();
        }

        function populateCategoriesList() {
            const container = document.getElementById('categoriesList');
            if (!container) return;
            
            const allCategories = getAllCategories();
            
            if (allCategories.length === 0) {
                container.innerHTML = '<div class="settings-empty">No categories added</div>';
                return;
            }
            
            container.innerHTML = allCategories.map((cat, index) => {
                const isDefault = defaultCategories.some(d => d.id === cat.id);
                return `
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <span class="settings-item-emoji">${cat.emoji}</span>
                            <div>
                                <div class="settings-item-name">${cat.name}</div>
                                <div class="settings-item-meta">${isDefault ? 'Default' : 'Custom'}</div>
                            </div>
                        </div>
                        <div class="settings-item-actions">
                            <button class="settings-item-btn delete" onclick="deleteCategory('${cat.id}', ${isDefault})">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function populateSubcategoriesList() {
            const container = document.getElementById('subcategoriesList');
            
            // Get all subcategories from filterSubcategories and custom
            let allSubs = [];
            Object.keys(filterSubcategories).forEach(catId => {
                filterSubcategories[catId].forEach(sub => {
                    if (sub.id !== 'all') {
                        allSubs.push({ ...sub, categoryId: catId, isDefault: true });
                    }
                });
            });
            customSubcategories.forEach(sub => {
                allSubs.push({ ...sub, isDefault: false });
            });
            
            if (allSubs.length === 0) {
                container.innerHTML = '<div class="settings-empty">No subcategories added</div>';
                return;
            }
            
            container.innerHTML = allSubs.map(sub => {
                const category = getAllCategories().find(c => c.id === sub.categoryId);
                return `
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <span class="settings-item-emoji">${sub.label.split(' ')[0]}</span>
                            <div>
                                <div class="settings-item-name">${sub.label.split(' ').slice(1).join(' ') || sub.id}</div>
                                <div class="settings-item-meta">${category ? category.name : sub.categoryId} ‚Ä¢ ${sub.isDefault ? 'Default' : 'Custom'}</div>
                            </div>
                        </div>
                        <div class="settings-item-actions">
                            <button class="settings-item-btn delete" onclick="deleteSubcategory('${sub.id}', '${sub.categoryId}', ${sub.isDefault})">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function populatePriceRangesList() {
            const container = document.getElementById('priceRangesList');
            
            if (customPriceRanges.length === 0) {
                container.innerHTML = '<div class="settings-empty">No custom price ranges added. Using defaults.</div>';
                return;
            }
            
            container.innerHTML = customPriceRanges.map((pr, index) => {
                const targetName = pr.subcategoryId || pr.categoryId;
                return `
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <span class="settings-item-emoji">${pr.label}</span>
                            <div>
                                <div class="settings-item-name">${pr.desc}</div>
                                <div class="settings-item-meta">Level ${pr.level} ‚Ä¢ ${targetName}</div>
                            </div>
                        </div>
                        <div class="settings-item-actions">
                            <button class="settings-item-btn delete" onclick="deletePriceRange(${index})">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Modal functions
        function selectEmoji(inputId, emoji) {
            document.getElementById(inputId).value = emoji;
            
            // Highlight selected emoji
            const picker = document.getElementById(inputId + 'Picker') || 
                           document.getElementById(inputId.replace('Emoji', '') + 'EmojiPicker');
            if (picker) {
                picker.querySelectorAll('span').forEach(span => {
                    span.classList.remove('selected');
                    if (span.textContent === emoji) {
                        span.classList.add('selected');
                    }
                });
            }
        }

        function openAddCategoryModal() {
            document.getElementById('addCategoryModal').style.display = 'block';
            document.getElementById('categoryForm').reset();
            // Clear emoji selection
            document.querySelectorAll('#categoryEmojiPicker span').forEach(s => s.classList.remove('selected'));
        }

        function closeAddCategoryModal() {
            document.getElementById('addCategoryModal').style.display = 'none';
        }

        function openAddSubcategoryModal() {
            document.getElementById('addSubcategoryModal').style.display = 'block';
            document.getElementById('subcategoryForm').reset();
            // Clear emoji selection
            document.querySelectorAll('#subcategoryEmojiPicker span').forEach(s => s.classList.remove('selected'));
            
            // Populate parent category dropdown
            const select = document.getElementById('parentCategory');
            select.innerHTML = '<option value="">Select category...</option>' + 
                getAllCategories().map(cat => `<option value="${cat.id}">${cat.emoji} ${cat.name}</option>`).join('');
        }

        function closeAddSubcategoryModal() {
            document.getElementById('addSubcategoryModal').style.display = 'none';
        }

        function openAddPriceRangeModal() {
            document.getElementById('addPriceRangeModal').style.display = 'block';
            document.getElementById('priceRangeForm').reset();
            document.getElementById('priceRangeCategoryGroup').style.display = 'none';
            document.getElementById('priceRangeSubcategoryGroup').style.display = 'none';
            
            // Populate category dropdown
            const catSelect = document.getElementById('priceRangeCategory');
            catSelect.innerHTML = '<option value="">Select category...</option>' + 
                getAllCategories().map(cat => `<option value="${cat.id}">${cat.emoji} ${cat.name}</option>`).join('');
        }

        function closeAddPriceRangeModal() {
            document.getElementById('addPriceRangeModal').style.display = 'none';
        }

        function updatePriceRangeTargetOptions() {
            const target = document.getElementById('priceRangeTarget').value;
            document.getElementById('priceRangeCategoryGroup').style.display = target ? 'block' : 'none';
            document.getElementById('priceRangeSubcategoryGroup').style.display = target === 'subcategory' ? 'block' : 'none';
            
            if (target === 'subcategory') {
                // Populate subcategory dropdown when category changes
                document.getElementById('priceRangeCategory').onchange = function() {
                    const catId = this.value;
                    const subSelect = document.getElementById('priceRangeSubcategory');
                    const subs = filterSubcategories[catId] || [];
                    const customSubs = customSubcategories.filter(s => s.categoryId === catId);
                    const allSubs = [...subs.filter(s => s.id !== 'all'), ...customSubs];
                    
                    subSelect.innerHTML = '<option value="">Select subcategory...</option>' + 
                        allSubs.map(sub => `<option value="${sub.id}">${sub.label}</option>`).join('');
                };
            }
        }

        // Save functions
        function saveCategory() {
            const name = document.getElementById('categoryName').value.trim();
            const emoji = document.getElementById('categoryEmoji').value.trim();
            
            if (!name || !emoji) {
                alert('Please fill in all fields');
                return;
            }
            
            const id = name.toLowerCase().replace(/\s+/g, '-');
            
            // Check if already exists
            if (getAllCategories().some(c => c.id === id)) {
                alert('Category already exists');
                return;
            }
            
            customCategories.push({ id, name, emoji });
            localStorage.setItem('customCategories', JSON.stringify(customCategories));
            
            closeAddCategoryModal();
            populateCategoriesList();
        }

        function saveSubcategory() {
            const categoryId = document.getElementById('parentCategory').value;
            const name = document.getElementById('subcategoryName').value.trim();
            const emoji = document.getElementById('subcategoryEmoji').value.trim();
            
            if (!categoryId || !name || !emoji) {
                alert('Please fill in all fields');
                return;
            }
            
            const id = name.toLowerCase().replace(/\s+/g, '-');
            
            customSubcategories.push({ 
                id, 
                label: `${emoji} ${name}`,
                categoryId 
            });
            localStorage.setItem('customSubcategories', JSON.stringify(customSubcategories));
            
            // Add to filterSubcategories for immediate use
            if (!filterSubcategories[categoryId]) {
                filterSubcategories[categoryId] = [{ id: 'all', label: 'üçΩÔ∏è All' }];
            }
            filterSubcategories[categoryId].push({ id, label: `${emoji} ${name}` });
            
            closeAddSubcategoryModal();
            populateSubcategoriesList();
        }

        function savePriceRange(e) {
            e.preventDefault();
            
            const target = document.getElementById('priceRangeTarget').value;
            const categoryId = document.getElementById('priceRangeCategory').value;
            const subcategoryId = target === 'subcategory' ? document.getElementById('priceRangeSubcategory').value : null;
            const level = parseInt(document.getElementById('priceRangeLevel').value);
            const label = document.getElementById('priceRangeLabel').value.trim();
            const desc = document.getElementById('priceRangeDesc').value.trim();
            
            if (!categoryId || !label || !desc) {
                alert('Please fill in all fields');
                return;
            }
            
            customPriceRanges.push({
                categoryId,
                subcategoryId,
                level,
                label,
                desc
            });
            localStorage.setItem('customPriceRanges', JSON.stringify(customPriceRanges));
            
            closeAddPriceRangeModal();
            populateSettingsLists();
        }

        // Delete functions
        function deleteCategory(id, isDefault) {
            if (!confirm('Delete this category?')) return;
            
            if (isDefault) {
                // Remove from defaultCategories array
                const idx = defaultCategories.findIndex(c => c.id === id);
                if (idx !== -1) {
                    defaultCategories.splice(idx, 1);
                }
            } else {
                customCategories = customCategories.filter(c => c.id !== id);
                localStorage.setItem('customCategories', JSON.stringify(customCategories));
            }
            populateCategoriesList();
        }

        function deleteSubcategory(id, categoryId, isDefault) {
            if (!confirm('Delete this subcategory?')) return;
            
            if (isDefault) {
                // Remove from filterSubcategories
                if (filterSubcategories[categoryId]) {
                    filterSubcategories[categoryId] = filterSubcategories[categoryId].filter(s => s.id !== id);
                }
            } else {
                customSubcategories = customSubcategories.filter(s => !(s.id === id && s.categoryId === categoryId));
                localStorage.setItem('customSubcategories', JSON.stringify(customSubcategories));
                
                // Remove from filterSubcategories
                if (filterSubcategories[categoryId]) {
                    filterSubcategories[categoryId] = filterSubcategories[categoryId].filter(s => s.id !== id);
                }
            }
            
            populateSubcategoriesList();
        }

        function deletePriceRange(index) {
            if (!confirm('Delete this price range?')) return;
            
            customPriceRanges.splice(index, 1);
            localStorage.setItem('customPriceRanges', JSON.stringify(customPriceRanges));
            populateSettingsLists();
        }

        window.addEventListener('load', function() {
            // Migration: Remove cover photos from photos array (one-time cleanup)
            let needsSave = false;
            restaurants.forEach(restaurant => {
                if (restaurant.coverPhoto && restaurant.photos && restaurant.photos.length > 0) {
                    // Filter out any photo that matches the cover photo
                    const originalLength = restaurant.photos.length;
                    restaurant.photos = restaurant.photos.filter(photo => {
                        const photoUrl = typeof photo === 'object' ? photo.url : photo;
                        return photoUrl !== restaurant.coverPhoto;
                    });
                    if (restaurant.photos.length !== originalLength) {
                        needsSave = true;
                    }
                }
            });
            if (needsSave) {
                localStorage.setItem('restaurants', JSON.stringify(restaurants));
            }
            
            setTimeout(initMap, 100);
            // Show floating add button on home page by default
            const floatingAddBtn = document.getElementById('floatingAddBtn');
            if (floatingAddBtn) floatingAddBtn.classList.add('show');
        });

        // ==================== AUTH & GROUPS FUNCTIONS ====================
        
        // Default group with all restaurant data
        const defaultGroup = {
            id: 'group_darko_jessica',
            name: 'Darko & Jessica',
            description: 'Our Makarska dining adventures',
            photo: null,
            inviteCode: 'DJ2025',
            members: 2,
            places: 0, // Will be calculated
            ratings: 0, // Will be calculated
            createdAt: '2024-01-01T00:00:00.000Z'
        };

        // Initialize groups - only Darko & Jessica group
        function initializeGroups() {
            // Calculate places and ratings from restaurants
            const restaurantCount = restaurants.length;
            let totalRatings = 0;
            restaurants.forEach(r => {
                if (r.foodItems && r.foodItems.length > 0) {
                    totalRatings += r.foodItems.length;
                }
                if (r.foodRating) totalRatings++;
            });
            
            defaultGroup.places = restaurantCount;
            defaultGroup.ratings = totalRatings;
            
            // Only keep Darko & Jessica group - clear any others
            const groups = [defaultGroup];
            localStorage.setItem('userGroups', JSON.stringify(groups));
            
            return groups;
        }

        // Groups data stored in localStorage
        let userGroups = initializeGroups();
        let selectedGroupPhoto = null;
        let currentGroupId = 'group_darko_jessica'; // Default to Darko & Jessica group

        // Handle login - check if user has groups
        function handleLogin() {
            // Reload groups from localStorage
            userGroups = initializeGroups();
            
            if (userGroups.length > 0) {
                // User has groups, go directly to Groups List
                currentGroupId = userGroups[0].id; // Set first group as current
                showGroupsList();
            } else {
                // No groups, show Empty State
                showEmptyState();
            }
        }

        function saveGroups() {
            localStorage.setItem('userGroups', JSON.stringify(userGroups));
            // Sync to Firestore
            if (typeof saveGroupsToFirestore === 'function') {
                saveGroupsToFirestore(userGroups);
            }
        }

        function generateGroupId() {
            return 'group_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function generateInviteCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function hideAllAuthScreens() {
            const loginScreen = document.getElementById('loginScreen');
            loginScreen.classList.add('hidden');
            loginScreen.classList.remove('visible');
            document.getElementById('emptyStateScreen').classList.add('hidden');
            document.getElementById('createGroupScreen').classList.remove('visible');
            document.getElementById('joinGroupScreen').classList.remove('visible');
            document.getElementById('groupsListScreen').classList.remove('visible');
            document.getElementById('mainApp').classList.remove('visible');
        }

        function showEmptyState() {
            hideAllAuthScreens();
            document.getElementById('emptyStateScreen').classList.remove('hidden');
        }

        function showCreateGroup() {
            hideAllAuthScreens();
            // Reset form
            document.getElementById('groupNameInput').value = '';
            document.getElementById('groupDescInput').value = '';
            removePhoto();
            document.getElementById('createGroupScreen').classList.add('visible');
        }

        function showJoinGroup() {
            hideAllAuthScreens();
            document.getElementById('inviteCodeInput').value = '';
            document.getElementById('joinGroupScreen').classList.add('visible');
        }

        function showGroupsList() {
            hideAllAuthScreens();
            renderGroupsList();
            document.getElementById('groupsListScreen').classList.add('visible');
        }

        function showMainApp() {
            hideAllAuthScreens();
            document.getElementById('mainApp').classList.add('visible');
            // Reinitialize map and sync with Firestore
            setTimeout(async () => {
                if (!map) {
                    initMap();
                } else {
                    map.invalidateSize();
                }
                // Sync with Firestore
                await initFirestoreSync();
                loadMarkers();
            }, 100);
        }

        function showLoginScreen() {
            hideAllAuthScreens();
            const loginScreen = document.getElementById('loginScreen');
            loginScreen.classList.remove('hidden');
            loginScreen.classList.add('visible');
            // Reset to login form
            showLoginForm();
        }

        // Go back from Create Group - check if we have groups
        function goBackFromCreate() {
            if (userGroups.length > 0) {
                showGroupsList();
            } else {
                showEmptyState();
            }
        }

        // Go back from Join Group - check if we have groups
        function goBackFromJoin() {
            if (userGroups.length > 0) {
                showGroupsList();
            } else {
                showEmptyState();
            }
        }

        // Photo picker functions
        function pickPhoto() {
            document.getElementById('photoInput').click();
        }

        function takePhoto() {
            document.getElementById('cameraInput').click();
        }

        function handlePhotoSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    selectedGroupPhoto = e.target.result;
                    document.getElementById('photoPreview').src = selectedGroupPhoto;
                    document.getElementById('photoPreviewContainer').style.display = 'block';
                    document.getElementById('photoPicker').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }

        function removePhoto() {
            selectedGroupPhoto = null;
            document.getElementById('photoPreviewContainer').style.display = 'none';
            document.getElementById('photoPicker').style.display = 'flex';
            document.getElementById('photoInput').value = '';
            document.getElementById('cameraInput').value = '';
        }

        // Create group function
        function createGroup() {
            const groupName = document.getElementById('groupNameInput').value.trim();
            if (!groupName) {
                alert('Please enter a group name');
                return;
            }

            const newGroup = {
                id: generateGroupId(),
                name: groupName,
                description: document.getElementById('groupDescInput').value.trim(),
                photo: selectedGroupPhoto,
                inviteCode: generateInviteCode(),
                members: 1,
                places: 0,
                ratings: 0,
                createdAt: new Date().toISOString()
            };

            userGroups.push(newGroup);
            saveGroups();
            
            // Enter the new group
            currentGroupId = newGroup.id;
            showGroupsList();
        }

        // Join group function
        function joinGroup() {
            const inviteCode = document.getElementById('inviteCodeInput').value.trim().toUpperCase();
            if (!inviteCode || inviteCode.length < 6) {
                alert('Please enter a valid 6-digit invite code');
                return;
            }

            // Check if code matches any existing group (for demo, create a placeholder)
            // In real app, this would query Firebase
            const existingGroup = userGroups.find(g => g.inviteCode === inviteCode);
            
            if (existingGroup) {
                alert('You are already a member of this group!');
                showGroupsList();
                return;
            }

            // For demo, create a joined group with this code
            const joinedGroup = {
                id: generateGroupId(),
                name: 'Joined Group',
                description: 'Joined with code ' + inviteCode,
                photo: null,
                inviteCode: inviteCode,
                members: 2,
                places: 0,
                ratings: 0,
                createdAt: new Date().toISOString(),
                joined: true
            };

            userGroups.push(joinedGroup);
            saveGroups();
            showGroupsList();
        }

        // Render groups list
        function renderGroupsList() {
            const container = document.getElementById('groupsListContent');
            const subtitle = document.getElementById('groupsSubtitle');
            
            if (userGroups.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 24px;">
                        <div style="font-size: 64px; margin-bottom: 16px;">üë•</div>
                        <div style="font-size: 18px; font-weight: 600; color: #2d3436; margin-bottom: 8px;">No groups yet</div>
                        <div style="font-size: 14px; color: #636e72;">Create your first group to get started</div>
                    </div>
                `;
                subtitle.textContent = 'No groups yet';
                return;
            }

            subtitle.textContent = userGroups.length + ' group' + (userGroups.length > 1 ? 's' : '');

            const gradients = [
                'linear-gradient(135deg, #ff6b6b 0%, #ff8787 100%)',
                'linear-gradient(135deg, #74b9ff 0%, #0984e3 100%)',
                'linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%)',
                'linear-gradient(135deg, #fdcb6e 0%, #f39c12 100%)',
                'linear-gradient(135deg, #00b894 0%, #00cec9 100%)',
                'linear-gradient(135deg, #fd79a8 0%, #e84393 100%)'
            ];

            container.innerHTML = userGroups.map((group, index) => {
                const avatarStyle = group.photo 
                    ? `background-image: url('${group.photo}'); background-size: cover; background-position: center;`
                    : `background: ${gradients[index % gradients.length]};`;
                
                const avatarContent = group.photo ? '' : 'üçΩÔ∏è';
                
                return `
                    <div class="group-card" onclick="enterGroup('${group.id}')">
                        <div class="group-card-header">
                            <div class="group-avatar" style="${avatarStyle}">${avatarContent}</div>
                            <div class="group-info">
                                <div class="group-name">${group.name}</div>
                                <div class="group-meta">${group.members} member${group.members > 1 ? 's' : ''}</div>
                            </div>
                            <div class="group-arrow">‚Ä∫</div>
                        </div>
                        <div class="group-stats">
                            <div class="group-stat"><span class="group-stat-value">${group.places}</span> places</div>
                            <div class="group-stat"><span class="group-stat-value">${group.ratings}</span> ratings</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Enter a specific group
        function enterGroup(groupId) {
            currentGroupId = groupId;
            const group = userGroups.find(g => g.id === groupId);
            showMainApp();
        }

        // Check if user is already logged in (for demo, always show login)
        // In real app, check Firebase Auth state here

        function resetToDemo() {
            if (confirm('Vill du ladda demo-data med alla restauranger och matr√§tter?')) {
                localStorage.removeItem('restaurants');
                alert('Data √•terst√§lld! Sidan laddas om...');
                window.location.reload(true);
            }
        }

        // Show login screen if not logged in
        setTimeout(function() {
            if (!currentUser) {
                const loginScreen = document.getElementById('loginScreen');
                if (loginScreen) {
                    loginScreen.classList.add('visible');
                }
            }
        }, 100);
    </script>
</body>
</html>
